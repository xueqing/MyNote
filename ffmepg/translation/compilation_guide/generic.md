# 通用编译指南

- [通用编译指南](#通用编译指南)
  - [为什么从源码编译](#为什么从源码编译)
  - [综述](#综述)
  - [安装路径](#安装路径)
  - [环境变量](#环境变量)
    - [LD_LIBRARY_PATH 和 ldconfig](#ld_library_path-和-ldconfig)
  - [配置先决条件和发布包](#配置先决条件和发布包)
  - [安装后排除问题](#安装后排除问题)

翻译[原文](https://trac.ffmpeg.org/wiki/CompilationGuide/Generic)。

此文对于在 Unix 及其衍生版本下的源码包开始编译一个项目提供一些通用的指南。注意，大多数 Linux/Unix 发行版和 MinGW 共享这些基本的原理。

注意，这篇指南没有严格专用于 FFmpeg 的内容。

## 为什么从源码编译

第三方打包程序通常会为许多平台提供二进制程序包，但是在某些情况下，出于一些原因，这些二进制包不是一种选择：

- 二进制包过时，或者包含一些严重的错误，或者缺少后续的软件版本支持的一些必需特性
- 需要定制编译，比如支持特定的的安装布局，以获取特定平台的优化或者链接一些二进制包制表符不支持的特定库
- 想要通过修改源码定制软件

在所有这些情况中，从源码编译似乎是最好的解决方案。

## 综述

大多数源码包的安装遵循以下步骤：

- 配置(使用配置脚本)
- 编译(使用 `make`)
- 安装(使用 `make install`)

配置支持创建一些必要文件，用于后续编译步骤，通过一个配置脚本完成，该脚本通常由源码包提供。在配置阶段，可以定义安装前缀和使能的组件。

编译通常包括配置阶段完成后运行 `make`。在这个阶段生成所需的库和二进制文件。

安装步骤会安装库和二进制文件到配置阶段指定的路径。注意，这个阶段不是必需的，因为你可以使用编译路径下生成的二进制文件。

对于原始版本的编译和安装，通常会运行以下命令：

```sh
./configure
make
make install
```

这些命令会编译源码目录下的项目文件，并安装库到 `/usr/local`。因为 `/usr/local` 不能被普通用户修改，第三个步骤可能需要超级用户权限(因此可能需要替换成 `sudo make install`)。

## 安装路径

一个包包含一些相关的文件，这些文件安装在多个目录。配置阶段通常支持用户指定所谓的安装前缀，且通常通过配置选项 `configure --prefix=PREFIX` 指定，`PREFIX` 通常默认是 `/usr/local`。前缀指定所有这些组件安装的共同目录。

安装步骤通常关联下面的目录：

- `PREFIX/bin`: 包含生成的二进制文件(比如对于 FFmpeg 就是 `ffmpeg`、`ffplay`、`ffprobe` 等)
- `PREFIX/include`: 包含库的头文件(比如对于 FFmpeg 就是 `libavutil/avstring.h`、`libavcodec/avcodec.h`、`libavformat/avformat.h` 等)，是编译应用链接这个库是所需的
- `PREFIX/lib`: 包含生成的库文件(比如对于 FFmpeg 就是 `libavutil`、`libavcodec`、`libavformat` 等)
- `PREFIX/share`: 包含一些系统无关的组件；尤其是文档和示例文件

通过职称前缀可以定义安装布局。

通过共同使用一个类似 `/usr/local` 的前缀，不同的包会安装到相同的目录，因此一般说来，撤销安装会更加困难。

使用类似 `/opt/PROJECT/` 的前缀，项目会安装到一个专用的目录，且如果要从系统移除，可以简单的删除这个 `/opt/PROJECT/` (原文是 `/opt/PREFIX`) 路径。另一方面，这样的安装需要编译所有的环境变量指到自定义路径。

## 环境变量

一些环境定义的变量影响包的安装。一般的，取决于安装前缀，可能需要更新其中的一些变量来确保安装的组件可以被系统工具找到。

环境变量列表可以团购命令 `env` 查看。

一些影响的变量如下：

- `PATH`: 定义了 `:` 分隔的路径列表，系统用于查找二进制文件。比如，如果安装包到 `/usr/local/`，应该更新 `PATH` 使其包含 `/usr/local/bin`。这可以通过类似 `export PATH=/usr/local/bin:$PATH` 的命令实现。
- `LD_LIBRARY_PATH`: 包含 `:` 分隔的路径，系统用于查找库文件。比如，如果安装包到 `/usr/local/`，应该更新 `LD_LIBRARY_PATH` 使其包含 `/usr/local/lib`。这可以通过类似 `export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH` 的命令实现。有时赞成使用 `ldconfig` 而弃用这个变量。
- `CFLAGS`: 包含 C 编译器使用的标记，且通常包含类似 `-IPREFIX/include` 的预处理指令或编译标志。自定义 `CFLAGS` 通常由源码包构建系统添加到源码包的编译标志前缀。或者，许多构建系统支持指定配置选项 `-extra-cflags`。
- `LDFLAGS`: 链接器使用的指令，通常包含类似 `-LPREFIX/lib` 的链接指令，用于查找安装在自定义路径的库。自定义 `LDFLAGS` 通常由源码包构建系统添加到源码包的链接标志前缀。或者，许多构建系统支持指定配置选项 `-extra-ldflags`。
- `PKG_CONFIG_PATH`: 包含 `:` 分隔的路径，`pkg-config` 用于检测 `pkg-config` 文件，许多构建系统使用这些 `pkg-config` 文件检测指定库使用的自定义 `CFLAGS/LDFLAGS`。

万一使用非标准路径安装一个包，需要更新上述环境变量以便系统工具可以检测到安装包的组件。当运行一个包的配置文件，而这个包依赖其他安装的库/头文件/工具时尤其需要。

环境变量通常在配置文件中定义，比如，`sh/bash` 用户的用户目录的 `.profile` 和 `/etc/profile`。可以编辑这个文件以永久设置自定义环境。或者，可以在脚本或者特定的 shell 会话中设置环境变量。

记得导出变量到子进程，比如使用 `export` 命令。阅读 shell 的文档获取更多信息。

### LD_LIBRARY_PATH 和 ldconfig

当链接一个依赖其他库的库时，工具会在一个标准路径(一般是 `/usr/lib`)和系统设置的其他路径列表查找这些库。一些系统依靠 `LD_LIBRARY_PATH` 库。或者，可以使用 `ldconfig` 工具设置全局路径，通过修改系统配置文件 `/etc/ld.so.conf` 文件实现。

注意，在一些系统上，在 shell 配置文件定义的 `LD_LIBRARY_PATH` 变量处于安全原因被重置(查看 <https://bugs.launchpad.net/ubuntu/+source/xorg/+bug/366728>)，因此可能需要设置每个会话或每个脚本的 `LD_LIBRARY_PATH` 变量。

## 配置先决条件和发布包

当配置一个包时，可能需要检查一些所需库和头文件是否存在。许多发行版会为所需的库提供二进制包，因此可能依赖这些包而不是从头开始编译和安装。

通常，对于一个库，需要这个库的包和关联的开发包。库的包只包含库，开发包还包含依赖这个库进行编译的包所需的头文件及其他文件。在基于 Debian 的发行版系统上，开发包包含 `-dev` 后缀；在基于 RedHat 的发行版系统上，开发包包含 `-devel` 后缀。一些发行版(比如 Arch Linux)并未将开发包和标准包分开，标准包也会包含必要的开发文件。

比如在 Debian 上，如果想要配置 FFmpeg 带有 `--enable-libmp3lame`，需要安装 `libmp3lame` 名为 `libmp3lame-dev` 的开发包。

也应确保发行版提供的库版本和配置的源码包所需的版本是兼容的。如果所需包比发行版提供的库版本更新，可能需要从源码安装。

## 安装后排除问题

首先验证二进制文件、头文件和库已经安装到假定的位置(沿着 `PREFIX` 路径)。要验证二进制文件的安装，只需运行一个带有工具名称的命令，并使用带 `which -a` 的命令验证完整路径，该路径会显示系统中可用的给定名称的所有工具。

如果同一软件包有多个安装，必须格外注意避免发生冲突。
