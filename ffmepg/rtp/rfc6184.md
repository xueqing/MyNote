# H.264 视频的 RTP 载荷格式

- [H.264 视频的 RTP 载荷格式](#h264-视频的-rtp-载荷格式)
  - [摘要](#摘要)
  - [1 介绍](#1-介绍)
    - [1.1 H.264 编解码器](#11-h264-编解码器)
    - [1.2 参数集概念](#12-参数集概念)
    - [1.3 网络抽象层单元类型](#13-网络抽象层单元类型)
  - [2 惯例](#2-惯例)
  - [3 范围](#3-范围)
  - [4 定义和缩写](#4-定义和缩写)
    - [4.1 定义](#41-定义)
      - [访问单元](#访问单元)
      - [编码视频序列](#编码视频序列)
      - [IDR 访问单元](#idr-访问单元)
      - [IDR 图片](#idr-图片)
      - [基本编码图像](#基本编码图像)
      - [冗余编码图像](#冗余编码图像)
      - [VCL NAL 单元](#vcl-nal-单元)
      - [解码顺序号](#解码顺序号)
      - [NAL 单元解码顺序](#nal-单元解码顺序)
      - [NALU 时间](#nalu-时间)
      - [传输顺序](#传输顺序)
      - [媒体感知网络元素](#媒体感知网络元素)
      - [静态宏块](#静态宏块)
      - [默认 sub-profile](#默认-sub-profile)
      - [默认 level](#默认-level)
    - [4.2 缩写](#42-缩写)
  - [5 RTP 载荷格式](#5-rtp-载荷格式)
    - [5.1 RTP 头部用法](#51-rtp-头部用法)
    - [5.2 载荷结构](#52-载荷结构)
    - [5.3 NAL 单元头部用法](#53-nal-单元头部用法)
    - [5.4 打包模式](#54-打包模式)
    - [5.5 解码顺序号(DON)](#55-解码顺序号don)
    - [5.6 单 NAL 单元数据包](#56-单-nal-单元数据包)
    - [5.7 聚合包](#57-聚合包)
      - [5.7.1 单时间聚合包(STAP)](#571-单时间聚合包stap)
      - [5.7.2 多时间聚合包(MTAP)](#572-多时间聚合包mtap)
    - [5.8 分片单元(FU)](#58-分片单元fu)
  - [6 打包规则](#6-打包规则)
    - [6.1 通用打包规则](#61-通用打包规则)
    - [6.2 单 NAL 单元模式](#62-单-nal-单元模式)
    - [6.3 非交织模式](#63-非交织模式)
    - [6.4 交织模式](#64-交织模式)
  - [7 解包过程](#7-解包过程)
    - [7.1 单 NAL 单元和非交织模式](#71-单-nal-单元和非交织模式)
    - [7.2 交织模式](#72-交织模式)
      - [7.2.1 解交织缓冲区的大小](#721-解交织缓冲区的大小)
      - [7.2.2 解交织过程](#722-解交织过程)
    - [7.3 附加的解包指南](#73-附加的解包指南)
  - [8 载荷格式参数](#8-载荷格式参数)
    - [8.1 媒体类型注册](#81-媒体类型注册)
      - [profile-level-id](#profile-level-id)
      - [max-recv-level](#max-recv-level)
      - [max-mbps、max-smbps、max-fs、max-cpb、max-dpb、max-br](#max-mbpsmax-smbpsmax-fsmax-cpbmax-dpbmax-br)
      - [max-mbps](#max-mbps)
      - [max-smbps](#max-smbps)
      - [max-fs](#max-fs)
      - [max-cpb](#max-cpb)
      - [max-dpb](#max-dpb)
      - [max-br](#max-br)
      - [redundant-pic-cap](#redundant-pic-cap)
      - [sprop-parameter-sets](#sprop-parameter-sets)
      - [sprop-level-parameter-sets](#sprop-level-parameter-sets)
      - [use-level-src-parameter-sets](#use-level-src-parameter-sets)
      - [in-band-parameter-sets](#in-band-parameter-sets)
      - [level-asymmetry-allowed](#level-asymmetry-allowed)
      - [packetization-mode](#packetization-mode)
      - [sprop-interleaving-depth](#sprop-interleaving-depth)
      - [sprop-deint-buf-req](#sprop-deint-buf-req)
      - [deint-buf-cap](#deint-buf-cap)
      - [sprop-init-buf-time](#sprop-init-buf-time)
      - [sprop-max-don-diff](#sprop-max-don-diff)
      - [max-rcmd-nalu-size](#max-rcmd-nalu-size)
      - [sar-understood](#sar-understood)
      - [sar-supported](#sar-supported)
      - [编码考虑](#编码考虑)
      - [安全考虑](#安全考虑)
      - [公开规范](#公开规范)
      - [附加信息](#附加信息)
      - [文件扩展](#文件扩展)
      - [Macintosh 文件类型代码](#macintosh-文件类型代码)
      - [对象标识符或 OID](#对象标识符或-oid)
      - [获取更多信息要联系的人员和电子邮件地址](#获取更多信息要联系的人员和电子邮件地址)
      - [预期用途](#预期用途)
      - [作者](#作者)
      - [更改控制器](#更改控制器)
    - [8.2 SDP 参数](#82-sdp-参数)
      - [8.2.1 载荷类型参数到 SDP 的映射](#821-载荷类型参数到-sdp-的映射)
      - [8.2.2 与 SDP Offer/Answer 模型一起使用](#822-与-sdp-offeranswer-模型一起使用)
      - [8.2.3 声明性会话描述中使用](#823-声明性会话描述中使用)
    - [8.3 示例](#83-示例)
    - [8.4 参数集考虑](#84-参数集考虑)
    - [8.5 使用带内传输参数集的解码器刷新点程序(信息性)](#85-使用带内传输参数集的解码器刷新点程序信息性)
      - [8.5.1 回复解码器刷新点请求的 IDR 程序](#851-回复解码器刷新点请求的-idr-程序)
      - [8.5.2 回复解码器刷新点请求的逐步恢复程序](#852-回复解码器刷新点请求的逐步恢复程序)
  - [9 安全考虑](#9-安全考虑)
  - [10 拥塞控制](#10-拥塞控制)
  - [11 IANA 考虑](#11-iana-考虑)
  - [12 信息性附录：应用示例](#12-信息性附录应用示例)
    - [12.1 根据 ITU-T H.241 建议附件 A 的视频电话](#121-根据-itu-t-h241-建议附件-a-的视频电话)
    - [12.2 视频电话，无切片数据分区，无 NAL 单元聚合](#122-视频电话无切片数据分区无-nal-单元聚合)
    - [12.3 视频电话，使用 NAL 单元聚合的交织打包](#123-视频电话使用-nal-单元聚合的交织打包)
    - [12.4 带数据分区的视频电话](#124-带数据分区的视频电话)
    - [12.5 带有 FU 和前向纠错的视频电话或流](#125-带有-fu-和前向纠错的视频电话或流)
    - [12.6 低比特率流](#126-低比特率流)
    - [12.7 视频流中的稳健数据包调度](#127-视频流中的稳健数据包调度)
  - [13 信息性附录：解码顺序号的基本原理](#13-信息性附录解码顺序号的基本原理)
    - [13.1 介绍](#131-介绍)
    - [13.2 多图片切片交织示例](#132-多图片切片交织示例)
    - [13.3 稳健包调度示例](#133-稳健包调度示例)
    - [13.4 冗余编码切片的鲁棒传输调度](#134-冗余编码切片的鲁棒传输调度)
    - [13.5 关于其他设计可能性的评论](#135-关于其他设计可能性的评论)
  - [14 来自 RFC 3984 的变化](#14-来自-rfc-3984-的变化)
  - [15 向后兼容 RFC 3984](#15-向后兼容-rfc-3984)
  - [16 致谢](#16-致谢)
  - [17 参考](#17-参考)
    - [17.1 规范性引用文件](#171-规范性引用文件)
    - [17.2 资料性引用](#172-资料性引用)

## 摘要

本文为 ITU-T H.264 建议视频编解码器和技术上相同的 ISO-IEC 14496-10 国际标准视频编解码器描述了 RTP 载荷格式，不包含后者的可伸缩视频编解码(SVC)扩展和多视图视频编码扩展，其 RTP 载荷格式在其他地方定义。RTP 载荷格式支持在每个 RTP 载荷中，对 H.264 视频编码器生成的一个或多个 NALU 封包。载荷格式具有广泛的使用性，因为它支持的应用包括简单的低比特率对话使用到交错传输的互联网视频流，以及高比特率的视频点播等。

本文废除了 [RFC 3984](https://tools.ietf.org/pdf/rfc3984)。[第 14 节](#14-来自-rfc-3984-的变化)总结了 [RFC 3984](https://tools.ietf.org/pdf/rfc3984) 的变更。[第 15 节](#15-向后兼容-rfc-3984) [RFC 3984](https://tools.ietf.org/pdf/rfc3984) 的向后兼容性问题。

## 1 介绍

本文为视频编码标准 ITU-T H.264 建议 [^1] 和 ISO-IEC 14496-10 国际标准 [^2] (也称为高级视频编码, AVC) 指定了 RTP 载荷规范。本文中，H.264 名称用于编解码器和标准，但本文同样适用于编码标准的 ISO/IEC 对应项。

本文废除了 [RFC 3984](https://tools.ietf.org/pdf/rfc3984)。[第 14 节](#14-来自-rfc-3984-的变化)总结了 [RFC 3984](https://tools.ietf.org/pdf/rfc3984) 的变更。[第 15 节](#15-向后兼容-rfc-3984)) 讨论了 [RFC 3984](https://tools.ietf.org/pdf/rfc3984) 的向后兼容性问题。

### 1.1 H.264 编解码器

H.264 视频编解码器具有非常广泛的应用范围，涵盖所有形式的数字压缩视频，从低比特率网络流应用到具有几乎无损编码的 HDTV 广播和数字电影应用。与当前的技术状态相比，H.264 的整体性能据报告可以节省 50% 或更多的比特率。例如，据报道，数字卫星电视质量可达到 1.5 Mbit/s，而 MPEG2 视频的当前操作点约为 3.5 Mbit/s [^10]。

编解码器规范 [^1] 本身从概念上区分视频编码层(Video Coding Layer, VCL)和网络抽象层(Network Abstraction Layer, NAL)。VCL 包含编解码器的信号处理功能，变换、量化和运动补偿预测等机制，以及一个环路滤波器。它遵循当今大多数视频编解码器的一般概念，一种基于宏块的编码器，它使用带有运动补偿的图像间预测和残差信号的变换编码。VCL 编码器输出切片：一个比特串，包含整数个宏块的宏块数据和切片头信息(包含切片中第一个宏块的空间地址、初始量化参数等类似信息)。除非使用切片组的语法指定不同的宏块分配，否则切片中的宏块按扫描顺序排列。图片内预测仅在切片内使用。更多信息参考 [^10]。

NAL 编码器将 VCL 编码器的切片输出封装到网络抽象层单元(NALU)中，这些 NALU 适用于通过分组网络传输或用于面向分组的多路复用环境。H.264 附件 B 定义了一个封装过程，通过面向字节流的网络传输此类 NALU。在本文中，附件 B 不相关。

NAL 内部使用 NAL 单元。NAL 单元包含一个字节的头和载荷字节串。头部指示 NAL 单元的类型、NAL 单元载荷中(潜在)的位错误或语法违规，以及解码过程中有关 NAL 单元的相对重要性信息。该 RTP 载荷规范用于不了解 NAL 单元载荷的位串。

H.264 的一个主要属性是传输时间、解码时间、切片和图片的采样或显示时间完全解耦合。H.264 中指定的解码过程是不了解时间的，且 H.264 语法不携带跳帧数等信息(这在早期的视频压缩标准中以时间参考的形式很常见)。此外，还有影响许多图片的 NAL 单元，因此，它们本质上是没有时间的。出于这个原因，处理 RTP 时间戳需要对 NAL 单元进行一些特殊考虑，这些单元的采样或显式时间未定义，或者传输时间未知。

### 1.2 参数集概念

H.264 一个非常基本的设计概念是生成自包含数据包，从而使诸如 RFC 4629  [^11] 或 MPEG-4 视频的 HEC(头部扩展码) [^12] 变得不必要。这是通过将与多个切片相关的信息从媒体流解耦合实现的。此更高级别元信息应该从包含切片数据包的 RTP 包流中可靠、异步地提前发送。(带内发送此信息的规定也可用于没有适用此目的的带外传输通道的应用程序)。更高级别参数的组合成为参数集。H.264 规范包含两种参数集：sps 和 pps。活动的 sps 在整个编码视频序列中保持不变，且活动的 pps 在编码图片内保持不变。sps 和 pps 结构包含的信息有图片大小、采用的可选编码模式，以及宏块到切片组的映射等。

为了能够改变图片参数(比如图片大小)而不必将参数集更新同步传输到切片数据包流，编码器和解码器可以维护一个包含多个 sps 和 pps 的列表。每个切片头部包含一个代码字，指示要使用的 sps 和 pps。

此机制允许将参数集的传输和数据包流、以及通过外部手段(比如，作为能力交换的副作用)或通过(可靠或不可靠的)控制协议的传输解耦合。甚至有可能从不传输它们，而是通过应用程序设计规范固定。

### 1.3 网络抽象层单元类型

NAL 设计的教程信息可参考 [^13]、[^14] 和 [^15]。

所有 NAL 单元都包含一个 NAL 单元类型 8 位字节，它也共同作为 RTP 载荷格式的载荷头部。NAL 单元的载荷描述如下。

NAL 单元类型 8 位字节的语法和语义在 [^1] 中指定，但是 NAL 单元类型 8 位字节的基本属性概括如下。NAL 单元类型的 8 位字节具有如下格式：

```txt
+---------------+
|0|1|2|3|4|5|6|7|
+-+-+-+-+-+-+-+-+
|F|NRI|   Type  |
+---------------+
```

NAL 单元类型的 8 位字节组件的语义，在 H.264 规范中指定，简要描述如下：

- F: 1 位 forbidden_zero_bit。H.264 规范声明值 1 作为语法违规。
- NRI: 2 位 nal_ref_idc。00 值 表示 NAL 单元的内容不用于重构用于图片间预测的参考图片。可以丢弃此类 NAL 单元，而不会影响参考图片的完整性。大于 00 的值表示需要对 NAL 单元进行解码以保持参考图片的完整性。
- Type: 5 位 nal_unit_type。此组件指定 NAL 单元载荷类型，正如 [^1] 中表 7-1 以及本文后面定义。有关所有当前定义的 NAL 单元类型及其语义的参考，请参阅 [^1] 中的 7.4.1 章节。

本文引入新的 NAL 单元类型，在 [5.2 章节](#52-载荷结构)显示。本文中定义的 NAL 单元类型在 [^1] 中标记为未指定。而且，此规范扩展了 F 和 NRI 的语义，正如 [5.3 章节](#53-nal-单元头部用法)所述。

## 2 惯例

当处理位字段时，此规范使用设置和清除位。设置位等于该位赋值为 1(On)。清除位等于该位赋值为 0(Off)。

## 3 范围

本文中的关键词“必须”、“不得”、“要求”、“应”、“不应”、“建议”、“可”和“可选”应按照 [RFC 2119](https://tools.ietf.org/pdf/rfc2119) [^4] 中所述进行解释。

此载荷规范只能用于通过 RTP 携带“裸”的 H.264 NAL 单元流，而不能用于 H.264 附件 B 中讨论的比特流格式。同样地，此规范的首个应用可能是对话多媒体领域、视频电话或视频会议，但载荷格式也涵盖其他应用，比如互联网媒体流和 IP 电视。

## 4 定义和缩写

### 4.1 定义

本文档使用 [^1] 的定义。下面的术语，在 [^1] 中定义，方便起见进行总结：

#### 访问单元

access unit: 一组 NAL 单元总是包含一个基本编码图像。除了基本编码图像之外，访问单元还可以包含一个或多个冗余编码图像或其他 NAL 单元，这些 NAL 单元不包含编码图片的切片或切片数据分区。解码一个访问单元总是得到一个解码的图片。

#### 编码视频序列

coded video sequence: 访问单元序列，按照解码顺序由瞬时解码刷新(instantaneous decoding refre，IDR) 访问单元和之后的零个或多个非 IDR 访问单元组成，非 IDR 访问单元包含所有后续访问单元，直到但不包含任何后续 IDR 访问单元。

#### IDR 访问单元

IDR access unit: 该访问单元的基本编码图像是一个 IDR 图片。

#### IDR 图片

IDR picture: 该编码图片仅包含 I 或 SI 切片类型的切片，会导致解码过程的“重置”。在对 IDR 图片解码之后，可以按照解码顺序对所有后续编码图片进行解码，而不需要 IDR 图片之前解码的任何图片做帧间预测。

#### 基本编码图像

primary coded picture: 解码符合 H.264 比特流过程中使用的图片的编码表示。基本编码图像包含图片的所有宏块。

#### 冗余编码图像

redundant coded picture: 图片或图片一部分的编码表示。解码符合 H.264 比特流过程中不应使用冗余编码图像的内容。冗余编码图像的内容可用于解码包含错误或丢失的比特流。

#### VCL NAL 单元

VCL NAL unit: 用于指代编码切片和编码数据分区 NAL 单元的统称。

此外，下面的定义也适用：

#### 解码顺序号

decoding order number(DON): 载荷结构中的字段或导出变量，指示 NAL 单元解码顺序。DON 的值在 0 到 65535 的范围内，包括 0 和 65535。达到最大值后，DON 的值回到 0。

#### NAL 单元解码顺序

NAL unit decoding order: 符合 [^1] 中 7.4.1.2 章节中给出的 NAL 单元顺序约束的 NAL 单元顺序。

#### NALU 时间

NALU-time: 如果 NAL 单元将在其自己的 RTP 数据包中传输，则 RTP 时间戳对应 NALU 时间。

#### 传输顺序

transmission order: 按 RTP 序列号(模运算)升序排列的数据包顺序。在聚合数据包内，NAL 单元传输顺序与 NAL 单元在数据包中的出现顺序相同。

#### 媒体感知网络元素

media-aware network element(MANE): 一种网络元素，比如中间盒或应用层网关，能够解析 RTP 载荷头部或 RTP 载荷的某些方面，并对内容作出反应。

信息说明：MANE 的概念超出了普通路由器或网关的范围，因为 MANE 必须了解信令(比如，了解媒体流的载荷类型映射)并在使用安全实时传输协议(Secure Real-time Transport Protocol, SRTP)时必须信任 MANE。使用 MANE 的优点是它们允许根据媒体编码的需要丢弃数据包。例如，如果某个 MANE 由于某条链路拥塞而不得不丢弃数据包，它可以识别并删除那些消除之后对用户体验产生最小不利影响的数据包。

#### 静态宏块

static macroblock: 视频流中一定数量的宏块可定义为静态的，正如 [^3] 中 5.8.3.8 章节定义。静态宏块为处理非静态宏块释放了额外的处理周期。基于给定数量的视频处理资源和给定分辨率，更多数量的静态宏块可以对应支持更高的帧率。

#### 默认 sub-profile

default sub-profile: 编码工具的子集，可以是一个 profile 的所有编码工具，也可以是多个 profile 的公共编码工具子集，由 profile-level-id 参数指示。

#### 默认 level

default level: 由 profile-level-id 参数指示的级别，由 profile_idc、profile-iop、level_idc 三个 8 位字节组成。在大多数情况下，默认 level 由 level_idc 指示，在某些情况下额外由 profile-iop 指示。

### 4.2 缩写

- DON: Decoding Order Number
- DONB: Decoding Order Number Base
- DOND: Decoding Order Number Difference
- FEC: Forward Error Correction
- FU: Fragmentation Unit
- IDR: Instantaneous Decoding Refresh
- IEC: International Electrotechnical Commission
- ISO: International Organization for Standardization
- ITU-T: International Telecommunication Union,
- Telecommunication Standardization Sector
- MANE: Media-Aware Network Element
- MTAP: Multi-Time Aggregation Packet
- MTAP16: MTAP with 16-bit timestamp offset
- MTAP24: MTAP with 24-bit timestamp offset
- NAL: Network Abstraction Layer
- NALU: NAL Unit
- SAR: Sample Aspect Ratio
- SEI: Supplemental Enhancement Information
- STAP: Single-Time Aggregation Packet
- STAP-A: STAP type A
- STAP-B: STAP type B
- TS: Timestamp
- VCL: Video Coding Layer
- VUI: Video Usability Information

## 5 RTP 载荷格式

### 5.1 RTP 头部用法

RTP 头部格式在 [RFC 3550](https://tools.ietf.org/pdf/rfc3550) [^5] 中定义，方便起见在图 1 重新绘制。此载荷格式使用头部字段的方式和该规范一致。

当每个 RTP 包封装一个 NAL 单元时，**建议的** RTP 载荷格式在 [5.6 节](#56-单-nal-单元数据包)指定。对于聚合包和分片单元的RTP 载荷(以及某些 RTP 头部位的设置)分别在 [5.7.2](#572-多时间聚合包mtap) 和 [5.8](#58-分片单元fu) 节中指定。

图 1——根据 [RFC 3550](https://tools.ietf.org/pdf/rfc3550) 的 RTP 头部

```txt
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|V=2|P|X|   CC  |M|     PT      |       sequence number         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                           timestamp                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           synchronization source (SSRC) identifier            |
+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+
|            contributing source (CSRC) identifiers             |
|                           ....                                |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

根据此 RTP 载荷格式设置 RTP 头信息如下：

- 标记位(Marker bit, M): 1 位。对于 RTP 时间戳指示的访问单元的最后一个数据包设置此位，符合视频格式中 M 位的正常使用，以允许有效的处理播放缓冲区。对于聚合数据包(STAP 和 MTAP)，如果是在自己的 RTP 数据包传输，RTP 头部的标记位**必须**设置为聚合数据包最后一个 NAL 单元的标记位的值。解码器可以使用此位作为访问单元最后一个数据包的早期指示，但**不能**依赖此属性。

  信息说明：只有一个 M 位与一个携带多个 NAL 单元的聚合数据包相关联。因此，如果网关将一个聚合数据包重新打包成几个数据包，它就不能可靠地设置这些数据包的 M 位。

- 载荷类型(Payload type, PT): 7 位。为这种新的数据包格式分配 RTP 载荷类型超出本文档的范围，不在此处指定。载荷类型的分配必须通过使用的配置文件或以动态方式执行。
- 序列号(Sequence number, SN): 16 位。根据 [RFC 3550](https://tools.ietf.org/pdf/rfc3550) 设置和使用。对于单个 NALU 和非交织打包模式，序列号用于确定 NALU 的解码顺序。
- 时间戳(Timestamp): 32 位。RTP 时间戳设置为内容的采样时间戳。**必须**使用 90 kHz 的时钟频率。
  
  如果 NAL 单元没有自己的时间属性(比如参数集和 SEI NAL 单元)，则 RTP 时间戳设置为包含 NAL 单元的访问单元的基本编码图像的 RTP 时间戳，根据 [^1] 的 7.4.1.2 章节。

  MTAP 的 RTP 时间戳设置在 [5.7.2 节](#572-多时间聚合包mtap)定义。

  接收者**应该**忽略包含在只有一个显示时间戳的访问单元中的任何图像时序 SEI 消息。相反，接收者**应该**使用 RTP 时间戳同步显示过程。

  如果访问单元在一个图像时序 SEI 消息中携带多个显示时间戳，那么**应该**将 SEI 消息中的信息视为相对 RTP 时间戳，最早事件发生在 RTP 时间戳指定的时间，随后事件发生的更晚，由图像时序 SEI 消息中携带的图片时间差值给出。

  设定 `tSEI1`、`tSEI2`、...、`tSEIn` 为一个访问单元的 SEI 消息中携带的显示时间戳，其中 `tSEI1` 是所有这些时间戳中最早的。`tmadjst()` 函数将 SEI 消息时间刻度调整到 90 kHz。`TS` 是 RTP 时间戳。那么，与 `tSEI1` 关联事件的显示时间为 `TS`。与 `tSEIx` 关联事件的显示时间是 `TS+tmadjst(tSEIx-tSEI1)`，其中 x 属于 `[2...n]`。

    信息说明：在 3:2 pulldown 操作中通常需要将编码帧显示为场，在该操作中，使用隔行扫描将编码帧组成的影片内容显示在显示器上。图像时序 SEI 消息允许同一编码图片携带多个时间戳，因此 3:2 pulldown 过程得到完美控制。图像时序 SEI 消息机制是必要的，因为每个编码帧只能在 RTP 时间戳中传送一个时间戳。

### 5.2 载荷结构

载荷格式定义了三种不同的基本载荷结构。接收者可以通过识别 RTP 包载荷的第一个字节来识别载荷结构，这个字节共同用作 RTP 载荷头部，在某些情况下作为载荷的第一个字节。该字节总是被构造为一个 NAL 单元头。NAL 单元 type 字段指示存在哪种结构。可能的结构如下。

- 单 NAL 单元数据包(Single NAL Unit Packet)：载荷中仅包含单个 NAL 单元。NAL 头部 type 字段等于原始 NAL 单元类型，即在 1 到 23 的范围内，包括 1 和 23。在 [5.6 节](#56-单-nal-单元数据包)指定。
- 聚合数据包(Aggregation Packet)：用于将多个 NAL 单元聚合到单个 RTP 载荷中的数据包类型。该包存在四个版本，单时间聚合数据包类型 A (Single-Time Aggregation Packet type A, STAP-A)、单时间聚合数据包类型 B (Single-Time Aggregation Packet type B, STAP-B)、具有 16 位偏移量(MTAP16)的多时间聚合数据包(Multi-Time Aggregation Packet, MTAP)，以及具有 24 位偏移量(MTAP24) 的多时间聚合数据包(Multi-Time Aggregation Packet, MTAP)。分配给 STAP-A、STAP-B、MTAP16 和 MTAP24 的 NAL 单元类型编号分别为 24、25、26 和 27。在 [5.7 节](#57-聚合包)指定。
- 分片单元(Fragmentation Unit)：用于将单个 NAL 单元分片到多个 RTP 数据包。存在两个版本，FU-A 和 FU-B，分别使用 NAL 单元类型编号 28 和 29 标识。在 [5.8 节](#58-分片单元fu)指定。

信息说明：本规范不限制封装在单 NAL 单元数据包和分片单元中的 NAL 单元的大小。封装在任何聚合包中的 NAL 单元最大为 65535 字节。

表 1 总结了当这些 NAL 单元中的每一个直接用作数据包载荷时的 NAL 单元类型和相应的 RTP 包类型。

表 1——NAL 单元类型和对应包类型的总结

| NAL 单元类型 | 包类型 | 包类型名称 | 章节 |
| --- | --- | --- | --- |
| 0 | 保留 |  | - |
| 1-23 | NAL 单元 | 单 NAL 单元数据包 | 5.6 |
| 24 | STAP-A | 单时间聚合数据包 | 5.7.1 |
| 25 | STAP-B | 单时间聚合数据包 | 5.7.1 |
| 26 | MTAP16 | 多时间聚合数据包 | 5.7.2 |
| 27 | MTAP24 | 多时间聚合数据包 | 5.7.2 |
| 28 | FU-A | 分片单元 | 5.8 |
| 29 | FU-B | 分片单元 | 5.8 |
| 30-31 | 保留 |  | - |

### 5.3 NAL 单元头部用法

NAL 单元头部结构和语义在 [1.3 节](#13-网络抽象层单元类型)介绍。方便起见，在下面再次打印 NAL 单元头部格式：

```txt
+---------------+
|0|1|2|3|4|5|6|7|
+-+-+-+-+-+-+-+-+
|F|NRI|   Type  |
+---------------+
```

本节根据此规范指定 F 和 NRI 的语义。

- F: 1 位 forbidden_zero_bit。0 值表示 NAL 单元类型 8 位字节和载荷不应包含位错误或其他违规语法。值 1 表示 NAL 单元类型 8 位字节和载荷可能包含位错误或其他语法违规。

  MANE **应该**设置 F 位以指示 NAL 单元中检测到的位错误。H.264 规范要求 F 位必须等于 0。当设置了 F 位，则告知解码器在载荷或 NAL 单元类型 8 位字节中可能存在位错误或其他语法违规。对于 F 位等于 1，解码器最简单的处理是丢弃这样的 NAL 单元并隐藏丢弃的 NAL 单元中的丢失数据。

- NRI: 2 位 nal_ref_idc。00 值和非零值的语义和 H.264 规范保持不变。换句话说，00 值表示不使用 NAL 单元的内容重构参考图片用于帧间图片预测。可以丢弃这样的 NAL 单元而不会影响参考图片的完整性。大于 00 的值表示需要解码 NAL 单元以维持参考图片的完整性。

  除了上述规范，根据此 RTP 载荷规范，NRI 的值指示相对传输优先级，由编码器确定。MANE 可使用此信息保护更加重要的 NAL 单元。最高的传输优先级是 11，之后是 10，然后是 01；最后，00 优先级最低。

  信息说明：NRI 的任何非零值在 H.264 解码器中处理相同。因此，接收者将 NAL 单元传递给解码器时，不需要操作 NRI 的值。

当 nal_unit_type 在 1 到 12 范围(包括 1 和 12)内时，H.264 编码器**必须**根据 H.264 规范(7.4.1 小节)设置 NRI 的值。尤其是，H.264 规范要求对于所有 nal_unit_type 值为 6、9、10、11 或 12 的 NAL 单元，**应该**设置 NRI 的值为 0。

对于 nal_unit_type 等于 7 或 8(分别表示 sps 或 pps)的 NAL 单元，H.264 编码器**应该**设置 NRI 为 11(二进制格式)。对于 nal_unit_type 为 5 的基本编码图像(表示编码的切片属于一个 IDR 图片)的编码切片NAL 单元，H.264 编码器**应该**设置 NRI 值为 11(二进制格式)。

对于剩余 nal_unit_type 到 NRI 值的映射，可使用以下示例，并且已经证明在特定环境中 [^14] 是有效的。其他映射也可能是可取的，这取决于应用程序和使用的 H.264 配置文件。

  信息说明：数据分区在某些配置文件中不可用，例如，在主配置文件或基线配置文件中。因此，仅在视频比特流符合允许数据分区的配置文件时才会出现 NAL 单元类型 2、3 和 4，在符合主配置文件或基线配置文件的流中不会出现。

  表 2——基本编码参考图片的编码切片和编码切片数据分区的 NRI 值示例

  | NAL 单元类型 | NAL 单元内容 | NRI(二进制) |
  | --- | --- | --- |
  | 1 | 非 IDR 编码切片| 10 |
  | 2 | 编码切片数据分区 A | 10 |
  | 3 | 编码切片数据分区 B | 01 |
  | 4 | 编码切片数据分区 C | 01 |

  信息说明：正如之前所说，根据 H.264 的规定，非参考图片的 NRI 值 是 00。

对于冗余编码参考图片的编码切片和编码切片数据分区 NAL 单元，H.264 编码器**应该**设置其 NRI 值为 01(二进制格式)。

对于 NAL 单元类型 24 到 29 (包括 24 和 29) 的 NRI 值的定义，在本文 [5.7](#57-聚合包) 和 [5.8](#58-分片单元fu) 节给出。

对于 nal_unit_type 在 13 到 23 (包括 13 和 23)的 NAL 单元，其 NRI 值没有建议，因为这些值是 ITU-T 和 ISO/IEC 保留的。对于 nal_unit_type 为 0 或在 30 到 31(包括 30 和 31)的 NAL 单元，其 NRI 值没有建议，因为这些值的语义在此文中没有指定。

### 5.4 打包模式

本文指定了三种打包模式的情形：

- 单 NAL 单元模式
- 非交织模式
- 交织模式

单 NAL 单元模式针对符合 ITU-T H.241 建议 [^3] (参阅 [12.1 节](#121-根据-itu-t-h241-建议附件-a-的视频电话)) 的会话系统。非交织模式针对可能不符合 ITU-T H.241 建议的会话系统。在非交织模式下，NAL 单元按 NAL 单元解码顺序传输。交织模式针对的系统不要求极低的端到端延迟。交织模式允许不按照 NAL 单元解码顺序传输 NAL 单元。

**可以**由**可选的** packetizatio-mode 媒体类型参数值表示使用的打包模式。使用的打包模式控制 RTP 载荷中允许使用哪些 NAL 单元类型。表 3 总结了每种打包模式允许的数据包载荷类型。[第 6 节](#6-打包规则)给出了打包模式更详细的解释。

表 3——总结每种打包模式允许的 NAL 单元类型(y-允许，n=不允许，ig=忽略)

| 载荷类型 | 包类型 | 单 NAL 单元模式 | 非交织模式 | 交织模式 |
| --- | --- | --- | --- | --- |
| 0 | 保留 | ig | ig | ig |
| 1-23 | NAL 单元 | y | y | n |
| 24 | STAP-A | n | y | n |
| 25 | STAP-B | n | n | y |
| 26 | MTAP16 | n | n | y |
| 27 | MTAP24 | n | n | y |
| 28 | FU-A | n | y | y |
| 29 | FU-B | n | n | y |
| 30-31 | 保留 | ig | ig | ig |

一些 NAL 单元或载荷类型值(表 3 中标记保留的值)被保留用于未来的扩展。发送者**不应该**发送这些类型的 NAL 单元(直接作为数据包载荷，作为聚合包的聚合单元，或者作为 FU 包中的分片单元)，而且接收者**必须**忽略这些 NAL 单元。例如，载荷类型 1-23，关联包类型为“NAL 单元”，在“单 NAL 单元模式”和“非交织模式”中允许，在“交织模式”中不允许。然而，可在“交织模式”中使用 NAL 单元类型 1-23 的 NAL 单元作为 STAP-B、MTAP16 和 MTAP24 包中的聚合单元，以及 FU-A 和 FU-B 中的分片单元。类似的，除了在“非交织模式”中使用 NAL 单元类型 1-23 的 NAL 单元直接作为包载荷，也可作为 STAP-A 包中的聚合单元，或者 FU-A 包中的分片单元。

### 5.5 解码顺序号(DON)

在交织打包模式中，允许 NAL 单元的传输顺序不同于 NAL 单元的解码顺序。解码顺序号(DON)是载荷结构中的一个字段或衍生变量，指示 NAL 单元的解码顺序。[第 13 节](#13-网络抽象层单元类型)给出了不按解码顺序传输和使用 DON 的基本原理和用例示例。

传输和解码顺序的解耦由如下**可选的** sprop-interleaving-depth 媒体类型参数控制。当**可选的** sprop-interleaving-depth 媒体类型参数值为 0(显式或默认的)时，NAL 单元的传输顺序**必须**符合 NAL 单元解码顺序。当**可选的** sprop-interleaving-depth 媒体类型参数值大于 0 时：

- 不要求 MTAP16 和 MTAP24 中 NAL 单元的顺序是 NAL 单元解码顺序
- 通过对两个连续数据包中的 STAP-B、MTAP 和 FU 进行解包生成的 NAL 单元的顺序不要求是 NAL 单元解码顺序

对于一个单 NAL 单元数据包、STAP-A 和 FU-A，其 RTP 载荷结构不包含 DON。STAP-B 和 FU-B 结构包含 DON，且 MTAP 的结构允许 DON 的衍生，正如 [5.7.2 节](#572-多时间聚合包mtap)指定。

  信息说明：当交织模式中出现一个 FU-A，它总是跟在一个 FU-B 后面，该 FU-B 设置它的 DON。

  信息说明：如果一次传输想要将单个 NAL 单元封装在单个数据包中，且不按照其解码顺序传输包，可以使用 STAP-B 包类型。

在单 NAL 单元打包模式中，NAL 单元的传输顺序由 RTP 序列号确定，**必须**和其 NAL 单元解码顺序相同。在非交织打包模式中，但单NAL 单元包、STAP-A 和 FU-A 中的 NAL 单元传输顺序**必须**和其 NAL 单元解码顺序相同。STAP 内部的 NAL 单元**必须**按照 NAL 单元解码顺序出现。因此，首先通过 STAP 内部的隐式顺序提供解码顺序，然后通过 RTP 序列号提供 STAP、FU 和单 NAL 单元数据包之间的解码顺序。

STAP-B、MTAP 和以一个 FU-B 开头的一系列分片单元中携带的 NAL 单元的 DON 值的表示分别在 [5.7.1](#571-单时间聚合包stap)、[5.7.2](#572-多时间聚合包mtap) 和 [5.8](#58-分片单元fu) 指定。第一个按照传输顺序的 NAL 单元的 DON 值**可**设置为任何值。DON 值在 0 到 65535 范围内(包含 0 和 65535)。在达到最大值后，DON 的值回到 0。

包含在任何 STAP-B、MTAP 或以一个 FU-B 开头的一系列分片单元中的两个 NAL 单元的解码顺序如下确定。假定 `DON(i)` 是传输顺序中索引为 `i` 的 NAL 单元的解码顺序号。函数 `don_diff(m,n)` 如下确定：

```txt
如果 DON(m) == DON(n), don_diff(m,n) = 0

如果 DON(m) < DON(n) 且 DON(n) - DON(m) < 32768, don_diff(m,n) = DON(n) - DON(m)

如果 DON(m) > DON(n) 且 DON(m) - DON(n) >= 32768, don_diff(m,n) = 65536 - DON(m) + DON(n)

如果 DON(m) < DON(n) 且 DON(n) - DON(m) >= 32768, don_diff(m,n) = - (DON(m) + 65536 - DON(n))

如果 DON(m) > DON(n) 且 DON(m) - DON(n) < 32768, don_diff(m,n) = - (DON(m) - DON(n))
```

`don_diff(m,n)`正值表示传输顺序索引 n 的 NAL 单元在解码顺序上，位于传输顺序索引 m 的 NAL 单元之后。当 `don_diff(m,n)` 等于 0，两个 NAL 单元的 NAL 单元解码顺序任意。`don_diff(m,n)` 赋值表示传输顺序索引 n 的 NAL 单元在解码顺序上，位于传输顺序索引 m 的 NAL 单元之前。

DON 相关字段(DON/DONB/DOND，参阅 5.7 节)的值**必须**使得由 DON 值确定的解码顺序，如上所述，符合 NAL 单元解码顺序。

如果交换按照 NAL 单元解码顺序的两个 NAL 单元的顺序，且新顺序不符合 NAL 单元解码顺序，NAL 单元的 DON 值**一定不**相同。如果交换 NAL 单元流中的两个连续的 NAL 单元的顺序，且新顺序仍然符合 NAL 单元解码顺序，NAL 单元的 DON 值**可能**相同。比如，如果适应的视频编码配置文件允许任意的切片顺序，允许一个编码图片的所有编码切片NAL 单元具有相同的 DON 值。因此，具有相同 DON 值的 NAL 单元可以任意顺序解码，具有不同 DON 值的 NAL 单元必须按照上述指定顺序传递给解码器。当按照 NAL 单元解码顺序的两个连续的 NAL 单元具有不同的 DON 值时，按照解码顺序的第二个 NAL 单元的 DON 值应该是第一个 NAL 单元的 DON 值加 1。

第 7 节给出了解包过程以恢复 NAL 单元解码顺序的示例。

信息说明：即使在无错误传输中，接收者不应当期待按照 NAL 单元解码顺序的两个连续的 NAL 单元的 DON 差值为 1。增量为 1 不是必须的，因为在关联 DON 值到 NAL 单元时，可能不知道是否将所有 NAL 单元传递给接收者。比如，当转发包的网络带宽短缺时，网关可能不会转发非参考图片的切片NAL 单元或 SEI NAL 单元。在另一个例子中，直播有时会被预编码的内容(例如广告)打断。预编码剪辑的第一个帧内图片会被预先传输以确保它在接收者中随时可用。当传输第一个内部图片时，发起者并不确切知道按解码顺序跟随的预编码剪辑的第一个帧内图片之前会编码多少 NAL 单元。因此，预编码剪辑的第一个帧内图片放入 NAL 单元的 DON 值必须在传输时进行预估，且差距是可能出现的 DON 值。

### 5.6 单 NAL 单元数据包

这里定义的单 NAL 单元数据包**必须**仅包含一个 NAL 单元，类型在 [^1] 中定义。这意味着单 NAL 单元数据包内不能使用聚合包或分片单元。按 RTP 序列号对单 NAL 单元数据包进行解包组成的 NAL 单元流必须符合 NAL 单元解码顺序。单 NAL 单元数据包的结构在图 2 显示。

信息说明：NAL 单元的第一个字节共同作为 RTP 载荷的头部。

图 2——单 NAL 单元数据包的 RTP 载荷格式

```txt
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|F|NRI|  TYPE   |                                               |
+-+-+-+-+-+-+-+-+                                               |
|                                                               |
|               Bytes 2...n of a singe NAL unit                 |
|                                                               |
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :...OPTIONAL RTP padding        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### 5.7 聚合包

聚合包是此载荷规范的 NAL 单元聚合方案。引入此方案是为了反映两个关键目标网络显著不同的 MTU 大小：有线 IP 网络(MTU 大小通常受以太网 MTU 大小限制，大约 1500 字节)，基于 IP 或非基于 IP(例如，ITU-T H.324/M)的无限通信系统网络，后者首选传输单元大小为 254 字节或更小。为了防止两个世界之间的媒体转码，并避免不需要的打包开销，引入了 NAL 单元聚合方案。

此规范定义了两种类型的聚合包：

- 单时间聚合包(Single-time aggregation packet, STAP): 聚合具有相同 NALU 时间的 NAL 单元。定义了两种 STAP，没有 DON 的(STAP-A)和包含 DON 的(STAP-B)。
- 多时间聚合包(Multi-time aggregation packet, MTAP): 聚合 NAL 时间可能不同的 NAL 单元。定义了两种 MTAP，区别是 NAL 单元时间戳差值的长度。

一个聚合包中要携带的每个 NAL 单元都封装在一个聚合单元中。请阅读下面内容了解四种不同的聚合单元及其特点。

聚合包的 RTP 载荷格式的结构在图 3 中显式。

图 3——聚合包的 RTP 载荷格式

```txt
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|F|NRI|  TYPE   |                                               |
+-+-+-+-+-+-+-+-+                                               |
|                                                               |
|             one or more aggregation units                     |
|                                                               |
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :...OPTIONAL RTP padding        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

MTAP 和 STAP 共享下面的打包规则：

- RTP 时间戳**必须**设置为要聚合的所有 NAL 单元中最早的 NALU 时间
- NAL 单元类型 8 位字节的 type 字段**必须**按照表 4 说明设置为合适值
- 如果聚合的 NAL 单元的所有 F 位都是 0，F 位**必须**清除；否则，**必须**设置 F 位
- NRI 值**必须**是聚合包中携带的所有 NAL 单元的最大值

表 4——STAP 和 MTAP 的 type 字段

| type | 包 | 时间戳偏移量字段长度(单位：位) | DON 相关字段(DON/DONB/DOND)是否存在 |
| --- | --- | --- | --- |
| 24 | STAP-A | 0 | no |
| 25 | STAP-B | 0 | yes |
| 26 | MTAP16 | 16 | yes |
| 27 | MTAP24 | 24 | yes |

如果在自己的 RTP 包中传输，将 RTP 头部的标记位设置被聚合数据包的最后一个 NAL 单元的标记位。

一个聚合包的载荷包含一或多个聚合单元。查看 [5.7.1](#571-单时间聚合包stap) 和 [5.7.2](#572-多时间聚合包mtap) 获取四种不同类型的聚合单元。一个聚合包可按需携带多个聚合单元；但是，一个聚合包的数据总数显然**必须**适合一个 IP 包，且选中的**大小**应该使得生成的 IP 包小于 MTU 大小。正如 [5.8](#58-分片单元fu) 节指定，聚合包**不能**包含分片单元。聚合包**不能**被嵌套；也就是说，一个聚合包**不能**包含另一个聚合包。

#### 5.7.1 单时间聚合包(STAP)

无论何时聚合具有相同 NALU 时间的 NAL 单元时，**应该**使用单时间聚合包(STAP)。STAP-A 的载荷不包含 DON，且包含至少一个单时间聚合单元，如图 4 所示。STAP-B 的载荷包含一个 16 位的无符号解码序列号(DON)(按网络字节序)，其后是至少一个单时间聚合单元，如图 5 所示。

图 4——STAP-A 载荷格式

```txt
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                :                                               |
+-+-+-+-+-+-+-+-+                                               |
|                                                               |
|                 single-time aggregation units                 |
|                                                               |
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

图 5——STAP-B 载荷格式

```txt
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                :  decoding order number (DON)  |               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+               |
|                                                               |
|                 single-time aggregation units                 |
|                                                               |
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

DON 字段指定 STAP-B 中第一个传输顺序的 NAL 单元的 DON 值。对于 STAP-B 中每个按出现顺序的连续的 NAL 单元，DON 值等于 `(STAP-B 中前一个 NAL 单元的 DON 值 + 1) % 65536`，其中 `%` 表示取模操作。

一个单时间聚合单元包含一个 16 位的无符号大小信息(网络字节序)，表示后续 NAL 单元的字节大小(不包含这两个 8 位字节，但是包含此 NAL 单元的 NAL 单元类型 8 位字节)，之后是 NAL 单元本身，包含其 NAL 单元类型字节。一个单时间聚合单元在 RTP 载荷内部是字节对齐的，但是可能未在 32 位字边界对齐。图 6 显示了单时间聚合单元的结构。

图 6——单时间聚合单元结构

```txt
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                :        NAL unit size          |               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+               |
|                                                               |
|                           NAL unit                            |
|                                                               |
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

图 7 显示了包含一个 STAP-A 的 RTP 包的示例。该 STAP 包含两个单时间聚合单元，在图中标记为 1 和 2。

图 7——示例的 RTP 包包含一个 STAP-A，该 STAP-A 包含两个单时间聚合单元

```txt
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          RTP Header                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|STAP-A NAL HDR |         NALU 1 Size           | NALU 1 HDR    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         NALU 1 Data                           |
:                                                               :
+               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|               | NALU 2 Size                   | NALU 2 HDR    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         NALU 2 Data                           |
:                                                               :
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :...OPTIONAL RTP padding        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

图 8 显示了包含一个 STAP-B 的 RTP 包的示例。该 STAP 包含两个单时间聚合单元，在图中标记为 1 和 2。

图 8——示例的 RTP 包包含一个 STAP-B，该 STAP-B 包含两个单时间聚合单元

```txt
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          RTP Header                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|STAP-B NAL HDR | DON                           | NALU 1 Size   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| NALU 1 Size   | NALU 1 HDR    | NALU 1 Data                   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               +
:                                                               :
+               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|               | NALU 2 Size                   | NALU 2 HDR    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         NALU 2 Data                           |
:                                                               :
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :...OPTIONAL RTP padding        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

#### 5.7.2 多时间聚合包(MTAP)

MTAP 的 NAL 单元载荷包含一个 16 位无符号解码顺序号基础(decoding order number base, DONB)(网络字节序)，和一个或多个多时间聚合单元，正如图 9 所示。DONB **必须**包含 MTAP 的 所有 NAL 单元中，按照 NAL 单元解码顺序的第一个 NAL 单元的 DON 值。

  信息说明：按照 NAL 单元解码顺序的第一个 NAL 单元不必是 MTAP 中按照 NAL 单元封装顺序的第一个 NAL 单元。

图 9——MTAP 的 NAL 单元载荷格式

```txt
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                :  decoding order number base   |               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+               |
|                                                               |
|                 multi-time aggregation units                  |
|                                                               |
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

此规范定义了两种不同的多时间聚合单元。二者都包含 16 位的无符号大小信息(网络字节序)，表示后续的 NAL 单元大小、一个 8 位无符号解码顺序号差值(decoding order number difference, DOND)，以及 n 位(网络字节序)表示该 NAL 单元的时间戳偏移量(TS offset)，n 为 16 或 24。不同 MTAP 类型(MTAP16 和 MTAP24)之间的选择取决于应用程序：时间戳偏移量越大，MTAP 的灵活性越高，但负载也越高。

MTAP16 和 MTAP24 的多时间聚合单元的结构分别在图 10 和图 11 显示。包内的聚合单元的开始或结束位置不需要在 32 位字边界对齐。多时间聚合单元内包含的 NAL 单元的 DON 等于 `(DONB + DOND) % 65536`，其中 `%` 表示取模运算。本文未指定 MTAP 内的 NAL 如何排序，但在大多数情况下，**应该**使用 NAL 单元解码顺序。

时间戳偏移量字段**必须**设置为等于下述公式的值：如果 NALU 时间大于或等于包的 RTP 时间戳，则时间戳偏移量等于 `NAL 单元的 NALU 时间 - 包的 RTP 时间戳`。如果 NALU 时间小于包的 RTP 时间戳，则时间戳偏移量等于 `NALU 时间 + (2^32 - 包的 RTP 时间戳)`。

图 10——MTAP16 的多时间聚合单元

```txt
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
:        NAL unit size          |      DOND     |  TS offset    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  TS offset    |                                               |
+-+-+-+-+-+-+-+-+              NAL unit                         |
|                                                               |
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

图 11——MTAP24 的多时间聚合单元

```txt
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
:        NAL unit size          |      DOND     |  TS offset    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  TS offset                    |                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |
|                              NAL unit                         |
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

对于一个 MTAP 内的“最早的”多时间聚合单元，时间戳偏移量**必须**是零。因此，MTAP 本身的 RTP 时间戳和最早的 NALU 时间相同。

  信息说明：如果将包含在聚合单元的 NAL 单元封装到单 NAL 单元数据包中，则“最早的”多时间聚合单元在 MTAP 的所有聚合单元中具有最小扩展 RTP 时间戳。扩展时间戳是具有超过 32 位的时间戳，并且能够计算时间戳字段的回绕，从而使人们能够确定时间戳回绕时的最小值。这种“最早的”聚合单元可能不是在 MTAP 中按照封装顺序的第一个聚合单元。“最早的” NAL 单元也不必与 NAL 单元解码顺序中的第一个 NAL 单元相同。

图 12 显示包含一个 MTAP16 类型的多时间聚合包的 RTP 包的示例，包含两个多时间聚合单元，在图中标记为 1 和 2。

图 12——包含一个 MTAP16 类型的多时间聚合包的 RTP 包的示例，包含两个多时间聚合单元

```txt
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          RTP Header                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|MTAP16 NAL HDR |  decoding order number base   | NALU 1 Size   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  NALU 1 Size  |  NALU 1 DOND  |       NALU 1 TS offset        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  NALU 1 HDR   |  NALU 1 DATA                                  |
+-+-+-+-+-+-+-+-+                                               +
:                                                               :
+               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|               | NALU 2 SIZE                   |  NALU 2 DOND  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|       NALU 2 TS offset        |  NALU 2 HDR   |  NALU 2 DATA  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+               |
:                                                               :
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :...OPTIONAL RTP padding        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

图 13 显示包含一个 MTAP24 类型的多时间聚合包的 RTP 包的示例，包含两个多时间聚合单元，在图中标记为 1 和 2。

图 13——包含一个 MTAP24 类型的多时间聚合包的 RTP 包的示例，包含两个多时间聚合单元

```txt
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          RTP Header                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|MTAP24 NAL HDR |  decoding order number base   | NALU 1 Size   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  NALU 1 Size  |  NALU 1 DOND  |       NALU 1 TS offset        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|NALU 1 TS offs |  NALU 1 HDR   |  NALU 1 DATA                  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               +
:                                                               :
+               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|               | NALU 2 SIZE                   |  NALU 2 DOND  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|       NALU 2 TS offset                        |  NALU 2 HDR   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  NALU 2 DATA                                                  |
:                                                               :
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :...OPTIONAL RTP padding        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### 5.8 分片单元(FU)

此载荷类型允许将一个 NAL 单元分片成多个 RTP 包。在应用层这样做而不是依赖底层分片(比如通过 IP)具有下面的优点：

- 载荷格式可以通过 IPv4 网络传输大于 64k 字节的 NAL 单元，它们可能出现在预录制视频，尤其是高分辨率格式(每个图片存在切片数目上限，导致每个图片的 NAL 单元有限，这可能导致大的 NAL 单元)。
- 分片机制允许对单 NAL 单元分片，并应用通用的前向纠错，正如 [12.5](#125-带有-fu-和前向纠错的视频电话或流) 所述。

分片只针对单 NAL 单元定义，而不针对任何聚合包。NAL 单元的分片由该 NAL 单元的整数个连续 8 位字节组成。NAL 单元的每个 8 位字节必须恰好是该 NAL 单元的一个分片的一部分。相同 NAL 单元的分片**必须**按照升序的 RTP 序列号顺序发送(在同一 RTP 包流内，第一个和最后一个分片之间没有发送其他 RTP 包)。类似地，**必须**按照 RTP 序列号顺序重组 NAL 单元。

当对 NAL 单元分片并在分片单元(FU)内传送时，它被称为分片 NAL 单元。STAP 和 MTAP **不能**被分片。FU **不能**嵌套；也就是说，一个 FU **不能**包含另一个 FU。

将携带 FU 的 RTP 包的 RTP 时间戳设置为分片 NAL 单元的 NALU 时间。

图 14 显示了 FU-A 的 RTP 载荷格式。一个 FU-A 包含一个 8 位字节的分片单元指示符、一个 8 位字节的分片单元头和一个分片单元载荷。

图 14——FU-A 的 RTP 载荷格式

```txt
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| FU indicator  |   FU header   |                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |
|                                                               |
|                         FU payload                            |
|                                                               |
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :...OPTIONAL RTP padding        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

图 15 显示了 FU-B 的 RTP 载荷格式。一个 FU-B 包含一个 8 位字节的分片单元指示符、一个 8 位字节的分片单元头、一个解码顺序号(DON)(网络字节序)和一个分片单元载荷。换句话说，FU-B 的结构和 FU-A 的结构相同，除了增加 DON 字段。

图 15——FU-B 的 RTP 载荷格式

```txt
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| FU indicator  |   FU header   |               DON             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
|                         FU payload                            |
|                                                               |
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :...OPTIONAL RTP padding        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

NALU 单元类型 FU-B **必须**用于交织打包模式中分片 NAL 单元的第一个分片单元。NAL 单元类型 FU-B **不能**用于任何其他情况。换句话说，在交织打包模式中，每个被分片的 NALU 都有一个 FU-B 作为第一个分片，然后是一个或多个 FU-A 分片。

FU 8 位字节指示符具有下面的格式：

```txt
+---------------+
|0|1|2|3|4|5|6|7| 
+-+-+-+-+-+-+-+-+
|F|NRI|  Type   |
+---------------+
```

FU 8 位字节指示符的 type 字段值为 28 和 29 分别标识 FU-A 和 FU-B。F 位的使用在 [5.3 节](#53-nal-单元头部用法)描述。NRI 字段的值**必须**根据分片 NAL 单元的 NRI 值进行设置。

FU 头具有下面的格式：

```txt
+---------------+
|0|1|2|3|4|5|6|7| 
+-+-+-+-+-+-+-+-+
|S|E|R|  Type   |
+---------------+
```

- S: 1 位。设置为 1 时，Start 位指示一个分片 NAL 单元的开始。当后续 FU 载荷不是分片 NAL 单元的载荷的开始时，Start 位设置为 0。
- E: 1 位。设置为 1 时，End 位指示分片单元的结束，即，载荷的最后一个字节也是分片 NAL 单元的最后一个字节。当后续 FU 载荷不是分片 NAL 单元的最后一个分片时，End 位设置为 0。
- R: 1 位。Reserved 位**必须**等于 0，且接收者**必须**忽视。
- Type: 5 位。NAL 单元载荷类型，正如 [^1] 的表 7-1 所定义。

FU-B 内 DON 值的选择正如 [5.5 节](#55-解码顺序号don)描述。

  信息说明：FU-B 内的 DON 字段允许网关将 NAL 单元分片为 FU-B，而无需将传入的 NAL 单元组织为 NAL 单元解码顺序。

一个分片 NAL 单元**不能**在一个 FU 中传输；也就是说，同一 FU 头内的 Start 和 End 位**不能**都设置为 1。

FU 载荷包含分片 NAL 单元的载荷的分片，因此如果将连续 FU 的分片单元载荷按顺序连接，则可以重构分片 NAL 单元的载荷。分片 NAL 单元的 NAL 单元类型 8 位字节不包括在分片单元载荷中，其信息在分片单元的 FU 8 位字节指示符的 F 和 NRI 字段以及 FU 头的 type 字段中传输。FU 载荷**可以**有任意数量的 8 位字节且**可以**为空。

  信息说明：在几乎无损环境中，允许空的 FU 以减少某类发送者的延迟。这些发送者可特征化为它们在 NALU 完全生成之前对 NALU 分片打包，因此，在已知 NALU 大小之前打包。如果不允许零长度的 NAL 分片，则在发送当前分片之前，发送者必须生成后续分片的至少一位数据。由于 H.264 的特性，有时几个宏块占用零位，这是不可取的，且会增加延迟。然而，应该仔细权衡零长度 NALU 分片的(潜在)使用与丢失至少一部分 NALU 风险的增加，因为其传输使用了额外的包。

如果丢失了一个分片单元，接收者**应该**丢弃后续按传输顺序的所有分片单元，它们对应同一分片 NAL 单元。

端点或 MANE 中的接收者可以将 NAL 单元的前 n-1 个分片聚合为一个(不完整的) NAL 单元，即使未接收到该 NAL 单元的第 n 个分片。在这种情况下，NAL 单元的 forbidden_zero_bit **必须**设置为 1 以指示语法违规。

## 6 打包规则

在 [5.2 节](#52-载荷结构)介绍了打包模式。[6.1 节](#61-通用打包规则)指定了对多种打包模式通用的打包规则。单 NAL 单元模式、非交织模式和交织模式分别在 [6.2](#62-单-nal-单元模式)、[6.3](#63-非交织模式) 和 [6.4](#64-交织模式) 节指定。

### 6.1 通用打包规则

无论使用何种打包模式，所有发送者**必须**强制执行以下打包规则：

- 属于同一编码图片(因此共享同一 RTP 时间戳值)的编码切片NAL 单元或编码切片数据分区 NAL 单元**可**按任意顺序发送；但是，对于延迟关键的系统，**应该**按照原始解码顺序发送以最小化延迟。请注意，解码顺序是比特流中 NAL 单元的顺序。
- 参数集的处理依据 [8.4](#84-参数集考虑) 给出的规则和建议。
- 除了 sps 和 pps NAL 单元，MANE **不能**复制任何 NAL 单元，因为本文和 H.264 规范都没有提供方法识别重复的 NAL 单元。**可以**复制 sps 和 pps NAL 单元以使其更可能被正确接收，但是任何此类复制**不能**影响任何活动 sps 或 pps 的内容。复制**应该**在应用层执行，而不是通过复制 RTP 包(具有相同的序列号)来执行。

使用非交织模式和交织模式的发送者**必须**强制执行以下打包规则：

- 在 RTP 转换器内，MANE **可以**将单个 NAL 单元包转换为一个聚合包，将一个聚合包转换为多个单 NAL 单元数据包，或混合使用这两种概念。RTP 转换器**应该**考虑至少以下参数：路径 MTU 大小、不平等保护机制(例如，根据 RFC 5109 [^18] 通过基于包的 FEC，尤其是 sps 和 ssp NAL 单元和编码切片数据分区 A NAL 单元)、系统可承受的延迟，以及接收者的缓冲能力。

  信息说明：根据 [RFC 3550](https://tools.ietf.org/pdf/rfc3550)，RTP 转换器需要处理 RTP 控制协议(RTP Control Protocol, RTCP)。

### 6.2 单 NAL 单元模式

当**可选的** packetization-mode 媒体类型参数等于 0 或者 packetization-mode 不存在时，使用此模式。所有接收者**必须**支持此模式。它主要用于低延迟的应用，该应用与使用 ITU-T H.241 建议 [^3] (查看 12.1 节)的系统兼容。这种模式下只**可以**使用单 NAL 单元数据包。**不能**使用 STAP、MTAP 和 FU。单 NAL 单元数据包的传输顺序**必须**符合 NAL 单元解码顺序。

### 6.3 非交织模式

当**可选的** packetization-mode 媒体类型参数等于 1 时，使用此模式。**应该**支持此模式。它主要用于低延迟的应用。这种模式下只**可以**使用单 NAL 单元数据包、STAP-A 和 FU-A。**不能**使用 STAP-B、MTAP 和 FU-B。NAL 单元的传输顺序**必须**符合 NAL 单元解码顺序。

### 6.4 交织模式

当**可选的** packetization-mode 媒体类型参数等于 2 时，使用此模式。一些接收者**可以**支持此模式。**可以**使用 STAP-B、MTAP、FU-A 和 FU-B。**不能**使用 STAP-A 和单 NAL 单元数据包。数据包和 NAL 单元的传输顺序受到 [5.5 节](#55-解码顺序号don)指定的约束。

## 7 解包过程

解包过程取决于实现。因此，以下描述应视为合适实现的示例。对于相同输入，只要输出与下面描述的过程相同，也可以使用其他方案。相同的输出意味着生成的 NAL 单元及其顺序是相同的。相对于所描述算法的优化是可能的。[7.1 节](#71-单-nal-单元和非交织模式)介绍了单 NAL 单元和非交织打包模式的解包过程，而 [7.2 节](#72-交织模式)描述了交织模式的解包过程。[7.3 节](#73-附加的解包指南)包含的附加解包指南针对智能接收者。

所有与缓冲区管理相关的正常 RTP 机制都适用。特别是，重复或过期的 RTP 包(通过 RTP 序列号和 RTP 时间戳指示)被删除。为了确定解码的确切时间，必须考虑诸如可能的故意延迟之类的因素以允许正确的流间同步。

### 7.1 单 NAL 单元和非交织模式

接收者包含接收者缓冲区以补偿传输延迟抖动。接收者按接收顺序将传入的包存储到接收者缓冲区中。按照 RTP 序列号解包。如果解包的包是一个单 NAL 单元数据包，则包中包含的 NAL 单元将直接传递给解码器。如果解包的包是 STAP-A，则包中包含的 NAL 单元将按照其在包中的封装顺序传递给解码器。对于包含单 NAL 单元分片的所有 FU-A 包，解包的分片按照其发送顺序进行连接以恢复 NAL 单元，然后将其传递给解码器。

  信息说明：如果解码器支持任意切片顺序，则图片的编码切片可以任意顺序传递给解码器，而不管它们的接收和传输顺序如何。

### 7.2 交织模式

这些解包规则背后的一般概念是将 NAL 单元从传输顺序重排序为 NAL 单元解码顺序。

接收者包含接收者缓冲区，用于补偿传输延迟抖动，并将 NAL 单元从传输顺序重排序为 NAL 单元解码顺序。在本节中，接收者操作是在没有传输延迟抖动的假设下描述的。为了将此接收者缓冲区与也用来补偿传输延迟抖动的实际接收者缓冲区区分开来，本节中接收者缓冲区在下文被称为解交织缓冲区。接收者还**应**为传输延迟抖动做准备，即，或者为传输延迟抖动缓冲和解交织缓冲保留单独的缓冲区，或者将接收者缓冲区同时用于传输延迟抖动和解交织。此外，接收者**应该**在缓冲操作中考虑传输延迟抖动，例如，在开始解码和点播之前通过额外的初始缓冲。

本节组织如下：[7.2.1 小节](#721-解交织缓冲区的大小)介绍如何计算解交织缓冲区的大小。[7.2.2 小节](#722-解交织过程)指定接收过程关于如何将接收到的 NAL 单元组织为 NAL 单元解码顺序。

#### 7.2.1 解交织缓冲区的大小

在 Offer/Answer 或声明性会话描述协议(SDP)使用中，sprop-deint-buf-req 媒体类型参数表示对解交织缓冲区大小的要求。因此，**建议**将解交织缓冲区大小(字节数)设置为等于或大于 sprop-deint-buf-req 媒体类型参数的值。

当在会话建立中使用 SDP Offer/Answer 模型或任何其他能力交换过程，接收的流的属性**应该**是不超过接收者能力的。在 SDP Offer/Answer 模型中，接收者可以通过 deint-buf-cap 媒体类型参数来指示其分配解交织缓冲区的能力。有关 deint-buf-cap 和 sprop-deint-buf-req 媒体类型参数的更多信息，请参阅 [8.1 节](#81-媒体类型注册)，有关它们在 SDP Offer/Answer 模型中使用的更多信息，请参阅 [8.2.2 节](#822-与-sdp-offeranswer-模型一起使用)。

#### 7.2.2 解交织过程

接收者有两个缓冲状态：初始缓冲和播放时缓冲。初始缓冲发生在 RTP 会话初始化时。在初始缓冲之后，开始解码和点播，然后使用播放时缓冲模式。

无论何种缓冲状态，接收者按照接收顺序将传入的 NAL 单元如下存储在解交织缓冲区中。聚合包的 NAL 单元分别存储在解交织缓冲区。为每个 NAL 单元计算 DON 值并保存该值。

下面借助以下函数和常量描述接收者操作：

- 函数 `AbsDON` 在 [8.1 节](#81-媒体类型注册)指定
- 函数 `don_diff` 在 [5.5 节](#55-解码顺序号don)指定
- 常量 `N` 是**可选的** sprop-interleaving-depth 媒体类型参数(查看 [8.1 节](#81-媒体类型注册))值加 1

初始缓冲持续到满足以下条件之一：

- 解交织缓冲区中有 `N` 或更多 VCL NAL 单元
- 如果存在 `sprop-max-don-diff`，`don_fiff(m,n)` 大于 `sprop-max-don-diff` 值，其中 `n` 对应接收的 NAL 单元中具有最大 `AbsDON` 值的 NAL 单元，且 `m` 对应接收的 NAL 单元中具有最小 `AbsDON` 值的 NAL 单元。
- 初始缓冲持续时长等于或大于**可选的** `sprop-init-buf-time` 媒体类型参数值。

从解交织缓冲区中移除 NAL 如下确定：

- 如果解交织缓冲区包含至少 `N` 个 VCL NAL 单元，从解交织缓冲区中移除 NAL 单元，并按以下指定顺序传递给解码器直到缓冲区包含 `N-1` 个 VCL NAL 单元。
- 如果存在 `sprop-max-don-diff`，从解交织缓冲区移除所有 `don_fiff(m,n)` 大于 `sprop-max-don-diff` 的 NAL 单元 `m`，并按以下指定顺序传递给解码器。在这里，`n` 对应解交织缓冲区中具有最大 `AbsDON` 值的 NAL 单元。

NAL 单元传递给解码器的顺序如下指定：

- 假定 `PDON` 是一个变量，在 RTP 会话开始时初始化为 0。
- 对于每个关联一个 DON 值的 NAL 单元，如下计算 DON 距离。如果 NAL 单元的 DON 值大于 `PDON` 值，DON 距离等于 `DON-PDON`。否则，DON 距离等于 `65535-PDON+DON+1`。
- NAL 单元按照 DON 距离升序传递给解码器。如果多个 NAL 单元共享同一 DON 距离，可按任意顺序将其传递给解码器。
- 当所需数量的 NAL 单元已经传递给解码器时，`PDON` 值设置为传递给解码器的最后一个 NAL 单元的 DON 值。

### 7.3 附加的解包指南

可使用如下附加的解包规则实现可操作性的 H.264 解包器：

- 智能 RTP 接收者(比如网关中的)可以识别丢失的编码切片数据分区 A(DPA)。如果检测到一个丢失的 DPA，在考虑可能的重传和 FEC 之后，网关可能决定不发送对应的编码数据分区 B 和 C，因为其信息对于 H.264 解码器是无意义的。以这种方式，MANE 可以通过丢弃无用包来降低网络负载，且不用解析复杂的比特流。
- 智能 RTP 接收者(比如网关中的)可以识别丢失的 FU。如果找到一个丢失的 FU，网关可能决定不发送同一分片 NAL 单元的 FU，因为其信息对于 H.264 解码器是无意义的。以这种方式，MANE 可以通过丢弃无用包来降低网络负载，且不用解析复杂的比特流。
- 需要丢弃包或 NALU 的智能接收者，首先应该丢弃所有 NAL 单元类型 8 位字节的 NRI 字段等于 0 的包/NALU。这会最小化对用户体验的影响并保持参考图片完整。如果需要丢弃更多包，则应该先丢弃 NRI 数值较低的包，再丢弃 NRI 数值较高的包。但是，丢弃任何 NRI 大于 0 的包很可能会导致解码器漂移，**应该**避免。

## 8 载荷格式参数

本节规定了**可能**使用的参数，用于选择载荷格式的可选特性以及比特流的某些特性。此处将参数指定为 ITU-T H.264 或 ISO/IEC 14496-10 编解码的媒体子类型注册的一部分。也为使用 SDP 的应用提供了参数到会话描述协议(SDP) [^6] 的映射。对于不使用 SDP 的控制协议，也可在别处定义等效参数。

一些参数为接收者提供将要发送的流的属性。对于流属性，所有这些参数的名称都以 `sprop` 开头。其中一些 `sprop` 参数受其他载荷或编解码配置参数的限制。例如，`sprop-parameter-sets` 参数受 `profile-level-id` 参数的约束。

### 8.1 媒体类型注册

ITU-T H.264 或 ISO/IEC 14496-10 编解码的媒体子类型已从 IETF 树中分配。

媒体类型名称: video

媒体子类型名称: H264

必要参数: 无

可选参数:

#### profile-level-id

[^1] 中指定了 sps NAL 单元中以下三个字节的 base16 [^7] (十六进制)表示：

1) profile_idc
2) 这里称为 profile-iop 的一个字节，由 constraint_set0_flag、constraint_set1_flag、constraint_set2_flag、constraint_set3_flag、constraint_set4_flag、constraint_set5_flag 和 reserved_zero_2bits 组成，按照位有效值顺序，从最高有效位开始
3) level_idc。请注意，[^1] 中要求 reserved_zero_2bits 等于 0，但是 ITU-T 或 ISO/IEC 未来可能规定它的其他值。
  
profile-level-id 参数指示默认的子配置(即，可能用于生成流或接收者支持的编码工具子集)和流或接收者支持的默认等级。

通过 profile_idc 字节和 profile-iop 字节的某些字段共同指示默认子配置。正如 [^1] 的 7.4.2.1.1 节指定，默认子配置可能是一个配置支持的编码工具的子集，或多个配置的编码工具的共同子集，取决于 profile-iop 字节的字段值。默认等级通过 level_idc 字节指示，且当 profile_idc 等于 66、77 或 88 (基线、主要或扩展配置)且 level_idc 等于 11 时，也通过 profile-iop 字节的第 4 位(constraint_set3_flag)指示。当 profile_idc 等于 66、77 或 88 (基线、主要或扩展配置)，level_idc 等于 11 时，profile-iop 字节的第 4 位(constraint_set3_flag)等于 1，默认等级是 Level 1b。

表 5 列举了 [^1] 的附录 A 中定义的所有配置，对于每个配置，表示相同子配置的 profile_idc 和 profile-iop 的可能组合。

表 5——表示相同子配置的 profile_idc 和 profile-iop 的组合，对应一个配置支持的全套编码工具。下文中，x 可能是 0 或 1，配置名称如下所示。CB: 受限基线配置(Constrained Baseline profile)，B: 基线配置(Baseline profile)，M: 主要配置(Main profile)，E: 扩展配置(Extended profile)，H: 高配置(High profile)，H10:高 10 配置(High 10 profile)，H42: 高 4:2:2 配置(High 4:2:2 profile)，H44: 高 4:4:4 预测配置(High 4:4:4 profile)，H10I: 高 10 内配置(High 10 Intra profile)，H42I: 高 4:2:2 内配置(High 4:2:2 Intra profile)，H44I: 高 4:4:4 内配置(High 4:4:4 Intra profile)，C44I: CAVLC 4:4:4 内配置(CAVLC 4:4:4 Intra profile)

| Profile | profile_idc(十六进制) | profile-iop(二进制) |
| --- | --- | --- |
| CB | 42(B) | x1xx0000 |
| - | 4D(M) | 1xxx0000 |
| - | 58(E) | 11xx0000 |
| B | 42(B) | x0xx0000 |
| - | 58(E) | 10xx0000 |
| M | 4D(M) | 0x0x0000 |
| E | 58 | 00xx0000 |
| H | 64 | 00000000 |
| H10 | 6E | 00000000 |
| H42 | 7A | 00000000 |
| H44 | F4 | 00000000 |
| H10I | 6E | 00010000 |
| H42I | 7A | 00010000 |
| H44I | F4 | 00010000 |
| C44I | 2C | 00010000 |

例如，在上述表中，profile_idc 等于 58(扩展的)且 profile-iop 等于 11xx0000 表示的子配置与 profile_idc 等于 42(基线)且 profile-iop 等于 x1xx0000 对应的子配置相同。请注意，profile_idc 和 profile-iop 的其他组合(表 5 中未列举)可能表示的子配置等同于多个配置的编码工具的共同子集。另外请注意，符合某些配置的解码器可能可以解码符合其他配置的比特流。

如果 profile-level-idc 参数用于指示 NAL 单元流的属性，它表示要解码流，解码器需要支持的编码工具的最小子集是默认的子配置，且解码器需要支持的最低 level 是默认 level。

如果 profile-level-idc 参数用于能力交换或会话建立，它表示等于编解码同时支持接收和发送的默认子配置的编码工具子集。如果 max-recv-level 不存在，来自 profile-level-id 的默认 level 表示编解码希望支持的最高 level。如果存在 max-recv-level，它表示编解码接收支持的最高 level。对于接收或发送，**必须**支持所有比支持的最高 level 低的 level。

  信息说明：能力交换和会话建立程序应该提供方法分别列举每个支持的子配置的能力。例如，可以使用 SDP Answer/Offer 模型的 N 选 1 编码器选择程序([^8] 的 10.2 节)。N 选 1 编码器选择程序也可用于提供表示相同子配置的 profile_idc 和 profile-iop 的不同组合。当有许多表示相同子配置的 profile_idc 和 profile-iop 的不同组合时，使用 N 选 1 编码器选择程序可能导致相当大的 SDP 消息。因此，接收者应该理解表示相同子配置的 profile_idc 和 profile-iop 的不同组合，且准备好接受使用任何等价组合的 offer。

如果不存在 profile-level-idc，**必须**推断为在 Level 1 没有附加约束的基线配置。

#### max-recv-level

当最高 level 高于默认 level(profile-level-idc 指示的 level)时，此参数**可**用于指示接收者支持的最高 level。max-recv-level 值是 [^1] 中指定的 sps NAL 单元中 profile_idc 语法元素之后两个字节的 base16(十六进制)表示：profile-iop(如上定义)和 level_idc。如果 max-recv-level 的 level_idc 字节等于 11 且 max-recv-level 的 profile-iop 字节的第 4 位等于 1，或 max-recv-level 的 level_idc 字节等于 9 且 max-recv-level 的 profile-iop 字节的第 4 位等于 0，接收者支持的最高 level 是 Level 1b。否则，接收者支持的最高 level 等于 max-recv-level 的 level_idc 字节除以 10。

如果接收者支持的最高 level 不高于默认 level，max-recv-level **一定不能**存在。

#### max-mbps、max-smbps、max-fs、max-cpb、max-dpb、max-br

这些参数**可**用于指示接收者实现的能力。这些参数**一定不能**用于任何其他目的。profile-level-id 参数或 max-recv-level 参数值中传递的最高 level **必须**使得接收者完全可以支持。max-mbps、max-smbps、max-fs、max-cpb、max-dpb 和 max-br **可**用于指示扩展了表示的最高 level 所需能力的接收者的能力，如下指定。

当集合(max-mbps、max-smbps、max-fs、max-cpb、max-dpb、max-br)中的多个参数存在时，接收者**必须**同时支持所有指示的能力。例如，如果存在 max-mbps 和 max-br，要支持指示的带有帧率和比特率扩展的最高级别。也就是说，接收者可以解码宏块处理率达到 max-mbps(包含)，且比特率达到 max-br(包含)的 NAL 单元流，解码的图片缓存大小由如下指定的 max-br 参数的语义得到，且其他属性符合 profile-level-id 参数或 max-recv-level 参数指定的最高 level。

如果接收者可以支持 Level A 的所有属性，profile-level-id 参数或 max-recv-level 参数指定的最高 level **必须**是 Level A(即，**一定不能**低于 Level A)。换句话说，接收者指示 max-mbps、max-fs、max-cpb、max-dpb 和 max-br 值组合之后满足的 level **不能**比 profile-level-id 参数或 max-recv-level 参数指定的最高 level 高。

信息说明：当**可选的**媒体类型参数用于指示 NAL 单元流的属性时，max-mbps、max-smbps、max-fs、max-cpb、max-dpb 和 max-br 不存在，且 profile-level-idc 的值必须总是使得 NAL 单元流完全符合指定的配置和 level。

#### max-mbps

max-mbps 的值是一个整数，指示最大的宏块处理速度，单位是宏块/秒。max-mbps 参数指示接收者可以解码视频的速度高于 profile-level-id 参数或 max-recv-level 参数指定的最高 level 指示的速度。

当指示 max-mbps 时，接收者**必须**可以解码符合指示的最高 level 的 NAL 单元流，除了 [^1] 的表 A-1 中用于指示的最高 level 的 MaxMBPS 值被 max-mbps 替换。max-mbps 值**必须**大于或等于 [^1] 的表 A-1 中用于最高 level 的 MaxMBPS 值。与指示的最高 level 表示的图片率相比，发送者**可以**使用此信息按更高的图片率发送给定大小的图片。

#### max-smbps

max-smbps 值是一个整数，指示最大的静态宏块处理速度，单位是宏块/秒，假设所有宏块都是静态宏块。当指示 max-smbps 时，[^1] 的表 A-1 中的 MaxMBPS 值应被下面计算的结果代替：

- 如果指示了 max-mbps 参数，设置 MaxMacroblocksPerSecond 变量为 max-mbps 的值。否则，对于 profile-level-id 参数或 max-recv-level 参数中传递的最高 level，设置 MaxMacroblocksPerSecond 等于 [^1] 的表 A-1 中的 MaxMBPS 值。
- 设置 P-non-static 变量为图片 n 的非静态宏块的比例。
- 设置 p_static 变量为图片 n 的静态宏块的比例。
- 编码器应考虑 [^1] 的表 A-1 中的 MaxMBPS 值等于：`MaxMacroblocksPerSecond * max-smbps / (P_non-static * max-smbps + P_static * MaxMacroblocksPerSecond)`

对于每个图片编码器应该重新计算此值。max-smbps 值**必须**大于或等于 MaxMBPS 的值，由 max-mbps 参数显示给出或由[^1] 的表 A-1 中的指示的最高 level 隐式给出。发送者**可以**使用此信息按高于指示的最高 level 表示的图片速率发送给定大小的图片。

#### max-fs

max-fs 的值是一个整数，指示最大的帧大小，单位是宏块数。max-fs 参数指示接收者可以解码的图片大小大于 profile-level-id 参数或 max-recv-level 参数传递的最高 level 所需的大小。当指示了 max-fs，接收者**必须**可以解码符合指示的最高 level 的 NAL 单元流，除了 [^1] 的表 A-1 中用于指示的最高 level 的 MaxFS 值被 max-fs 替换。max-fs 值**必须**大于或等于 [^1] 的表 A-1 中用于最高 level 的 MaxFS 值。与指示的最高 level 表示的帧率相比，发送者**可以**使用此信息以成比例的较低帧率发送较大的图片。

#### max-cpb

max-cpb 是一个整数，指示最大的编码图片缓存大小，对于 VCL HRD 参数单位是 1000b，且对于 NAL HRD 参数单位是 1200b。请注意，此参数不使用 cpbBrVclFactor 和 cpbBrNALFactor(参阅 [^1] 的表 A-1)。max-cpb 参数指示接收者拥有的内存大于 profile-level-id 参数或 max-recv-level 参数传递的最高 level 所需的编码图片缓存内存。当指示了 max-cpb，接收者**必须**可以解码符合指示的最高 level 的 NAL 单元流，除了 [^1] 的表 A-1 中用于指示的最高 level 的 MaxCPB 值被 max-cpb 替换(需要时考虑了 cpbBrVclFactor 和 cpbBrNALFactor)。max-cpb 的值(需要时考虑了 cpbBrVclFactor 和 cpbBrNALFactor)**必须**大于或等于 [^1] 的表 A-1 中用于最高 level 的 MaxCPB 值。与使用 [^1] 的表 A-1 中的 MaxCPB 值可以达到的比特率变化相比，发送者**可以**使用此信息构造具有更高的比特率变化的编码视频流。

信息说明：编码图片缓存用于假设参考解码器(H.264 的附录 C)。在 H.264 编码器中建议使用假设参考解码器以验证生成的比特流符合标准，并控制输出比特率。因此，编码图片缓存在概念上与接收者中其他可能的缓存无关，包括解交织和解抖动缓存。H.264 的附录 C 中指定的解码器中不需要实现编码图片缓存，但是符合标准的解码器可以有任何缓存安排，只要它们可以解码符合标准的比特流。因此，实际上，对于视频解码器的输入缓存可以和接收者的解交织和解抖动缓存整合。

#### max-dpb

max-dpb 是一个整数，指示最大的解码图片缓存大小，单位是 8/3 宏块数。max-dpb 参数指示接收者具有的内存大于 profile-level-id 参数或 max-recv-level 参数传递的最高 level 所需的最小解码图片缓存内存。当指示了 max-dpb，接收者**必须**可以解码符合指示的最高 level 的 NAL 单元流，除了 [^1] 的表 A-1 中用于指示的最高 level 的 MaxDPBMbs 值被 `max-dpb*3/8` 替换。因此，指示了 max-dpb 的接收者**必须**可以在其解码图片缓存中存储以下数目的解码帧、互补场对和非配对场：

```txt
Min(max-dpb * 3 / 8 / (PicWidthInMbs * FrameHeightInMbs), 16)
```

其中，PicWidthInMbs 和 FrameHeightInMbs 在 [^1] 中定义。

max-dpb 的值必须大于或等于 `MaxDPBMbs*3/8` 的值，其中 MaxDPBMbs 在 [^1] 的表 A-1 中用于指示的最高 level 给出。发送者**可以**使用此信息构造具有改进压缩的编码视频流。

信息说明：添加此参数主要是为了补充 ITU-T H.245 建议中的类似代码点，以便于信令网关设计。解码图片缓存存储重建的采样。解码图片缓存区的大小和 RTP 中所用缓存区无关，尤其是解交织和解抖动缓存。

信息说明：在本文档废弃的 [RFC 3984](https://tools.ietf.org/pdf/rfc3984) 中，此参数的单位是 1024 字节。本文档中的单位以更改为 8/3 宏块。发生这种变化的原因是由于 [RFC 3984](https://tools.ietf.org/pdf/rfc3984) 引用的 2003 版 H.264 规范到本文档引用的 2010 版 H.264 规范的变化，特别是 H.264 规范中表 A-1 添加了早期不支持的颜色格式和位深度。此参数修改的语义保持向后兼容 [RFC 3984](https://tools.ietf.org/pdf/rfc3984)，且支持 2010 版 H.264 规范中定义的所有配置。

#### max-br

max-br 是一个整数，指示最大的视频比特率，对于 VCL HRD 参数单位是 1000b/s，且对于 NAL HRD 参数单位是 1200b/s。请注意，此参数不使用 cpbBrVclFactor 和 cpbBrNALFactor (查看 [^1] 的表 A-1)。

max-br 参数指示接收者的视频解码器可以解码视频的比特率大于 profile-level-id 参数或 max-recv-level 参数传递的最高 level 所需的比特率。

当指示了 max-br，接收者的视频编解码器**一定**可以解码符合指示的最高 level 的 NAL 单元流，除了最高 level 指定的以下限制：

- max-br 值(需要是考虑了 cpbBrVclFactor 和 cpbBrNALFactor)替换了 [^1] 的表 A-1 中用于最高 level 的 MaxBR 值。
- 当 max-cpb 参数不存在时，以下公式的结果替换了 [^1] 的表 A-1 中的 MaxBR 值：`(MaxCPB of the signaled level) * max-br / (MaxBR of the signaled highest level)`。

例如，如果接收者使用 max-br 等于 1550 表示主配置 Level 1.2 的能力，这表示 VCL HRD 参数的最大视频比特率是 1550kb/s，NAL HRD 参数的最大视频比特率为 1860kb/s，且 CPB 大小为 4036458 位(`1550000 / 384000 * 1000 * 1000`)。

max-br 值(需要时考虑了 cpbBrVclFactor 和 cpbBrNALFactor)必须大于或等于 [^1] 的表 A-1 中用于指示的最高 level 给出的 MaxBR 值。

发送者**可以**使用此信息发送比 H.264 附录 A 的 level 定义中允许的更高比特率的视频，以提高视频质量。

信息说明：增加此参数主要是为了补充 ITU-T H.245 建议中类似的代码点，以便信令网关设计。不能从此参数值假设网络可在任意给定时刻处理此类比特率。特别是，不能得出在拥塞控制约束下指示的比特率是可能的结论。

#### redundant-pic-cap

此参数指示接收者实现的能力。当等于 0 时，该参数表示接收者不尝试使用冗余编码图像来就挣不正确解码的基本编码图像。当等于 0 时，接收者不能使用冗余切片；因此，发送者**应该**避免发送冗余切片以节省带宽。当等于 1 时，接收者可以解码覆盖基本编码图像中损坏区域(至少部分)的任何此类冗余切片，因此发送者**可以**发送冗余切片。当此参数不存在时，redundant-pic-cap **必须**使用 0 值。当参数存在时，redundant-pic-cap 的值**必须**是 0 或 1。

当 profile-level-idc 参数与 redundant-pic-cap 存在相同的信令中，且 profile-level-idc 指示的配置不允许使用冗余编码图像(比如主配置)时，redundant-pic-cap 值**必须**等于 0。当接收者指示 redundant-pic-cap 等于 0，接收的流**不应该**包含冗余编码图像。

信息说明：即使 redundant-pic-cap 等于 0，解码器可以忽视冗余编码图像，前提是解码器支持的配置(基线配置、扩展配置)支持冗余编码图像。

信息说明：即使 redundant-pic-cap 等于 1，接收者也可以选择其他错误隐藏策略，以替换或补充冗余切片的解码。

#### sprop-parameter-sets

此参数**可**用于传递任何序列和图片参数集 NAL 单元(在此称为初始参数集 NAL 单元)，这些 NAL 单元可放置在 NAL 单元流中以解码顺序位于任何其他 NAL 单元之前。此参数**不能**在任何能力交换过程中用于指示编解码能力。该参数的值是以逗号(`,`)分隔的列表，是 [^1] 的 7.3.2.1 和 7.3.2.2 节中指定的参数集 NAL 单元的 base64 [^7] 表示。请注意，参数集 NAL 单元中的字节数通常小于 10，但是图片参数集 NAL 单元可以包含几百字节。

信息说明：当 SDP Answer/Offer 模型中提供多个载荷类型时，每个带有自己的 sprop-parameter-sets 参数，接收者不能假设这些参数集不会使用冲突的存储位置(即参数集标识符的值相同)。因此，接收者应该缓存所有的 sprop-parameter-sets，并使其对解码某种载荷类型的解码器实例可用。

sprop-parameter-sets 参数**必须**只包含符合 profile-level-id 的参数集，即通过任何此参数集指示的编码工具子集**必须**等于默认的子配置，且通过任何此参数集指示的 level **必须**等于默认 level。

#### sprop-level-parameter-sets

此参数**可**用于传递任何序列和图片参数集 NAL 单元(在此称为初始参数集 NAL 单元)，这些 NAL 单元可放置在 NAL 单元流中以解码顺序位于任何其他 NAL 单元之前，且和不同于默认 level 的一个或多个 level 相关联。此参数**不能**在任何能力交换过程中用于指示编解码能力。

sprop-level-parameter-sets 参数包含不同于默认 level 的一个或多个 level 的参数集。与一个 level 关联的所有参数集都聚集在一起，并一个三字节字段作为前缀，该字段具有与 profile-level-id 相同的语法。这使得接收者可以为一个 level 安装参数集并丢弃其他参数集。该三字节字段名为 PLId，且与一个 level 关联的所有参数集名为 PSL，其具有和 sprop-parameter-sets 相同的语法。每个 level 的参数集表示为 `PLId:PSL` 的形式，即 PLId 之后跟随一个分号(`:`)和该 level 的初始参数集 NAL 单元的 base64 [^7] 表示。每个 `PLId:PSL` 对也是有一个分号(`:`)分隔。请注意，PSL 可以为该 level 包含多个参数集，使用逗号(`,`)分隔。

通过每个 PLId 字段指示的编码工具自己**必须**等于默认的子配置，缺通过每个 PLId 字段指示的 level **必须**不同于默认 level。包含在每个 PSL 中的所有sps **必须**具有从 profile_idc 到 level_idc(包括 profile_idc 和 level_idc)的三字节，等于前一个 PLId。

信息说明：此参数允许同时在 SDP Answer/Offer 和带外传输中进行有效的 level 降级或升级。

#### use-level-src-parameter-sets

此参数**可**用于指示接收者能力。其值**可以**等于 0 或 1。当此参数不存在时，值**必须**推测为等于 0。值 0 表示接收者不理解 sprop-level-parameter-sets 参数，不理解 [^9] 6.3 节中所指定的 “fmtp” 源属性，当 sprop-level-parameter-sets 存在时会忽略，且当使用 “fmtp” 源属性传达时会户口 sprop-parameter-sets。值 1 表示接收者理解 sprop-level-parameter-sets 参数，理解 [^9] 6.3 节中所指定的 “fmtp” 源属性，且可以使用包含在 sprop-level-parameter-sets 或使用 “fmtp” 源属性传达的 sprop-parameter-sets 中的参数集。

信息说明：[RFC 3984](https://tools.ietf.org/pdf/rfc3984) 接收者不理解 sprop-level-parameter-sets、use-level-src-parameter-sets 或 [^9] 6.3 节中所指定的 “fmtp” 源属性。因此，在 SDP Answer/Offer 期间，作为 answerer 的 [RFC 3984](https://tools.ietf.org/pdf/rfc3984) 接收者会简单忽略 sprop-level-parameter-sets (当 offer 中存在时)，以及使用 “fmtp” 源属性传达的 sprop-parameter-sets，正如 [^9] 6.3 节中所指定。假定提供的载荷类型被接受的某个 level 低于默认 level。如果提供的载荷类型包含 sprop-level-parameter-sets 或包含使用 “fmtp” 源属性传达的 sprop-parameter-sets，且如果 offerer 发现 answerer 的回复中没有包含 use-level-src-parameter-sets 等于 1，则 offerer 知道需要参数集的带内传输。

#### in-band-parameter-sets

此参数**可**用于指示接收者能力。其值**可以**等于 0 或 1。值 1 表示接收者丢弃 sprop-parameter-sets 和 sprop-level-parameter-sets 内的带外参数集；因此，发送者**必须**传输所有带内参数集。值 0 表示接收者利用包含在 sprop-parameter-sets 和/或 sprop-level-parameter-sets 内的带外参数集。但是在这种情况下，发送者仍然**可以**选择发送带内参数集。当 in-band-parameter-sets 等于 1 时，use-level-src-parameter-sets **一定不能**存在或**必须**等于 0。当此参数不存在时，此接收者能力未指定，因此发送者**可以**只发送带外参数集，**可以**只发送带内参数集，或**可以**两者都发送。

#### level-asymmetry-allowed

**可**在 SDP Offer/Answer 中使用此参数来指示是否允许 level 非对称，即在 offerer-toanswerer 方向发送的媒体编码 level 和 answerer-to-offerer 方向的 level 不同。此值**可以**等于 0 或 1。当参数不存在时，**必须**推测其值等于 0。offer 和 answer 中的值 1 表示允许 level 非对称。offer 或 answer 中的值 0 表示不允许 level 非对称。

如果 offer 或 answer 中的 level-asymmetry-allowed 等于 0 (或不存在)，不允许 level 非对称。在这种情况下，从 offerer 到 answerer 的方向使用的 level **必须**与相反方向的 level 相同。

#### packetization-mode

此参数指示 RTP 载荷类型或接收者实现能力的属性。只能指示一个配置点；因此，当声明能力支持多个 packetization-mode 时，必须使用多个配置点(RTP 载荷类型)。

当 packetization-mode 值等于 0 或 packetization-mode 不存在时，**必须**使用单 NAL 模式。使用 ITU-T H.241 建议 [^3](查看 12.1 节)的标准中在用此模式。当 packetization-mode 值等于 1，**必须**使用非交织模式。当 packetization-mode 值等于 2，**必须**使用交织模式。packetization-mode 值**必须**是范围 0 到 2 (包括 0 和 2)的整数。

#### sprop-interleaving-depth

当 packetization-mode 不存在或值等于 0 或 1 时，此参数**一定不能**存在。当 packetization-mode 值等于 2 时，此参数**必须**存在。

此参数指示 RTP 包流的属性。它指定 RTP 包流中按传输顺序位于任何 VCL NAL 单元之前和按解码顺序为 VCL NAL 单元之后的 VCL NAL 单元的最大数目。因此，当用于 NAL 单元解码顺序恢复的缓存大小至少为  `sprop-interleaving-depth+1` (单位是 VCL NAL 单元) 时，保证接收者可以重建 NAL 单元解码顺序。

sprop-interleaving-depth 值**必须**是 0 到 32767 (包括 0 和 32767)范围内的整数。

#### sprop-deint-buf-req

当 packetization-mode 不存在或值等于 0 或 1 时，此参数**一定不能**存在。当 packetization-mode 值等于 2 时，此参数**必须**存在。

sprop-deint-buf-req 指示用于 RTP 包流的解交织缓存所需大小。该参数的值**必须**大于等于 7.2 节指定的此类解交织缓冲区所需的最大缓冲区占用(单位是字节)。当解交织缓冲区大小至少是 sprop-deint-buf-req 的值(单位是字节)时，确保接收者可以将交织的 NAL 单元解交织为 NAL 单元解码顺序。

sprop-deint-buf-req 值**必须**是 0 到 4294967295 (包括 0 和 4294967295)范围内的整数。

信息说明：sprop-deint-buf-req 只指示解交织缓存所需的大小。当发生网络抖动时，还必须提供合适大小的抖动缓存。

#### deint-buf-cap

此参数指示接收者实现的能力，并指示接收者可用的解交织缓存空间的数目(单位是字节)，用于重构 NAL 单元解码顺序。接收者可以处理任何流，该流的 sprop-deint-buf-req 参数小于等于此参数值。

如果此参数不存在，则**必须**为 deint-buf-cap 使用 0 值。deint-buf-cap **必须**是 0 到 4294967295 (包括 0 和 4294967295)范围内的整数。

信息说明：deint-buf-cap 只指示接收者的解交织缓存最大可能的大小。当发生网络抖动时，还必须提供合适大小的抖动缓存。

#### sprop-init-buf-time

此参数**可**用于指示 RTP 包流的属性。当 packetization-mode 值等于 0 或 1 时，该参数**一定不能**存在。

该参数指示初始缓存时间，即接收者从传输顺序开始解码以恢复 NAL 单元解码顺序之前**必须**等待的时间。此参数是 `NAL 单元的解码时间 - NAL 单元的传输时间` 的最大值，假定传输可靠且瞬时，传输和解码时间线相同，并且在第一个数据包到达时开始解码。

如下示例指定 sprop-init-buf-time 的值。NAL 单元流按以下交错顺序发送，从左到右对应解码时间和传输顺序的值：

```txt
0  2  1  3  5  4  6  8  7 ...
```

假定 NAL 单元的传输率稳定，传输时间是：

```txt
0  1  2  3  4  5  6  7  8 ...
```

按列从传输时间减去解码时间得到下面的序列：

```txt
0 -1  1  0 -1  1  0 -1  1 ...
```

因此，就 NAL 单元传输时间的间隔而言，此示例中 sprop-init-buf-time 的值为 1。该参数被编码为非负 base10 的整数表示，以 90kHz 时钟的时钟 tick 为单位。如果该参数不存在，则未定义初始缓存时间值。否则，sprop-init-buf-time 值**必须**是 0 到 4294967295 (包括 0 和 4294967295) 范围的整数。

除了指示的 sprop-init-buf-time，接收者**应该**考虑传输延迟抖动缓存，包括对混频器、转换器、网关、代理、流量整形器和其他网络元素导致的延迟抖动的缓存。

#### sprop-max-don-diff

此参数**可**用于指示 RTP 包流的属性。它**一定不能**用于指示发射器、接收者或编解码能力。如果 packetization-mode 值等于 0 或 1，该参数**一定不能**存在。sprop-max-don-diff 是 0 到 32767 (包括 0 和 32767)范围内的整数。如果 sprop-max-don-diff 不存在，此参数未指定。sprop-max-don-diff 计算如下：

```txt
sprop-max-don-diff = max{AbsDON(i) - AbsDON(j)}, 对于任意 i 且 j>i
```

其中 `i` 和 `j` 指示 NAL 单元按传输顺序的索引，且 `AbsDON` 代表 NAL 单元的解码顺序号，该值在 65535 之后未回绕到 0。换句话说，`AbsDON` 计算如下：假定 `m` 和 `n` 是传输顺序中连续的 NAL 单元。对于传输顺序中的第一个 NAL 单元(其索引为 0)，`AbsDON(0) = DON(0)`。对于其他的 NAL 单元，`AbsDON` 计算如下：

```txt
如果 DON(m) == DON(n), AbsDON(n) = AbsDON(m)

如果 DON(m) < DON(n) 且 DON(n) - DON(m) < 32768, AbsDON(n) = AbsDON(m) + DON(n) - DON(m)

如果 DON(m) > DON(n) 且 DON(m) - DON(n) >= 32768,AbsDON(n) = AbsDON(m) + 65536 - DON(m) + DON(n)

如果 DON(m) < DON(n) 且 DON(n) - DON(m) >= 32768, AbsDON(n) = AbsDON(m) - (DON(m) + 65536 - DON(n))

如果 DON(m) > DON(n) 且 DON(m) - DON(n) < 32768, AbsDON(n) = AbsDON(m) - (DON(m) - DON(n))
```

其中 `DON(i)` 是传输顺序中具有索引 `i` 的 NAL 单元的解码顺序号。解码顺序号在 5.5 节指定。

信息说明：接收者可以使用 sprop-max-don-diff 来触发接收者缓存中的哪些 NAL 单元可以传递给解码器。

#### max-rcmd-nalu-size

此参数**可**用于指示接收者能力。该参数**一定不能**用于任何其他目的。该参数的值指示接收者可以有效处理的最大 NALU 大小(单位是字节)。参数值是推荐值，而不是严格上限。发送者**可能**创建更大的 NALU，但必须意识到处理这些的花销可能比符合限制的 NALU 更高。

max-rcmd-nalu-size **必须**是 0 到 4294967295 (包括 0 和 4294967295)范围内的整数。如果未指定此参数，不存在 NALU 大小的已知限制。发送者仍然需要考虑发送者和接收者之间可用的 MTU 大小，且**应该**为此运行 MTU 发现。

例如，此参数由 IP 到 H.223 视频电话网关驱动，其中小于 H.223 传输数据单元的 NALU 将更有效。网关可以终止 IP；因此，MTU 发现通常不会在网关之外工作。

信息说明：设置此参数小于必须值可能有负面影响。

#### sar-understood

该参数可用于指示接收者能力而非其他任何东西。该参数指示接收者理解的小于 255 的 aspect_ratio_idc ([^1] 中指定)的最大值。[^1] 的表 E-1 指定 aspect_ratio_idc 等于 0 是“未指定”；1 到 16 (包括 1 和 16) 是特定的采样纵横比(Sample Aspect Ratios, SAR)；17 到 254 (包括 17 和 254) 是“保留的”；且 255 是扩展 SAR，其 SAR 宽度和 SAR 高度是明确指示的。因此，具有根据 [^1] 的解码器的接收者理解 1 到 16 (包括 1 和 16) 范围内的 aspect_ratio_idc，以及 等于 255 的 aspect_ratio_idc，从这个意义上说，接收者准确知道 SAR 是什么。对于这样的接收者，sar-understood 值为 16。将来，如果 [^1] 的表 E-1 被扩展，例如，指定 aspect_ratio_idc 等于 17 的 SAR，那么对于带有理解此扩展的解码器的接收者，sar-understood 值为 17。对于具有根据 [^1] 2003 版 解码器的接收者，sar-understood 值为 13，因为其中 aspect_ratio_idc 最小保留值为 14。

当 sar-understood 不存在时，**必须**推断该值等于 13。

#### sar-supported

该参数可用于指示接收者能力而非其他任何东西。此参数的值是 1 到 sar-understood (包括 1 和 sar-understood)范围内的整数，等于 255。sar-supported 值等于 N 小于 255 表示接收者支持所有 H.264 aspect_ratio_idc 在 1 到 N (包括 1 和 N)范围内的值对应的 SAR (见 [^1] 的表 E-1)，没有几何失真。sar-supported 值等于 255 表示接收者支持可使用两个 16 位整数值组委分子和分母表达的所有采样纵横比，即可使用 H.264 aspect_ratio_idc 值 255 (Extended_SAR, 见 [^1] 的表 E-1)表达的采样纵横比，没有几何失真。

符合 H.264 的编码器**不应该**发送等于 0 或大于 sar-understood 以及小于 255 的 aspect_ratio_idc。符合 H.264 的编码器**应该**发送 aspect_ratio_idc 使得接收者可以在没有几何失真的情况下显示它。但是，符合 H.264 的编码器**可以**选择发送使用任何 SAR 的图片。

请注意，流的实际采样纵横比或扩展采样纵横比存在时，在 sps 的视频可用性信息(Video Usability Information, VUI) 部分中传达。

#### 编码考虑

此类型只为通过 RTP ([RFC 3550](https://tools.ietf.org/pdf/rfc3550))传输定义。

#### 安全考虑

查看 [RFC 6184 第 9 节](https://tools.ietf.org/pdf/rfc6184#section-9)。

#### 公开规范

请参阅 [RFC 6184](https://tools.ietf.org/pdf/rfc6184) 及其第 17 节。

#### 附加信息

无。

#### 文件扩展

无。

#### Macintosh 文件类型代码

无。

#### 对象标识符或 OID

无。

#### 获取更多信息要联系的人员和电子邮件地址

Ye-Kui Wang, yekui.wang@huawei.com

#### 预期用途

常见。

#### 作者

Ye-Kui Wang, yekui.wang@huawei.com

#### 更改控制器

IESG 授权的 IETF 音频/视频传输工作组。

### 8.2 SDP 参数

接收者必须忽视任何此文本中未指定的参数。

#### 8.2.1 载荷类型参数到 SDP 的映射

如下将媒体类型 video/H264 字符串映射到 SDP 中的字段：

- SDP 的 `m=` 行中的媒体名称**必须**是 `video`。
- SDP 的 `a=rtpmap` 行中的编码名称**必须**是 `H264`(媒体子类型)。
- SDP 的 `a=rtpmap` 行中的时钟频率**必须**是 `90000`。
- 可选的参数 profile-level-id、max-recv-level、max- mbps、max-smbps、max-fs、max-cpb、max-dpb、max-br、redundant-pic-cap、use-level-src-parameter-sets、in-band-parameter-sets、level-asymmetry-allowed、packetization-mode、sprop-interleaving-depth、sprop-deint-buf-req、deint-buf-cap、sprop-init-buf-time、sprop-max-don-diff、max-rcmd-nalu-size、sar-understood 和 sar-supported 存在时，**必须**包含在 SDP 的 `a=fmtp` 行。这些参数表示为媒体类型字符串，形式为分号分隔的`参数=值`对的列表。
- 可选的参数 sprop-parameter-sets 和 sprop-level-parameter-sets 存在时，**必须**包含在 SDP 的 `a=fmtp` 行，或使用 [^9] 的 6.3 节所指定的 `fmtp` 源属性传输。对于特定的媒体格式(即 RTP 载荷类型)，sprop-parameter-sets 和 sprop-level-parameter-sets **不能**同时包含在 SDP 的 `a=fmtp` 行，或使用 `fmtp` 源属性传输。当包含在 SDP 的 `a=fmtp` 行中时，这些参数表示为媒体类型字符串，形式为分号分隔的`参数=值`对的列表。当使用 `fmtp` 源属性传输时，这些参数只与给定的源和载荷类型关联，作为 `fmtp` 源属性的一部分。

信息说明：使用 `fmtp` 源属性传输 sprop-parameter-sets 和 sprop-level-parameter-sets 允许在类似 Topo-Video-switch-MCU [^29] 的拓扑中带外传输参数。

以下是 SDP 中媒体表示的一个示例(基线配置，Level 3.0，可能不遵循主配置的一些限制)：

```txt
m=video 49170 RTP/AVP 98
a=rtpmap:98 H264/90000
a=fmtp:98 profile-level-id=42A01E;
          packetization-mode=1;
          sprop-parameter-sets=<parameter sets data>
```

#### 8.2.2 与 SDP Offer/Answer 模型一起使用

当在 Offer/Answer 模型 [^8] 中使用 SDP 通过 RTP 提供 H.264，用于协商单播，适用以下限制和规则：

- 标识 H.264 媒体格式配置的参数是 profile-level-id 和 packetization-mode。浙西媒体格式配置参数(除了 profile-level-id 的 level 部分)**必须**对称使用；也就是说，answerer **必须**要么维护所有配置参数，要么如果不支持其中一个或多个参数值时，**必须**完全移除媒体格式(载荷类型)。请注意，profile-level-id 的 level 部分包含 level_idc，以及 profile-iop 第 4 位(当 Profile_idc 等于 66、/7 或 88 时用于 Level 1b 指示)。profile-level-id 的 level 部分是可变的。

    信息说明：对称使用的要求不适用 profile-level-id 的 level 部分，也不适用其他流属性和能力参数。

    信息说明：在 H.264 [^1] 中，除了 Level 1b 的所有 level 等于 level_idc 值除以 10。Level 1b 是高于 Level 1.0 但低于 Level 1.1 的 level，并且以特定方式指示，因为该 level 是在 Level 1.0 和 Level 1.1 之后指定的。对于基线配置、主配置和扩展配置(profile_idc 分别等于 66、77 和 88)， 通过 level_idc 等于 11 (即和 Level 1.1 相同)且 constraint_set3_flag 等于 1 指示 Level 1b。对于其他配置，通过 level_idc 等于 9 (但是请注意，Level 1b 对于这些配置仍然高于 Level 1 但低于 Level 1.1，而 Level 1 的 level_idc 等于 10)指示 Level 1b。在 SDP Offer/Answer 中，某个 offer 的 anser 可能指示 level 等于或小于 offer 中指示的 level。由于 Level 1b 的特定指示方式，当 profile_idc 等于 66、77 或 88 且 level_idc 等于 11 时，offerer 和 answerer 必须检查参数 profile-level-id 的中间 8 位字节的第 4 位(constraint_set3_flag)。

  为了简化这些配置的处理和映射，offer 内使用的同一 RTP 载荷类型编号也应该在 answer 中使用，正如 [^8] 中指定。除非配置和 offer 中的完全相同，否则 answer **不能**包含 offer 内使用的载荷类型编号。

    信息说明：当 offerer 收到 answer 时，它需要基于媒体类型(即 video/H264)，将 offer 中未声明的载荷类型和上述媒体参数与其已经声明的任何载荷类型进行对比。这将使其能够确定所讨论的配置是新配置，还是等同于已提供的配置，因为在 answer 中可能会使用不同的载荷类型编号。

- 当存在时，max-recv-level 参数声明接收支持的最高 level。万一 max-recv-level 不存在，接收支持的最高 level 等于 profile-level-id 的 level 部分指示的默认 level。当出现时，max-recv-level **必须**高于默认 level。
- level-asymmetry-allowed 参数指示是否允许 level 非对称。

  如果 offer 或 answer 中 level-asymmetry-allowed 等于 0 (或不存在)，不允许 level 非对称。在这种情况下，从 offerer 到 answerer 方向中使用的 level **必须**等于相反方向使用的 level，且要使用的通用 level 等于 offer 中的默认 level 和 answer 中的默认 level 的较小值。

  否则，在 offer 和 answer 中 level-asymmetry-allowed 都为 1，则允许 level 非对称。在这种情况下，offerer-to-answerer 方向中要使用的 level **必须**等于 answer 接收支持的最高 level，且 answerer-to-offerer 方向中要使用的 level **必须**等于 offer 支持接收的最高 level。

  当不允许 level 非对称时，不允许 level 升级，即 answer 中的默认 level **必须**等于或小于 offer 中的默认 level。

- sprop-deint-buf-req、sprop-interleaving-depth、sprop-max-don-diff 和 sprop-init-buf-time 参数描述 offerer 或 answerer 发送媒体格式配置的 RTP 包流的属性。这与 Offer/Answer 参数的正常用法不同：通常此类参数声明 offerer 或 answerer 可以接收的流属性。当处理 H.264 时，offerer 假定 answerer 将能接收使用正提供的配置编码的媒体。

    信息说明：以上参数适用于具有相同配置的声明实体发送的任何流；即，它们依赖于它们的来源。这些值不是绑定到载荷类型，而是在发送时可能必须应用于另一种载荷类型，因为它们适用于该配置。

- 能力参数 max-mbps、max-smbps、max-fs、max-cpb、max-dpb、max-br、redundant-pic-cap、max-rcmd-nalu-size、sar-understood 和 sar-supported **可**用于声明 offerer 或 answerer 的进一步接收能力。当方向属性是“sendonly”，且参数描述 offerer 或 answerer 接受接收流的限制时，这些参数**一定不能**存在。
- offerer 必须在交织的 H.264 流的 offer 中包含解交织缓冲区的大小，sprop-deint-buf-req。为了使 offerer 和 answerer 能够互相通知它们在接收流中的解交织缓冲区的能力，**建议**二者都包含 deint-buf-cap。对于交织流，当接收者能力未知时，还**建议**考虑提供具有不同缓存要求的多个载荷类型。
- sprop-parameter-sets 或 sprop-level-parameter-sets 参数存在时(包含在 SDP 的 `a=fmtp` 行，或使用 [^9] 的 6.3 节指定的 “fmtp” 源属性传输)，用于参数集带外传输。然而，当使用参数集带外传输时，参数集仍然**可以**附加在带内传输。

  无论 offerer-to-answerer 方向使用的是否是参数集带外传输，answerer **可以**对其正在发送的流使用参数集带外或带内传输。包含在 answer 中的参数集与包含在 offer 中的这些参数集无关，因为它们用于解码两种不同的视频流，一个是从 answerer 到 offerer 方向，另外一个用于相反方向。

  以下规则适用于 offerer-to-answerer 方向中参数集的传输。

  - offer **可以**包含 sprop-parameter-sets 和 sprop-level-parameter-sets 之一或二者都包含。如果 offer 中 sprop-parameter-sets 或 sprop-level-parameter-sets 都不存在，则只使用参数集带内传输。
  - 如果 answer 包含 in-band-parameter-sets 等于 1，则 offerer **必须**带内传输参数集。否则，以下适用。
    - 如果 offerer-to-answerer 方向中使用的 level 等于 offer 中的默认 level，以下适用

      当 offer 内的 `a=fmtp` 行包含 sprop-parameter-sets 时，answerer **必须**准备使用包含在 sprop-parameter-sets 内的参数集，用于解码传入的 NAL 单元流。

      当使用 offer 内的 “fmtp” 源属性传输 sprop-parameter-sets 时，以下适用。如果 answer 包含 use-level-src-parameter-sets 等于 1 或 “fmtp” 源属性，answerer **必须**准备使用包含在 sprop-parameter-sets 内的参数集，用于解码传入的 NAL 单元流；否则，offerer **必须**带内传输参数集。

      当 offer 中不存在 sprop-parameter-sets 时，offerer **必须**带内传输参数集。

      当 offer 中存在 sprop-level-parameter-sets (包含在 `a=fmtp` 行或使用 “fmtp” 源属性传输)时，answerer **必须**忽视 sprop-level-parameter-sets。
    - 否则，offerer-to-answerer 方向中使用的 level 不等于 offer 中的默认 level，以下适用

      当 offer 中存在 sprop-parameter-sets (包含在 `a=fmtp` 行或使用 “fmtp” 源属性传输)时，answerer **必须**忽视 sprop-parameter-sets。

      当 use-level-src-parameter-sets 不等于 1，且 answer 中不存在 “fmtp” 源属性时，answerer **必须**忽视 sprop-level-parameter-sets，当 offer 内存在时，且 offerer **必须**带内传输参数集。

      当 use-level-src-parameter-sets 不等于 1，且 answer 中不存在 “fmtp” 源属性时，answerer **必须**准备使用包含在接受 level(即 answer 中的默认 level) 的 sprop-level-parameter-sets 内的参数集，当 offer 内存在时，answerer **必须**准备使用包含在 sprop-level-parameter-sets 内的参数集用于解码传入的 NAL 单元流，并忽略 sprop-level-parameter-sets 内包含的所有其他参数。

      当 offer 内 sprop-level-parameter-sets 中不存在 offerer-to-answerer 方向中使用的 level 的参数集时，offerer **必须**带内传输参数集。

  以下规则适用于 answerer-to-offerer 方向中参数集的传输。

  - answer **可以**包含 sprop-parameter-sets 或 sprop-level-parameter-sets，但是**不能**包含两者。如果 answer 中二者都不存在，则只使用带内参数集传输。
  - 如果 offer 包含 in-band-parameter-sets 等于 1，answerer **不能**在 answer 中包含 sprop-parameter-sets 或 sprop-level-parameter-sets，且**必须**带内传输参数集。否则，以下适用。
    - 如果 answerer-to-offerer 方向中使用的 level 等于 answer 中的默认 level，以下适用

      当 answer 内的 `a=fmtp` 行包含 sprop-parameter-sets 时，offerer **必须**准备使用包含在 sprop-parameter-sets 内的参数集，用于解码传入的 NAL 单元流。

      当使用 answer 内的 “fmtp” 源属性传输 sprop-parameter-sets 时，以下适用。如果 offer 包含 use-level-src-parameter-sets 等于 1 或 “fmtp” 源属性，offerer **必须**准备使用包含在 sprop-parameter-sets 内的参数集，用于解码传入的 NAL 单元流；否则，answerer **必须**带内传输参数集。

      当 answer 中不存在 sprop-parameter-sets 时，answerer **必须**带内传输参数集。

      当 answer 中存在 sprop-level-parameter-sets (包含在 `a=fmtp` 行或使用 “fmtp” 源属性传输)时，offerer **必须**忽视 sprop-level-parameter-sets。
    - 否则，answerer-to-offerer 方向中使用的 level 不等于 answer 中的默认 level，以下适用

      当 answer 中存在 sprop-parameter-sets (包含在 `a=fmtp` 行或使用 “fmtp” 源属性传输)时，offerer **必须**忽视 sprop-parameter-sets。

      当 use-level-src-parameter-sets 不等于 1，且 offer 中不存在 “fmtp” 源属性时，offerer **必须**忽视 sprop-level-parameter-sets，当 offer 内存在时，且 answerer **必须**带内传输参数集。

      当 use-level-src-parameter-sets 不等于 1，且 offer 中不存在 “fmtp” 源属性时，offerer **必须**准备使用包含在 answerer-to-offerer 方向中使用的 level 的参数集，当 answer 内存在时，offerer **必须**准备使用包含在 sprop-level-parameter-sets 内的参数集用于解码传入的 NAL 单元流，并忽略 sprop-level-parameter-sets 内包含的所有其他参数。

      当 answer 内 sprop-level-parameter-sets 中不存在 answerer-to-offerer 方向中使用的 level 的参数集时，answerer **必须**带内传输参数集。

  当使用 [^9] 的 6.3 节指定的 “fmtp” 源属性传输 sprop-parameter-sets 或 sprop-level-parameter-sets 时，参数的接收者**必须**存储包含在接受 level 的 sprop-parameter-sets 或 sprop-level-parameter-sets 内的参数集，并将其关联到作为 “fmtp” 源属性的一部分给出的源。与一个源关联的参数集**必须**只用于解码来自同一源的 RTP 包流中传输的 NAL 单元。当使用此机制时，SSRC 冲突检测和解决必须按照 [^9] 中指定的执行。

    信息说明：使用 “fmtp” 源属性传输 sprop-parameter-sets 和 sprop-level-parameter-sets 可用于类似 Topo-Video-switch-MCU [^29] 的拓扑，以便可以带外传输参数集。

对于通过多播发送的流，以下规则适用：

- 媒体格式配置通过 profile-level-id (包括 level 部分) 和 packetization-mode 标识。这些媒体格式配置参数(包含 profile-level-id 的 level 部分)**必须**对称使用；也就是说，answerer **必须**要么维护所有配置参数，要么完全移除媒体格式(载荷类型)。请注意，这意味着在多播中，Offer/Answer 的 profile-level-id 的 level 部分是不可变的。

  为了简化这些配置的处理和匹配，offer 中使用的同一 RTP 载荷类型编号**必须**也在 answer 中使用，正如 [^8] 指定。除非与 offer 内的配置相同，answer **一定不能**包含 offer 中的载荷类型编号。

- 接收的参数集**必须**关联到原始源，且**必须**只用于解码来自同一源传入的 NAL 单元流。
- 只要遵循以上规则，其他参数的规则和以上单播中的规则相同。

表 6 列举了**必须**用于不同方向属性的所有媒体类型参数的解释。

表 6——不同方向属性参数的解释

| 参数 | sendrecv | recvonly | sendonly |
| --- | --- | --- | --- |
| profile-level-id | C | C | P |
| max-recv-level | R | R | - |
| packetization-mode | C | C | P |
| sprop-deint-buf-req | P | - | P |
| sprop-interleaving-depth | P | - | P |
| sprop-max-don-diff | P | - | P |
| sprop-init-buf-time | P | - | P |
| max-mbps | R | R | - |
| max-smbps | R | R | - |
| max-fs | R | R | - |
| max-cpb | R | R | - |
| max-dpb | R | R | - |
| max-br | R | R | - |
| redundant-pic-cap | R | R | - |
| deint-buf-cap | R | R | - |
| max-rcmd-nalu-size | R | R | - |
| sar-understood | R | R | - |
| sar-supported | R | R | - |
| in-band-parameter-sets | R | R | - |
| use-level-src-parameter-sets | R | R | - |
| level-asymmetry-allowed | O | - | - |
| sprop-parameter-sets | S | - | S |
| sprop-level-parameter-sets | S | - | S |

说明：

- C: 接收和发送流的配置
- O: Offer/Answer 模式
- P: 要发送流的属性
- R: 接收者能力
- S: 带外参数集
- -: 不可用(存在时**应该**被忽略)

用于声明接收者能力的参数一般是可降级的；也就是说，它们表达了发送者可能行为的上界。因此，发送者**可以**选择设置其编码器只使用这些参数较小或相等的值。

声明配置点的参数是不可更改的，除了单播使用的 profile-level-id 参数的 level 部分。

当声明发送者的能力且此声明中使用不可降级的参数，则这些参数表达发送者接收流的可接受配置。为了达到高互操作性水平，通常建议提供多个可选配置，例如用于打包模式。不可能在单个载荷类型内提供多个配置。因此，当提供多个配置时，每个 offer 都需要其自己的与 offer 关联的 RTP 载荷类型。

接收者**应该**理解所有媒体类型参数，即使它只支持载荷格式功能的一个子集。这确保接收者可以理解何时接收媒体的 offer 可以降级到 offer 的接收者可以支持的内容。

answerer **可以**使用额外的媒体格式配置扩展 offer。但是，为了能够使用它们，在大多数情况下，需要 offerer 的第二个 offer 以提供媒体发送者将使用的流属性参数。这也具有这样的效果，即 offerer 必须可以接收这种媒体格式配置，而不仅仅是发送它。

如果 offerer 希望发送和接收之间有非对称能力，该 offerer 可以通过 level-asymmetry-allowed 等于 1 允许非对称 level。或者，offerer 可以提供不同 RTP 会话，即分别声明为 “recvonly” 和 “sendonly” 的媒体行。这可能对系统有进一步影响，且可能需要额外的外部语义来关联两个媒体行。

#### 8.2.3 声明性会话描述中使用

当在声明性风格中使用 sdp 提供通过 RTP 的 H.264 时，正如在实时流协议(Real Time Streaming Protocol, RTSP) [^27] 或会话通知协议(Session Announcement Protocol, SAP) [^28] 中，需要以下考虑。

- 可以指示流属性和接收者能力的所有参数都用于只指示流属性。例如，在这种情况下，profile-level-id 参数只声明流使用的值，而非接收流的能力。这样的结果是**必须**使用以下参数解释：

  声明实际配置或流属性：

  - profile-level-id
  - packetization-mode
  - sprop-interleaving-depth
  - sprop-deint-buf-req
  - sprop-max-don-diff
  - sprop-init-buf-time

  参数集带外传输：

  - sprop-parameter-sets
  - sprop-level-parameter-sets

  不可用(存在时**应该**将其忽略)：

  - max-mbps
  - max-smbps
  - max-fs
  - max-cpb
  - max-dpb
  - max-br
  - max-recv-level
  - redundant-pic-cap
  - max-rcmd-nalu-size
  - deint-buf-cap
  - sar-understood
  - sar-supported
  - in-band-parameter-sets
  - level-asymmetry-allowed
  - use-level-src-parameter-sets

- SDP 的接收者需要支持所有参数以及这些参数提供的值；否则，接收者**必须**拒绝(RTSP)或不参与(SAP)会话。预期由接收应用程序支持的值的使用取决于会话的创建者。

### 8.3 示例

预期双方都接收和发送的 SDP Offer/Answer 交换可能如下所示。仅显示 SDP 特定于媒体编解码的部分。由于文本限制，一些行被换行。

  ```txt
  Offerer -> Answerer SDP 消息:

  m=video 49170 RTP/AVP 100 99 98
  a=rtpmap:98 H264/90000
  a=fmtp:98 profile-level-id=42A01E; packetization-mode=0;
    sprop-parameter-sets=<parameter sets data#0>
  a=rtpmap:99 H264/90000
  a=fmtp:99 profile-level-id=42A01E; packetization-mode=1;
    sprop-parameter-sets=<parameter sets data#1>
  a=rtpmap:100 H264/90000
  a=fmtp:100 profile-level-id=42A01E; packetization-mode=2;
    sprop-parameter-sets=<parameter sets data#2>;
    sprop-interleaving-depth=45; sprop-deint-buf-req=64000;
    sprop-init-buf-time=102478; deint-buf-cap=128000
  ```

以上 offer 展示了三种不同打包格式的相同编解码配置。载荷类型 98 表示单 NALU 模式，载荷类型 99 表示非交织模式，且载荷类型 100 表示交织模式。在交织模式的情况下，如果 answer 指示支持对载荷类型 100，则 offer 将使用的交织参数也包含在内。在所有三种情况下，当接受此配置且接收来自该 offerer 的流时，sprop-parameter-sets 参数传输 answer 所需要的初始参数集。请注意， sprop-parameter-sets 值可能对于每个载荷类型不同。

  ```txt
  Answerer -> Offerer SDP 消息:

  m=video 49170 RTP/AVP 100 99 97
  a=rtpmap:97 H264/90000
  a=fmtp:97 profile-level-id=42A01E; packetization-mode=0;
    sprop-parameter-sets=<parameter sets data#3>
  a=rtpmap:99 H264/90000
  a=fmtp:99 profile-level-id=42A01E; packetization-mode=1;
    sprop-parameter-sets=<parameter sets data#4>;
    max-rcmd-nalu-size=3980
  a=rtpmap:100 H264/90000
  a=fmtp:100 profile-level-id=42A01E; packetization-mode=2;
    sprop-parameter-sets=<parameter sets data#5>;
    sprop-interleaving-depth=60;
    sprop-deint-buf-req=86000; sprop-init-buf-time=156320;
    deint-buf-cap=128000; max-rcmd-nalu-size=3980
  ```

因为 Offer/Answer 协商覆盖了发送和接收流，offer 指示 offerer 愿意接收的确切参数，而 answer 指示 answerer 愿意接收的相同参数。在这种情况下，offerer 声明它愿意接收载荷类型 98。answerer 通过声明等价的载荷类型 97 接受它；也就是说，它对于 profile-level-id 和 packetization-mode 两个参数具有相同值(因为 packetization-mode 等于 0 且 sprop-deint-buf-req 不存在)。因为提供的载荷类型 98 被接受，answerer 需要存储包含在 `sprop-parameter-sets=<parameter sets data#0>` 中的参数集，以防 offer 最终决定使用此配置。在该 answer 中，answerer 在 `sprop-parameter-sets=<parameter sets data#3>` 中包含的参数集是如果最终使用此配置，answerer 将在其发送的流中使用的参数集。

answerer 也接受接收载荷类型 99 和 100 表示的两种配置。再一次，answerer 需要存储包含在 `sprop-parameter-sets=<parameter sets data#1>` 和 `sprop-parameter-sets=<parameter sets data#2>` 中的参数集，以防 offer 最终决定使用这两种配置中的一种。answerer 为 answer-to-offerer 方向提供初始参数集，即在 `sprop-parameter-sets=<parameter sets data#4>` 和 `sprop-parameter-sets=<parameter sets data#5>` 中分别用于载荷类型 99 和 100 的参数集，是 answerer 发送该载荷类型将会使用的参数集。answerer 还通过提供 deint-buf-cap 参数给 offerer 提供其关于解交织操作的内存限制。只有 offerer 决定生成第二个 offer 这才会有用，这样 offerer 可以考虑新值。max-rcmd-nalu-size 指示 answerer 可以高效处理大小到达 3980 字节的 NALU。但是，不能保证网络支持该大小。

在以下示例中，offer 被接受而没有 level 降级(即接受默认 level，Level 3.0)，且 sprop-parameter-sets 和 sprop-level-parameter-sets 都在 offer 中存在。answerer 必须忽视 `sprop-level-parameter-sets=<parameter sets data#1>`，并存储 `sprop-parameter-sets=<parameter sets data#0>` 中的参数集用于解码传入的 NAL 单元流。请注意，在此示例中，`sprop-parameter-sets=<parameter sets data#2>` 中的参数集必须关联到 Level 3.0。

  ```txt
  Offer SDP:

  m=video 49170 RTP/AVP 98
  a=rtpmap:98 H264/90000
  a=fmtp:98 profile-level-id=42A01E; //Baseline profile, Level 3.0
    packetization-mode=1;
    sprop-parameter-sets=<parameter sets data#0>;
    sprop-level-parameter-sets=<parameter sets data#1>

  Answer SDP:
  
  m=video 49170 RTP/AVP 98
  a=rtpmap:98 H264/90000
  a=fmtp:98 profile-level-id=42A01E; //Baseline profile, Level 3.0
    packetization-mode=1;
    sprop-parameter-sets=<parameter sets data#2>
  ```

在以下示例中，offer(基线配置，Level 1.1)被 level 降级接受(接受的 level 是 Level 1b)，且 sprop-parameter-sets 和 sprop-level-parameter-sets 都在 offer 中存在。answerer 必须忽视 `sprop-parameter-sets=<parameter sets data#0>` 以及 `sprop-level-parameter-sets=<parameter sets data#1>` 中所有不用于接受 level(Level 1b) 的参数集，且必须存储 `sprop-parameter-sets=<parameter sets data#0>` 中用于接受 level(Level 1b) 的参数集以解码传入的 NAL 单元流。offerer 必须存储 answer 中 `sprop-parameter-sets=<parameter sets data#2>` 内的参数集用于解码传入的单元流。请注意，在此示例中，`sprop-parameter-sets=<parameter sets data#2>` 中的参数集必须关联到 Level 1b。

  ```txt
  Offer SDP:

  m=video 49170 RTP/AVP 98
  a=rtpmap:98 H264/90000
  a=fmtp:98 profile-level-id=42A00B; //Baseline profile, Level 1.1
    packetization-mode=1;
    sprop-parameter-sets=<parameter sets data#0>;
    sprop-level-parameter-sets=<parameter sets data#1>

  Answer SDP:

  m=video 49170 RTP/AVP 98
  a=rtpmap:98 H264/90000
  a=fmtp:98 profile-level-id=42B00B; //Baseline profile, Level 1b
    packetization-mode=1;
    sprop-parameter-sets=<parameter sets data#2>;
    use-level-src-parameter-sets=1
  ```

在以下示例中，offer(基线配置，Level 1.1)被 level 降级接受(接受的 level 是 Level 1b)，且 sprop-parameter-sets 和 sprop-level-parameter-sets 都在 offer 中存在。但是，answerer 是老式的 [RFC 3984](https://tools.ietf.org/pdf/rfc3984) 实现，且不理解 sprop-level-parameter-sets；因此，它未在 answer 中包含 use-level-src-parameter-sets (answerer 也不理解)。因此，answerer 必须忽视 `sprop-parameter-sets=<parameter sets data#0>` 和 `sprop-level-parameter-sets=<parameter sets data#1>`，且 offerer 必须带内传输参数集。

  ```txt
  Offer SDP:

  m=video 49170 RTP/AVP 98
  a=rtpmap:98 H264/90000
  a=fmtp:98 profile-level-id=42A00B; //Baseline profile, Level 1.1
    packetization-mode=1;
    sprop-parameter-sets=<parameter sets data#0>;
    sprop-level-parameter-sets=<parameter sets data#1>
  
  Answer SDP:
  
  m=video 49170 RTP/AVP 98
  a=rtpmap:98 H264/90000
  a=fmtp:98 profile-level-id=42B00B; //Baseline profile, Level 1b
    packetization-mode=1
  ```

在以下示例中，offer 被接受而没有 level 降级，且 sprop-parameter-sets 存在 offer 中。`sprop-parameter-sets=<parameter sets data#0>` 内的参数集必须被存储并被 offerer 的编码器和 answerer 的解码器使用。answerer 是老式的 [RFC 3984](https://tools.ietf.org/pdf/rfc3984) 实现，且不理解 sprop-level-parameter-sets；因此，它未在 answer 中包含 use-level-src-parameter-sets (answerer 也不理解)。因此，answerer 必须忽视 `sprop-parameter-sets=<parameter sets data#0>` 和 `sprop-level-parameter-sets=<parameter sets data#1>`，且 offerer 必须带内传输参数集。

  ```txt
  Offer SDP:

  m=video 49170 RTP/AVP 98
  a=rtpmap:98 H264/90000
  a=fmtp:98 profile-level-id=42A00B; //Baseline profile, Level 1.1
    packetization-mode=1;
    sprop-parameter-sets=<parameter sets data#0>;
    sprop-level-parameter-sets=<parameter sets data#1>
    
  Answer SDP:
  
  m=video 49170 RTP/AVP 98
  a=rtpmap:98 H264/90000
  a=fmtp:98 profile-level-id=42B00B; //Baseline profile, Level 1b
    packetization-mode=1
  ```

在以下示例中，offer 被接受而没有 level 降级，且 sprop-parameter-sets 存在 offer 中。`sprop-parameter-sets=<parameter sets data#0>` 内的参数集必须被存储并被 offerer 的编码器和 answerer 的解码器使用，且 `sprop-parameter-sets=<parameter sets data#1>` 内的参数集必须北徐被 answerer 的编码器和 offerer 的解码器使用。请注意，`sprop-parameter-sets=<parameter sets data#0>` 基本上和 `sprop-parameter-sets=<parameter sets data#1>` 无关。

  ```txt
  Offer SDP:
  
  m=video 49170 RTP/AVP 98
  a=rtpmap:98 H264/90000
  a=fmtp:98 profile-level-id=42A01E; //Baseline profile, Level 3.0
    packetization-mode=1;
    sprop-parameter-sets=<parameter sets data#0>
  
  Answer SDP:
  
  m=video 49170 RTP/AVP 98
  a=rtpmap:98 H264/90000
  a=fmtp:98 profile-level-id=42A01E; //Baseline profile, Level 3.0
    packetization-mode=1;
    sprop-parameter-sets=<parameter sets data#1>
  ```

在以下示例中，offer 被接受而没有 level 降级，且 sprop-parameter-sets 和 sprop-level-parameter-sets 在 offer 中都不存在，意味着没有参数集带外传输，即参数集必须带内传输。

  ```txt
  Offer SDP:

  m=video 49170 RTP/AVP 98
  a=rtpmap:98 H264/90000
  a=fmtp:98 profile-level-id=42A01E; //Baseline profile, Level 3.0
    packetization-mode=1

  Answer SDP:

  m=video 49170 RTP/AVP 98
  a=rtpmap:98 H264/90000
  a=fmtp:98 profile-level-id=42A01E; //Baseline profile, Level 3.0
    packetization-mode=1
  ```

在以下示例中，offer 被 level 降级接受，且 sprop-parameter-sets 存在 offer 中。因为 `sprop-parameter-sets=<parameter sets data#0>` 包含 level-idc 指示 Level 3.0，因为 answerer 希望 Level 2.0，因此不能使用 sprop-parameter-sets，且 answerer 必须忽视它，且必须使用带内传输参数集。

  ```txt
  Offer SDP:

  m=video 49170 RTP/AVP 98
  a=rtpmap:98 H264/90000
  a=fmtp:98 profile-level-id=42A01E; //Baseline profile, Level 3.0
    packetization-mode=1;
    sprop-parameter-sets=<parameter sets data#0>

  Answer SDP:

  m=video 49170 RTP/AVP 98
  a=rtpmap:98 H264/90000
  a=fmtp:98 profile-level-id=42A014; //Baseline profile, Level 2.0
    packetization-mode=1
  ```

在以下示例中，offer 也被 level 降级接受，且 sprop-parameter-sets 和 sprop-level-parameter-sets 在 offer 或 answer 中都不存在，意味着没有参数集带外传输，即必须使用带内传输。offerer-to-answerer 方向中药使用的 level 是 Level 3.0，且 answerer-to-offerer 方向中要使用的 level 是 Level 2.0。允许 answerer 发送任何达到和包含 Level 2.0 的 level，且允许 offerer 发送任何达到和包含 Level 3.0 的 level。

  ```txt
  Offer SDP:

  m=video 49170 RTP/AVP 98
  a=rtpmap:98 H264/90000
  a=fmtp:98 profile-level-id=42A01E; //Baseline profile, Level 3.0
    packetization-mode=1

  Answer SDP:

  m=video 49170 RTP/AVP 98
  a=rtpmap:98 H264/90000
  a=fmtp:98 profile-level-id=42A014; //Baseline profile, Level 2.0
    packetization-mode=1
  ```

在以下示例中，offerer 是类似 Topo-Video-switch-MCU [^29] 的拓扑中的多点控制单元(Multipoint Control Unit, MCU)，提供接收的来自其他三个参与者(B、C 和 D)的参数集，并接收来自参与者 A 的参数集，A 是 answerer。 参与者通过其规范名称(CNAME)进行标识，该值映射到不同的 SSRC 值。所有四个参与者使用相同的编解码配置。参与者 A 存储并分别关联包含在 `<parameter sets data#B>`、`<parameter sets data#C>` 和 `<parameter sets data#D>` 中的参数集到参与者 B、C 和 D，并使用 `<parameter sets data#B>` 解码只源于参与者 B 的 RTP 包中携带的 NAL 单元，使用 `<parameter sets data#C>` 解码只源于参与者 C 的 RTP 包中携带的 NAL 单元，使用 `<parameter sets data#D>` 解码只源于参与者 D 的 RTP 包中携带的 NAL 单元，。

  ```txt
  Offer SDP:

  m=video 49170 RTP/AVP 98
  a=ssrc:SSRC-B cname:CNAME-B
  a=ssrc:SSRC-C cname:CNAME-C
  a=ssrc:SSRC-D cname:CNAME-D
  a=ssrc:SSRC-B fmtp:98
    sprop-parameter-sets=<parameter sets data#B>
  a=ssrc:SSRC-C fmtp:98
    sprop-parameter-sets=<parameter sets data#C>
  a=ssrc:SSRC-D fmtp:98
    sprop-parameter-sets=<parameter sets data#D>
  a=rtpmap:98 H264/90000
  a=fmtp:98 profile-level-id=42A01E; //Baseline profile, Level 3.0
    packetization-mode=1

  Answer SDP:

  m=video 49170 RTP/AVP 98
  a=ssrc:SSRC-A cname:CNAME-A
  a=ssrc:SSRC-A fmtp:98
    sprop-parameter-sets=<parameter sets data#A>
  a=rtpmap:98 H264/90000
  a=fmtp:98 profile-level-id=42A01E; //Baseline profile, Level 3.0
    packetization-mode=1
  ```

### 8.4 参数集考虑

H.264 参数集是视频编解码的基本部分，且对其操作是至关重要的(参阅 [1.2 节](#12-参数集概念))。由于其特性和对解码过程的重要性，丢失或错误传输参数集很难在接收端本地隐藏。引用破坏的参数集通常会对解码过程产生严重的影响。例如，由于参数集 NAL 单元的错误传输或丢失以及参数集更新的不及时传输，都会发生破坏。参数集更新是指 pps 或 sps 内的至少一个参数发生改变，而 pps 或 sps 标识保持不变。因此，为 RTP 发送者实现提供以下建议作为指南。

可使用三种不同原则传输参数集 NALU：

A. 在实际 RTP 会话之前使用会话控制协议(带外)
B. 在持续存在的 RTP 会话期间使用会话控制协议(带外)
C. 在持续存在的 RTP 会话期，在载荷(带内)内的 RTP 包流中

建议在会话控制协议内实现原则 A 和 B。可使用 SDP Offer/Answer 模型以及此文的前一节中所述的 SIP 和 SDP。[8.2.2 节](#822-与-sdp-offeranswer-模型一起使用)包含详细的关于带内或带外传输参数集，在 SDP Offer/Answer 中使用媒体类型参数 sprop-parameter-sets、sprop-level-parameter-sets、use-level-src-parameter-sets 和 in-band-parameter-sets。本节包含对如何在会话控制协议内实现原则 A 和 B 的指南。通过此规范中定义的 RTP 载荷格式支持原则 C。在类似 Topo-Video-switch-MCU [^29] 的拓扑中可以期望使用原则 C。

如果使用参数集的带内信令，**应**使用一种可靠的 RTP 分发方法在 RTP 载荷中传输 pps 和 sps NALU，因为任一类型的参数集丢失将可能阻止对相应 RTP 包流的相当一部分进行解码。

如果使用参数集的带内信令，发送者**应该**考虑错误特性并使用机制为正确分发参数集提供高可能性。增加正确接收可能性的机制包括包重复、FEC 和重发。使用不可靠的带外控制协议与带内信令(可能丢失)有相似的缺点，且除此以外，可能也导致同步的困难性(见下文)。因此，**不建议**使用。

在会话声明周期内**可**使用原则 B 和 C 增加或更新参数集。要求参数集引用它们的 NAL 单元之前存在于解码器中。参数集的增加或更新可导致进一步的问题；因此，应考虑以下建议。

- 当增加或更新参数集时，**应该**仔细确保参数集在其使用之前被发送。当增加新参数集时，使用之前未使用的参数集标识符。带外信令和带内流量之间不存在同步是很常见的。如果使用带外信令，**建议**发送者在确认来自信令协议的分发之前，不要开始发送需要添加或更新的参数集的 NALU。
- 当更新参数集时，应该考虑一下同步问题。当在接收者重写参数集时，发送者必须确保网络或接收者缓存中存在的 NALU 都不需要正在讨论的参数集。否则，可能会使用错误参数集解码。为了减少此问题，建议或者只重写那么足够长时间未使用的参数集(以确保所有相关的 NALU 已经被消费)，或者增加新的参数集(这可能对视频编码的效率产生负面影响)。

    信息说明：在一些类似 Topo-Video-switch-MCU [^29] 的拓扑中，整个参数集集合的来源可能来自多个可能使用不唯一参数标识符的源。在这种情况下，如果不存在支持带娃通道中参数集唯一性的其他机制，则 offer 可能重写现有的参数集。

- 在多方会话中，只要有可能，一方**必须**将来自不同源的参数集关联到源标识符，例如，通过传输带外传输的参数集，因为不同源通常使用独立的参数集标识符值空间。
- 通过在同一 RTP 会话中使用原则 B 和 C 增加或修改参数集，由于控制和 RTP 通道之间缺少同步可能导致参数集的不一致。因此，除非提供足够的同步，**一定不能**在同一会话中同时使用原则 B 和 C。

在一些场景(例如，当只使用此载荷格式规范对应 H.241 的子集时)或拓扑中，不可能使用带外参数集传输。在这种强开下，参数集必须带内传输。这里，比特流内与非参数集数据的同步是隐式的，但是需要考虑丢失的可能性。应该使用上面讨论的机制降低丢失的可能性。万一检测到参数集丢失，可以使用解码器刷新点(Decoder Refresh Point)程序实现恢复，例如，使用 RTCP 反馈 Full Intra Request(FIR) [^30]。[8.5 节](#85-使用带内传输参数集的解码器刷新点程序信息性)提供两个解码器刷新点程序。

- 当最初使用原则 A 提供参数集，然后带内增加或更新(原则 C)，则存在于更新带外传递的参数集相关联的风险。如果接收者错过一些带内更新(例如，由于丢失或延迟调入)，这些接收者尝试使用过期的参数解码比特率。因此**建议**分隔带外和带内参数集之间的参数集 ID。

### 8.5 使用带内传输参数集的解码器刷新点程序(信息性)

当发送者使用根据 [^1] 的视频编码器，接收到解码器刷新点请求时，编码器应该使用 8.5.1 或 8.5.2 节指定的程序之一进入快速更新模式。[8.5.1 节](#851-回复解码器刷新点请求的-idr-程序)的程序是无损传输环境中的首选响应。两种程序都满足进入 H.264 视频编码快速更新模式的要求。

#### 8.5.1 回复解码器刷新点请求的 IDR 程序

本节为回复解码器刷新点请求给出一种可能方法。

编码器应该按照这里显示的顺序：

1. 立即准备发送一个 IDR 图片。
2. 发送要发送的 IDR 图片将使用的 sps。编码器还可以选择发送其他 sps。
3. 发送要发送的 IDR 图片将使用的 pps。编码器还可以选择发送其他 pps。
4. 发送该 IDR 图片。
5. 从这个时间点往前，在任何 NAL 单元引用发送任何其他此程序中还没有发送的 sps 或 pps，在其被任何 NAL 单元引用之前，无论在接收解码器刷新点的请求之前是否发送过这些参数集。根据需要，可以批量发送、一次发送一个或以这两种方式的任意组合发送此类参数集。可以随时重新发送参数集以实现冗余。应注意何时存在参数集更新，正如上面 [8.4 节](#84-参数集考虑)所述。

#### 8.5.2 回复解码器刷新点请求的逐步恢复程序

本节为回复解码器刷新点请求给出另外一种可能方法。

编码器应该按照这里显示的顺序：

1. 发送一个恢复点 SEI 消息(查看 [^1] 的 D.1.7 和 D.2.7 节)
2. 重复在恢复点 SEI 消息之前发送的任何 sps 和 pps，在其被 NAL 单元引用之前。

假设从现在开始的传输是无差错的，编码器应该确保解码器可以访问所有参考图片，用于对在恢复点或恢复点之后的图片按输出顺序进行帧间预测，恢复点由恢复点 SEI 消息指示。

恢复点 SEI 消息中的 recovery_frame_cnt 语法元素的值应该足够小，以确保快速恢复。

根据需要，可以批量发送、一次发送一个或以这两种方式的任意组合发送此类参数集。应注意何时存在参数集更新，正如上面 [8.4 节](#84-参数集考虑)所述。

## 9 安全考虑

使用此规范中定义的载荷格式的 RTP 包受制于 RTP 规范 [^5] 和任何适合的 RTP 配置(例如，[^16])中讨论的安全考虑。这意味着通过加密达到媒体流的保密性，例如通过 SRTP [^26] 应用。因为与此载荷格式使用的数据压缩是端到端应用的，任何加密需要在压缩之后执行。使用具有非一致接收端计算负载的压缩技术的数据编码存在潜在的拒绝服务威胁。攻击者可以将病态数据报注入到解码复杂的流中，从而导致接收者过载。H.264 特别容易受到此类攻击，因为可以非常简单构造出包含 NAL 单元的数据报，这些 NAL 单元影响许多未来的 NAL 单元的解码过程。因此，**建议**至少使用 RTP 包的数据源身份验证和数据完整性保护，例如使用 SRTP [^26]。

请注意，确保 RTP 包及其载荷的保密性和完整性的合适机制非常依赖应用和传输以及采用的信令协议。因此，虽然以上给出 SRTP 作为示例，但是存在其他可能的选择。

解码器在处理用户数据 SEI 消息时**必须**小心谨慎，尤其是当这些消息包含活动元素时，且**必须**将它们的适用范围限制为包含流的演示。

具有身份验证、完整性或机密性保护的端到端安全性将阻止 MANE 执行媒体感知操作，而不是丢弃完整的包。在机密性保护的情况下，它甚至可以防止以媒体感知的方式丢弃数据包。为了被允许执行其操作，要求 MANE 是包含在安全上下文建立中的可信实体。

## 10 拥塞控制

RTP 的拥塞控制**应**根据 [RFC 3550](https://tools.ietf.org/pdf/rfc3550) [^5] 和任何适用的 RTP 配置使用，例如 [RFC 3551](https://tools.ietf.org/pdf/rfc3551) [^16]。如果正在使用尽力而为服务，则附加要求这种载荷的用户**必须**监控包丢失，以确保包丢失率在可接受的参数范围内。如果 TCP 流通过同一网络路径并经历相同的网络条件，在合理的时间尺度上测量的平均吞吐量不低于 RTP 流达到的吞吐量，则认为包丢失是可以接受的。可以通过实现拥塞控制机制来调整传输速率(或分层多播会话订阅的层数)或通过安排接收者在丢失率高得无法接受的情况下离开会话来满足此条件。

当使用实时编码时，很容易实现遵守拥塞控制原则所需的比特率自适应。然而，当传输预先编码的内容时，带宽自适应需要访问相同内容不同比特率的多种编码表示，或者比特流中存在非参考图片或子序列 [^22]。不同表示之间的切换通常可以在同一 RTP 会话中执行，例如，通过采用称为扩展配置的 SI/SP切片的概念或通过在 IDR 图片边界切换流。只有当不可降级的参数(例如 profile/level ID 的配置部分)需要更改时，才需要终止和重启媒体流。这可以通过使用不同的 RTP 载荷类型来实现。

MANE **可以**遵循 [7.3 节](#73-附加的解包指南)中概述的建议，并在流由于先前的包丢失而损坏时从包流中删除某些不可用的包。这有助于在某些特殊情况下减少网络负载。

## 11 IANA 考虑

[RFC 3984](https://tools.ietf.org/pdf/rfc3984) 指定的 H264 媒体子类型名称已按照本文 [8.1 节](#81-媒体类型注册)中的定义进行更新。

## 12 信息性附录：应用示例

此载荷规范的使用非常灵活，以涵盖 H.264 预期的极其广泛的应用空间。然而，这种巨大的灵活性也使得实施者难以决定合理的打包方案。在不久的将来，有关如何将此规范应用于现实世界场景的一些信息可能会以学术出版物和测试模型软件和描述的形式出现。但是，这里也描述了一些初步的使用场景。

### 12.1 根据 ITU-T H.241 建议附件 A 的视频电话

使用 H.264 作为可选视频压缩方案的基于 H.323 的视频电话系统需要支持 H.241 [^3] 的附件 A 作为打包方案。此附件中定义的打包机制在技术上与本规范的一个小子集相同。

当系统根据 H.241 的附件 A 运行时，参数集 NAL 单元在带内发送。仅使用单 NAL 单元数据包。许多这样的系统不定期发送 IDR 图片，而是仅在用户交互或控制协议方式需要时，例如在多点控制单元中的视频通道之间切换或反馈请求错误恢复时。

### 12.2 视频电话，无切片数据分区，无 NAL 单元聚合

已实现和测试(尽管不是控制协议部分；见下文)该方案的 RTP 部分。

在大多数现实世界的视频电话应用程序中，图像大小或可选模式等图像参数在连接的生命周期内永远不会改变。因此，所有必要的参数集(通常只有一个)作为能力交换/通知过程的副作用发送，例如，根据本文档 [8.2 节](#82-sdp-参数)中指定的 SDP 语法。由于在 RTP 会话开始之前建立了所有必要的参数集信息，因此不需要发送任何参数集 NAL 单元。也不使用切片数据分区。因此，RTP 包流基本上由携带单个编码切片的 NAL 单元组成。

编码器选择编码切片NAL 单元的大小，以便它们提供最佳性能。通常，这是通过使编码切片大小适应 IP 网络的 MTU 大小来完成的。对于小图片尺寸，这可能导致每包一张图片的策略。内部刷新算法清除数据包丢失和由此产生的与漂移相关的伪影。

### 12.3 视频电话，使用 NAL 单元聚合的交织打包

此方案允许更好的错误隐藏，并用于使用 [RFC 4629](https://tools.ietf.org/pdf/rfc4629) 打包的基于 H.263 的设计 [^11]。它已经被实现，且报告结果良好 [^13]。

VCL 编码器对源图片进行编码，以便将一 MB 行的所有宏块(MB)分配给一个切片。所有具有偶数 MB 行地址的切片合并为一个 STAP，所有具有奇数 MB 行地址的切片合并为另一个切片。这些 STAP 作为 RTP 包传输。如上所述执行参数集的建立。

请注意，此处使用 STAP 是必不可少的，因为大量单个切片(通用中间格式(CIF)图片为 18 个)将导致无法接受的高 IP/UDP/RTP 头部开销(除非使用源编码工具 FMO，在这种情况下不假设)。此外，一些无线视频传输系统，如 H.324M 和 3GPP 中规定的基于 IP 的视频电话，可能使用相对较小的传输包大小。例如，H.223 AL3 SDU 的典型 MTU 大小约为 100 字节 [^17]。根据这种打包方案对单独的切片进行编码在有线和无线网络之间的通信中提供了进一步的优势，因为单独的切片可能小于无线系统的优选最大分组大小。因此，网关可以将有线网络中使用的 STAP 转换为只有一个 NAL 单元的多个 RTP 数据包，这在无线网络中是首选，反之亦然。

### 12.4 带数据分区的视频电话

已实现并证明此方案具有良好的性能，尤其是在较高的丢包率时 [^13]。

众所周知，数据分区只有在某种形式的不平等错误保护可用时才有用。通常，在单会话 RTP 环境中，甚至会假设错误特征；即该会话所有包的丢包概率在统计上是相同的。但是，有一些方法可以降低 RTP 会话中单个数据包的丢包概率。例如，根据 [RFC 5109](https://tools.ietf.org/pdf/rfc5109) [^18] 的 FEC 数据包指定哪些媒体包与 FEC 包相关联。

在所有情况下，所产生的开销都是相当大的，但与原本用于帧内信息的比特数处于相同的数量级。但是，这种机制不会给系统增加任何延迟。

再次，完整的参数集建立是通过控制协议方法进行的。

### 12.5 带有 FU 和前向纠错的视频电话或流

已实现并证明此方案具有良好的性能，尤其是在较高的丢包率下 [^19]。

在重传不适用的情况下，解决包丢失最有效的方法是前向纠错(FEC)。尽管应用层、端到端 FEC 使用通常比基于 FEC 的单个链路保护(尤其是当传输路径中具有不同特性的链路时)效率低，但在某些情况下应用层、端到端 FEC 是不可避免的。 [RFC 5109](https://tools.ietf.org/pdf/rfc5109) [^18] 提供了在丢包环境中使用通用、应用层、端到端 FEC 的方法。二进制前向纠错码是通过对不同包中相同位位置的位进行异或运算而产生的。二进制码可以由参数 `(n,k)` 指定，其中 `k` 为连接使用的信息包数，`n` 为 `k` 个信息包产生的总包数；即为 `k` 个信息包产生 `n-k` 个奇偶校验包。

当代码与 [RFC 5109](https://tools.ietf.org/pdf/rfc5109) 框架内的参数 `(n,k)` 一起使用时，以下属性是众所周知的：

a) 如果应用于一个 RTP 包，[RFC 5109](https://tools.ietf.org/pdf/rfc5109) 仅提供包重复。
b) 如果 XOR 连接的包长度相等，则 [RFC 5109](https://tools.ietf.org/pdf/rfc5109) 的比特率最高效。
c) 在丢包概率 `p` 相同和 `k` 固定的情况下，`n` 值越大，残差概率越小。例如，对于 10% 的丢包概率，`k=1`，`n=2`，残差概率约为 1%，而对于 `n=3`，残差概率约为 0.1%。
d) 在丢包概率 `p` 相同、码率 `k/n` 固定的情况下， n  值越大，残差概率越小。例如，在丢包概率为 `p=10%`、`k=1` 且 `n=2` 时，残差率约为 1%，而对于 `k=12` 且 `n=24` 的扩展 Golay 码，残差率率约为 0.01%。

为了在不使用 FU 的情况下将 [RFC 5109](https://tools.ietf.org/pdf/rfc5109) 与 H.264 基线编码视频结合使用，可以考虑以下几种选择：

1) 视频编码器生成 NAL 单元，每个视频帧都编码在单个切片中。应用 FEC，可以使用简单的代码，例如 `(n=2, k=1)`。也就是说，每个 NAL 单元基本上都会重复。缺点显然是根据上面的 `d)` 代码性能较差，并且灵活性低，因为只能使用 `(n, k=1)` 代码。
2) 视频编码器生成 NAL 单元，每个视频帧都编码在一个或多个连续切片中。应用 FEC，可以在一系列 NAL 单元上使用更好的代码，例如 `(n=24, k=12)`。根据每帧的 RTP 包数，丢失可能会导致显著延迟，当每帧使用更多 RTP 包时，延迟会减少。也可能连接完全不同长度的包，这会根据上述 `b)` 降低比特率效率。然而，小心一点，对于 1 kb 或更大的切片，可能会产生相似的长度(100-200 字节差异)，这不会灾难性地降低位效率。
3) 视频编码器生成 NAL 单元，其中某个帧包含 k 个长度可能几乎相等的切片。然后，应用 FEC，可以在每个帧的 NAL 单元序列上使用更好的代码，例如 `(n=24, k=12)`。与上面的 `2)` 相比，延迟可能会减少，但几个缺点是显而易见的。首先，编码视频的编码效率显著降低，因为切片结构编码减少了帧内预测并且需要额外的切片开销。其次，预编码的内容，或者当通过网关运行时，视频通常没有被适当地编码为 k 个切片，以便可以应用 FEC。最后，产生 k 个等长切片的视频编码并不简单，可能需要多次编码。

通过将 FU 与 FEC 结合使用，可以避免许多提到的缺点。每个 NAL 单元可以拆分成任意数量的长度基本相等的 FU；因此，即使编码器不努力生成相同长度的切片，也可以应用具有合理 `k` 和 `n` 的 FEC。例如，可以将包含整个帧的编码切片NAL 单元拆分为 `k` 个 FU，并且可以应用奇偶校验码 `(n=k+1, k)`。但是，这有一个缺点，除非可以恢复所有创建的片段，否则整个切片都会丢失。因此，与将帧分成多个切片的情况相比，丢失了更大的部分。

即使不存在额外的源编码层冗余(例如周期性帧内帧)，所呈现的技术也能够实现良好的传输容错。因此，相同的编码视频序列可用于实现无差错传输和易错网络传输的最大压缩效率和质量。此外，该技术允许将 FEC 应用于预编码序列而不增加延迟。在这种情况下，没有为易错网络编码的预编码序列仍然可以几乎可靠地传输，而不会增加大量延迟。此外，长度相等的 FU 会导致 [RFC 5109](https://tools.ietf.org/pdf/rfc5109)比特率的有效使用 。

如果错误概率取决于传输包的长度(例如，在移动传输的情况下 [^15])，则将 FU 与 FEC 结合使用的好处更加明显。基本上，FU 大小的灵活性允许对每个 NAL 单元应用适当的 FEC 以及 NAL 单元的不平等错误保护。

当使用 FU 和 FEC 时，产生的开销很大，但与不应用 FEC 时帧内编码宏块必须花费的比特数处于同一数量级。在 [^19] 中，表明在使用相同的错误率和相同的总体比特率(包括开销)时，基于 FEC 的方法的整体性能提高了质量。

### 12.6 低比特率流

此方案已在 H.263 和非标准 RTP 打包中实现，并取得了良好的效果 [^20]。H.264 无法实现类似的良好结果没有技术原因。

在当今的 Internet 流中，一些提供的比特率相对较低，以允许带有拨号调制解调器的终端访问内容。在有线 IP 网络中，相对较大的包(例如 500-1500 字节)，优于较小且出现更频繁的包，以减少网络拥塞。此外，大包的使用减少了 RTP/UDP/IP 头部开销的数量。对于低比特率视频，使用大包意味着有时最多应该将几张图片封装在一个包中。

然而，包含许多编码图片的包丢失会对视觉质量产生严重影响，因为除了重复前一张图片之外，几乎没有办法隐藏整个图片的丢失。构建相对较大的包，并保持成功隐藏丢失可能性的一种方法是构建包含来自多个图片交织切片的 MTAP。MTAP 不应包含来自同一图片的空间相邻切片或来自任何图片的空间重叠切片。如果丢失包，则丢失的切片很可能被同一图片空间相邻的切片和时间上之前和之后图片的空间对应切片包围。因此，隐藏丢失的切片可能相对成功。

### 12.7 视频流中的稳健数据包调度

稳健的数据包调度已通过 MPEG-4 Part 2 实现，并在无线流媒体环境中进行模拟 [^21]。使用 H.264 无法实现类似或更好的结果没有技术原因。

流客户端通常有一个接收者缓存区，能够存储相对大量的数据。最初，当建立流会话时，客户端不会立即开始播放流。相反，它通常会将传入的数据缓存几秒钟。这种缓存有助于保持连续播放，因为在偶尔增加传输延迟或网络吞吐量下降的情况下，客户端可以解码和播放缓存的数据。否则，在没有初始缓存的情况下，客户端必须冻结显示、停止解码并等待传入​​数据。对于任何协议级别的自动或选择性重传，该缓存也是必需的。如果图片的任何部分丢失，可以使用重传机制来重新发送丢失的数据。如果在预定的解码或播放时间之前接收到重传的数据，则可以完美地恢复丢失。可以根据编码图片在解码序列的主观质量中的重要性进行排序。例如，非参考图片(例如传统的 B 图片)，在主观上是最不重要的，因为它们的缺失不会影响任何其他图片的解码。除了非参考图片，ITU-T H.264 | ISO/IEC 14496-10 标准包括一种称为子序列的时间可伸缩性方法 [^22]。还可以基于编码切片数据分区或切片分组进行主观排序。主观上最重要的编码切片和编码切片数据分区可以比其解码顺序指示的更早发送，而主观上最不重要的编码切片和编码切片数据分区可以比其自然编码顺序指示的更晚发送。因此，与最不重要的切片和切片数据分区相比，最重要的切片和编码切片数据分区的任何重传部分更有可能在其调度解码或回放时间之前被接收。

## 13 信息性附录：解码顺序号的基本原理

### 13.1 介绍

引入解码顺序号(DON)概念主要是为了实现高效多图片切片交织(参见 [12.6 节](#126-低比特率流))和稳健包调度(参见 [12.7 节](#127-视频流中的稳健数据包调度))。在这两种应用中，NAL 单元都不是按解码顺序传输的。DON 表示 NAL 单元的解码顺序，应该在接收者中使用以恢复解码顺序。[13.2](#132-多图片切片交织示例) 和 [13.3 节](#133-稳健包调度示例)分别给出了用于高效多图片切片交织和稳健包调度的示例。[13.4 节](#134-冗余编码切片的鲁棒传输调度)描述了 DON 概念在通过冗余编码图像实现的错误恢复方面的好处。[13.5 节](#135-关于其他设计可能性的评论)总结了已考虑的 DON 替代方案，并说明为什么选择 DON 用于此 RTP 载荷规范。

### 13.2 多图片切片交织示例

多图片切片交织的示例如下。下面按输出顺序描述了编码视频序列的子集。R 表示参考图片，N 表示非参考图片，数字表示相对输出时间。

```txt
... R1 N2 R3 N4 R5 ...
```

这些图片从左到右的解码顺序如下：

```txt
... R1 R3 N2 R5 N4 ...
```

图片 R1、R3、N2、R5 和 N4 的 NAL 单元分别用等于 1、2、3、4 和 5 的 DON 标记。

每个参考图片由三个切片分组组成，它们分散如下(数字表示四分之一通用中间格式(QCIF)帧中每个宏块的切片分组编号)：

```txt
0 1 2 0 1 2 0 1 2 0 1
2 0 1 2 0 1 2 0 1 2 0
1 2 0 1 2 0 1 2 0 1 2
0 1 2 0 1 2 0 1 2 0 1
2 0 1 2 0 1 2 0 1 2 0
1 2 0 1 2 0 1 2 0 1 2
0 1 2 0 1 2 0 1 2 0 1
2 0 1 2 0 1 2 0 1 2 0
1 2 0 1 2 0 1 2 0 1 2
```

简单起见，我们假设一个切片分组的所有宏块都包含在一个切片中。由三个连续的参考图片构成三个 MTAP，每个 MTAP 包含三个聚合单元，每个聚合单元包含来自一个切片分组的所有宏块。第一个 MTAP 包含图片 R1 的切片分组 0、图片 R3 的切片分组 1 和图片 R5 的切片分组 2。第二个 MTAP 包含图片 R1 的切片分组 1、图片 R3 的切片分组 2 和图片 R5 的切片分组 0。第三个 MTAP 包含图片 R1 的切片分组 2、图片 R 3的切片分组 0 和图片 R5 的切片分组 1。每个非参考图片都被封装到一个 STAP-B 中。

因此，NAL 单元的传输顺序如下：

```txt
R1,切片group 0, DON 1, 承载在 MTAP, RTP SN: N
R3,切片group 1, DON 2, 承载在 MTAP, RTP SN: N
R5,切片group 2, DON 4, 承载在 MTAP, RTP SN: N
R1,切片group 1, DON 1, 承载在 MTAP, RTP SN: N+1
R3,切片group 2, DON 2, 承载在 MTAP, RTP SN: N+1
R5,切片group 0, DON 4, 承载在 MTAP, RTP SN: N+1
R1,切片group 2, DON 1, 承载在 MTAP, RTP SN: N+2
R3,切片group 1, DON 2, 承载在 MTAP, RTP SN: N+2
R5,切片group 0, DON 4, 承载在 MTAP, RTP SN: N+2
N2, DON 3,  承载在 STAP-B, RTP SN: N+3
N4, DON 5,  承载在 STAP-B, RTP SN: N+4
```

接收者能够根据与每个 NAL 单元关联的 DON 值，按解码顺序重新组织 NAL 单元。

如果其中一个 MTAP 丢失，则接收到空间相邻且时间上位于同一位置的宏块并可用于有效地隐藏丢失。如果其中一个 STAP 丢失，则丢失的影响不会随时间传播。

### 13.3 稳健包调度示例

下面是稳健分组调度的示例。示例中使用的通信系统由以下组件组成，按照视频从源到接收器的处理顺序：

- 相机和捕捉
- 预编码缓冲区
- 编码器
- 编码图片缓冲区
- 发射器
- 传输通道
- 接收者
- 接收者缓冲区
- 解码器
- 解码图片缓冲区
- 显示

本例中使用的视频通信系统操作如下。请注意，视频流的处理在系统的所有组件中逐渐且同时进行。源视频序列被拍摄并捕获到预编码缓冲区。例如，预编码缓冲区可用于对图片从采样顺序到编码顺序进行排序，或者分析多个未压缩帧以实现比特率控制。在某些情况下，预编码缓冲区可能不存在；相反，采样的图片会立即被编码。编码器对来自预编码缓冲区的图片进行编码，并将输出(即编码图片)存储到编码图片缓冲区。发送者将来自编码图片缓冲区的编码图像封装成传输包，并通过传输通道发送给接收者。接收者将接收到的数据包存储到接收者缓冲区。接收者缓冲过程通常包括对传输延迟抖动的缓冲。接收者缓冲区还可用于恢复编码数据的正确解码顺序。解码器从接收者缓冲区读取编码数据，并产生解码图像输出到解码图片缓冲区。解码图片缓冲区用于恢复图片的输出(或显示)顺序。最后，显示图片。

在以下示例图中，I 表示 IDR 图片，R 表示参考图片，N 表示非参考图片，I、R 或 N 后面的数字表示相对于解码顺序的前一个 IDR 图片的采样时间。图片序列下方的值表示缩放的系统时钟时间戳。本例中系统时钟任意初始化，时间从左到右运行。假设编码、传输和解码(如果有的话)不花时间，每个 I、R 和 N 图片都被映射到与前一处理步骤相同的时间线中。因此，在所有示例图中，同时发生的事件都位于同一列。

下面按采样顺序描述了编码图片序列的子集。

图 16——按采样顺序排列的图片序列

```txt
...  N58 N59 I00 N01 N02 R03 N04 N05 R06 ... N58 N59 I00 N01 ...
... --|---|---|---|---|---|---|---|---|- ... -|---|---|---|- ...
...  58  59  60  61  62  63  64  65  66  ... 128 129 130 131 ...
```

采样的图片缓存在预编码缓冲区中，按照编码顺序排列。在这个例子中，我们假设非参考图片是从按照输出顺序的前一个和下一个参考图片预测的，除了 IDR 图片之前的非参考图片，它们仅从按照输出顺序的前一个参考图片预测。因此，预编码缓冲区必须包含至少两个图片，并且缓冲导致两个图片间隔的延迟。预编码缓冲过程的输出和图片的编码(和解码)顺序如下：

图 17——预编码缓冲区中重排序的图片

```txt
... N58 N59 I00 R03 N01 N02 R06 N04 N05 ...
... -|---|---|---|---|---|---|---|---|- ...
... 60  61  62  63  64  65  66  67  68  ...
```

编码器或发送者可以将每张图片的 DON 值设置为解码顺序中前一张图片的 DON 值加一。

为了简单起见，让我们假设：

- 序列的帧率是恒定的，
- 每张图片只包含一个切片，
- 每个切片都封装在单个 NAL 单元数据包中，
- 没有传输延迟，并且
- 图片以恒定间隔(即 1/(帧速率))传输。

当图片按解码顺序传输时，它们被如下接收：

图 18——按编码顺序接收的图片

```txt
... N58 N59 I00 R03 N01 N02 R06 N04 N05 ...
... -|---|---|---|---|---|---|---|---|- ...
... 60  61  62  63  64  65  66  67  68  ...
```

**可选的** sprop-interleaving-depth 媒体类型参数设置为 0，因为传输(或接收)顺序与解码顺序相同。

最初，解码器必须在其解码图片缓冲区中缓冲一个图片间隔，以便从解码顺序到输出顺序组织图片，如下所示：

图 19——输出顺序

```txt
... N58 N59 I00 N01 N02 R03 N04 N05 R06 ...
... -|---|---|---|---|---|---|---|---|- ...
... 61  62  63  64  65  66  67  68  69  ...
```

解码图片缓冲区中所需的初始缓冲量可以在缓冲周期 SEI 消息中或与 H.264 视频可用性信息的 num_reorder_frames 语法元素一起指示。num_reorder_frames 指示序列中帧、互补场对或非配对场的最大数量，它们按解码顺序在帧、互补场对或非配对场之前且按输出顺序紧随其后。简单起见，我们假设 num_reorder_frames 用于指示解码图片缓冲区中的初始缓冲区。在此示例中，num_reorder_frames 等于 1。

可以观察到，如果 IDR 图片 I00 在传输过程中丢失并在系统时钟值为 62 时发出重传请求，则有一个图片时间间隔(直到系统时钟到达时间戳 63)来接收重传的 IDR 图片 I00。

然后让我们假设 IDR 图片的传输比其解码位置早两个帧间隔；即图片如下传输：

图 20——交织：按发送顺序较早的 IDR 图片

```txt
...  I00 N58 N59 R03 N01 N02 R06 N04 N05 ...
... --|---|---|---|---|---|---|---|---|- ...
...  62  63  64  65  66  67  68  69  70  ...
```

根据其定义将**可选的** sprop-interleaving-depth 媒体类型参数设置为 1。(本例中可以如下推导 sprop-interleaving-depth 取值：图片 I00 是传输顺序在图片 N58 或 N59之前、解码顺序在其后的唯一图片。除了图片 I00、N58 和 N59，图片的传输顺序与解码顺序相同。由于编码后的图片恰好封装在一个 NAL 单元中，因此 sprop-interleaving-depth 的值等于最大图片数，它们按传输顺序在图片之前且按解码顺序在图片之后)。

根据 sprop-interleaving-depth 参数的值，接收者缓冲过程一次包含两个图片，并根据与每个图片关联的 DON 值将图片从接收顺序排列到正确的解码顺序。接收者缓冲过程的输出如下：

图 21——交织：接收者缓冲区

```txt
... N58 N59 I00 R03 N01 N02 R06 N04 N05 ...
... -|---|---|---|---|---|---|---|---|- ...
... 63  64  65  66  67  68  69  70  71  ...
```

同样，需要一个图片间隔的初始缓冲延迟，从解码顺序到输出顺序组织图片，如下所示：

图 22——交织：重新排序后的接收者缓冲区

```txt
... N58 N59 I00 N01 N02 R03 N04 N05 ...
... -|---|---|---|---|---|---|---|- ...
... 64  65  66  67  68  69  70  71  ...
```

请注意，IDR 图片在传输过程中可能经历的最大延迟，包括可能的应用、传输或链路层重传，等于三个图片间隔。因此，与按解码顺序传输图片的情况相比，在支持重传的系统中提高了 IDR 图片的丢失弹性。

### 13.4 冗余编码切片的鲁棒传输调度

如果相应的基本编码图像被正确解码，则冗余编码图像是在解码过程中未使用的图片或图片的一部分的编码表示。解码的基本图片的任何区域与对同一访问单元中的任何冗余图片应用 H.264 解码过程所生成的相应区域之间应该没有明显差异。冗余编码切片是作为冗余编码图像的一部分的编码切片。

冗余编码图像可用于在容易出错的视频传输中提供不平等的错误保护。如果图片的基本编码表示被错误地解码，则可以解码对应的冗余编码图像。使用冗余编解码器图片功能的应用和编码技术的示例包括视频冗余编码 [^23] 和多播流中“关键图片”的保护 [^24]。

许多容易出错的视频通信系统的特性之一是传输错误通常是突发的。因此，它们可能会影响多个按传输顺序连续传输的数据包。在低比特率视频通信中，将整个编码图像封装到一个传输数据包中是比较常见的。因此，基本编码图像和对应的冗余编码图像可以按传输顺序在连续数据包中传输。为了使传输方案更能容忍突发传输错误，传输由多个数据包分隔的基本编码图像和冗余编码图像是有益的。DON 概念实现了这一点。

### 13.5 关于其他设计可能性的评论

H.264 编码标准的切片头语法结构包含 frame_num 语法元素，可以指示编码帧的解码顺序。然而，由于以下原因，使用 frame_num 语法元素来恢复解码顺序是不可行或不可取的：

- 接收者需要解析每个编码图片至少一个切片头(在将编码数据传递给解码器之前)。
- 来自多个编码视频序列的编码切片不能交织，因为每个 IDR 图片中的 frame_num 语法元素都重置为 0。
- 互补字段对的编码字段与 frame_num 语法元素共享同一值。因此，不能基于 frame_num 语法元素或 H.264 编码语法的任何其他语法元素恢复互补字段对的编码字段的解码顺序。

用于传输 MPEG-4 基本流 [^25] 的 RTP 负载格式允许在同一 RTP 数据包中交织访问单元和传输多个访问单元。根据 [^1] 的子条款 7.4.1.2，在 H.264 编码标准中指定一个访问单元以包含与基本编码图像相关联的所有 NAL 单元。因此，不能交织不同图片的切片，并且不能使用多图片切片交织技术(参见第 [12.6 节](#126-低比特率流))来提高错误恢复能力。

## 14 来自 [RFC 3984](https://tools.ietf.org/pdf/rfc3984) 的变化

以下是来自 [RFC 3984](https://tools.ietf.org/pdf/rfc3984) 的技术更改列表(包括错误修复)。除了此技术更改列表外，还进行了大量编辑更改，但未在本节中记录。请注意，[第 8.2.2 节](#822-与-sdp-offeranswer-模型一起使用)是本备忘录中许多重要更改发生的地方，值得特别关注。

1) [5.4](#54-打包模式)、[5.5](#55-解码顺序号don)、[6.2](#62-单-nal-单元模式)、[6.3](#63-非交织模式) 和 [6.4](#64-交织模式) 节中，删除了正在使用的打包模式可以通过外部方式指示。
2) [7.2.2 节](#722-解交织过程)，将句子`解交织缓冲区中有 N 个 VCL NAL 单元。`修改为`解交织缓冲区中有 N 个或更多 VCL NAL 单元。`
3) [8.1 节](#81-媒体类型注册) sprop-init-buf-time 的语义(第2段)，将句子`该参数是(NAL 单元传输时间-NAL 单元解码时间)的最大值，假设传输可靠且瞬时，传输和解码的时间线相同，并且从第一个数据包到达时开始解码。`到`该参数是(NAL 单元解码时间-NAL 单元传输时间)的最大值，假设传输可靠且瞬时，传输和解码的时间线相同，并且从第一个数据包到达时开始解码。`
4) 添加媒体类型参数 max-smbps、sprop-level-parameter-sets、use-level-src-parameter-sets、in-band-parameter-sets、sar-understood 和 sar-supported。
5) [8.1 节](#81-媒体类型注册)中，删除了 parameter-add 的规范。parameter-add 的其他描述(在 [8.2](#82-sdp-参数) 和 [8.4 节](#84-参数集考虑)中)也被删除。
6) [8.1 节](#81-媒体类型注册)中，向 sprop-parameter-sets 添加了一个约束，使其只能包含profile-level-id 指示的同一配置文件和级别的参数集。
7) [8.2.1 节](#821-载荷类型参数到-sdp-的映射)中，补充 sprop-parameter-sets 和 sprop-level-parameter-sets 可以包含在 SDP 的 “a=fmtp” 行，也可以使用 [^9] 的 6.3 节中指定的 “fmtp” 源属性进行传送。
8) [8.2.2 节](#822-与-sdp-offeranswer-模型一起使用)中，将 sprop-deint-buf-req 从与 SDP Offer/Answer 模型一起使用的媒体格式配置中删除。
9) [8.2.2 节](#822-与-sdp-offeranswer-模型一起使用)中，明确了 SDP Offer/Answer 模型中 level 是可降级的，即 profile-level-id 的 level 部分的使用不需要对称(answer 中包含的 level 可以低于或等于 offer 中包含的 level)。
10) [8.2.2 节](#822-与-sdp-offeranswer-模型一起使用)中，删除了能力参数可用于声明编码能力。
11) [8.2.2 节](#822-与-sdp-offeranswer-模型一起使用)中，添加了有关如何使用 sprop-parameter-sets 和 sprop-level-parameter-sets 进行参数集带外传输的规则，无论是否进行 level 降级。
12) [8.2.2 节](#822-与-sdp-offeranswer-模型一起使用)中，阐明了将媒体类型参数与 SDP Offer/Answer 用于多播的规则。
13) [8.2.2 节](#822-与-sdp-offeranswer-模型一起使用)中，完成并更正了不同媒体类型参数在 offer 或 answer 和方向属性的不同组合中应如何解释的列表。
14) [8.4 节](#84-参数集考虑)中，更改了文本，以便允许参数集的带外和带内传输，并且既不推荐也不要求。
15) 添加了 [8.5 节](#85-使用带内传输参数集的解码器刷新点程序信息性)(信息性)，提供了解码器刷新以处理参数集丢失的示例方法。
16) 添加了媒体类型参数 max-recv-level 和 level-asymmetry-allowed， 并调整了 level 升级和不对称的相关文本和示例。

## 15 向后兼容 [RFC 3984](https://tools.ietf.org/pdf/rfc3984)

当前文档修订并作废了 [RFC 3984](https://tools.ietf.org/pdf/rfc3984)。[第 14 节](#14-来自-rfc-3984-的变化)列出了与 [RFC 3984](https://tools.ietf.org/pdf/rfc3984) 相关的技术更改。本节解决向后兼容性问题。

应该注意的是，在大多数情况下，根据 [RFC 3984](https://tools.ietf.org/pdf/rfc3984) 的旧实现和根据本文档的新实现互通不会存在兼容性问题。仅当以下两个条件都为真时才会出现兼容性问题：

1) 旧实现和新实现互通，以及
2) 参数集在带外传输。

当出现此类兼容性问题时，通过以下分析很容易调试并找到不兼容的原因。

第 1、2、3、7、9、10、12 和 13 项是错误修复类型的更改，不会导致任何向后兼容性问题。

第 4 项(添加六个新媒体类型参数)对基于 SDP Offer/Answer 的应用程序不会产生任何向后兼容性问题，因为旧 [RFC 3984](https://tools.ietf.org/pdf/rfc3984) 接收者忽略这些参数，并且因为它们是可选的，旧 [RFC 3984](https://tools.ietf.org/pdf/rfc3984) 发送者可以不使用这些参数。但是，基于声明性用法的应用程序存在向后兼容性问题(仅适用于参数 sprop-level-parameter-sets，因为其他五个参数在声明性用法中不可用)。例如，使用 RTSP 和 SAP 的基于声明性用法的应用程序存在向后兼容性问题，因为符合 [RFC 3984](https://tools.ietf.org/pdf/rfc3984) 的 SDP 接收者无法接受 SDP 包含无法识别参数的会话。因此，RTSP 或 SAP 服务器可能必须准备两组流，一组用于旧版 [RFC 3984](https://tools.ietf.org/pdf/rfc3984) 接收者，另一组用于本文的接收者。

第 5、6 和 11 项与参数集的带外传输有关。存在以下向后兼容性问题。

1) 当 [RFC 3984](https://tools.ietf.org/pdf/rfc3984) 的旧发送方包含的级别参数集与 profile-level-id 到 sprop-parameter-sets 指示的默认级别不同时，sprop-parameter-sets 的参数值对本文的接收方无效;因此，会话可能会被拒绝。

2) 在 [RFC 3984](https://tools.ietf.org/pdf/rfc3984) 的旧 offerer 和本文的 answerer 之间的 SDP Offer/Answer 中，当 answerer 包含在 answer 参数集中的不是 offer 中包含的参数集的超集时，sprop-parameter-sets 对 offerer 无效，并且会话可能无法正确启动(与更改项 11 相关)。

3) 当本文的一个端点 A 包括 in-band-parameter-sets 等于 1 时，根据 [RFC 3984](https://tools.ietf.org/pdf/rfc3984) 的另一端 B 不明白它必须在带内传输参数集，并且 B 仍然可以在其发送的带内流排除参数集。因此，端点 A 无法解码它接收到的流。

第 7 项(允许使用 [^9] 的第 6.3 节中指定的 “fmtp” 源属性传送 sprop-parameter-sets 和 sprop-level-parameter-sets)类似于第 4 项。对于基于 SDP Offer/Answer 的应用程序，它不会产生任何向后兼容性问题。因为旧版 [RFC 3984](https://tools.ietf.org/pdf/rfc3984) 接收者忽略 “fmtp” 源属性，并且因为是可选的，旧 [RFC 3984](https://tools.ietf.org/pdf/rfc3984) 发送者可以不使用 “fmtp” 源属性。然而，基于 SDP 声明性用法的应用程序存在向后兼容性问题，例如，那些使用 RTSP 和 SAP 的应用程序，因为 [RFC 3984](https://tools.ietf.org/pdf/rfc3984) 的 SDP 接收者无法接受 SDP 包含无法识别的参数(即 “fmtp” 源属性)。因此，RTSP 或 SAP 服务器可能必须准备两组流，一组用于旧版 [RFC 3984](https://tools.ietf.org/pdf/rfc3984) 接收者，另一组用于本文的接收者。

第 14 项不会导致任何向后兼容性问题，因为仍然允许参数集的带外传输。

第 15 条不会引起任何向后兼容性问题，因为添加的第 [8.5 节](#85-使用带内传输参数集的解码器刷新点程序信息性)提供了信息。

第 16 条不会产生任何向后兼容性问题，因为如果任一端符合 [RFC-3984](https://tools.ietf.org/pdf/rfc3984)，则默认级别的处理是相同的，此外，符合 [RFC-3984](https://tools.ietf.org/pdf/rfc3984) 的端将简单地忽略新的媒体类型参数(如果存在)。

## 16 致谢

感谢 [RFC-3984](https://tools.ietf.org/pdf/rfc3984) 的作者 Stephan Wenger、Miska Hannuksela、Thomas Stockhammer、Magnus Westerlund 和 David Singer。感谢 Dave Lindbergh、Philippe Gentric、Gonzalo Camarillo、Gary Sullivan、Joerg Ott 和 Colin Perkins 在 [RFC-3984](https://tools.ietf.org/pdf/rfc3984) 开发过程中仔细审查。感谢 Stephen Botzko、Magnus Westerlund、Alex Eleftheriadis、Thomas Schierl、Tom Taylor、Ali Begen、Aaron Wells、Stuart Taylor、Robert Sparks、Dan Romascanu 和 Niclas Comstedt 在本文开发过程中的宝贵意见和投入。

## 17 参考

### 17.1 规范性引用文件

[^1]: ITU-T Recommendation H.264, "Advanced video coding for generic audiovisual services", March 2010.
[^2]: ISO/IEC International Standard 14496-10:2008.
[^3]: ITU-T Recommendation H.241, "Extended video procedures and control signals for H.300-series terminals", May 2006.
[^4]: Bradner, S., "Key words for use in RFCs to Indicate Requirement Levels", [BCP 14](https://tools.ietf.org/pdf/bcp14), [RFC 2119](https://tools.ietf.org/pdf/rfc2119), March 1997.
[^5]: Schulzrinne, H., Casner, S., Frederick, R., and V. Jacobson, "RTP: A Transport Protocol for Real-Time Applications", STD 64, [RFC 3550](https://tools.ietf.org/pdf/rfc3550), July 2003.
[^6]: Handley, M., Jacobson, V., and C. Perkins, "SDP: Session Description Protocol", [RFC 4566](https://tools.ietf.org/pdf/rfc4566), July 2006.
[^7]: Josefsson, S., "The Base16, Base32, and Base64 Data Encodings", [RFC 4648](https://tools.ietf.org/pdf/rfc4648), October 2006.
[^8]: Rosenberg, J. and H. Schulzrinne, "An Offer/Answer Model with Session Description Protocol (SDP)", [RFC 3264](https://tools.ietf.org/pdf/rfc3264), June 2002.
[^9]: Lennox, J., Ott, J., and T. Schierl, "Source-Specific Media Attributes in the Session Description Protocol (SDP)", [RFC 5576](https://tools.ietf.org/pdf/rfc5576), June 2009.

### 17.2 资料性引用

[^10]: Luthra, A., Sullivan, G.J., and T. Wiegand (eds.), "Introduction to the special issue on the H.264/AVC video coding standard", IEEE Transactions on Circuits and Systems for Video Technology, Vol. 13, No. 7, July 2003.
[^11]: Ott, J., Bormann, C., Sullivan, G., Wenger, S., and R. Even, Ed., "RTP Payload Format for ITU-T Rec. H.263 Video", [RFC 4629](https://tools.ietf.org/pdf/rfc4629), January 2007.
[^12]: ISO/IEC International Standard 14496-2:2004.
[^13]: Wenger, S., "H.264/AVC over IP", IEEE Transaction on Circuits and Systems for Video Technology, Vol. 13, No. 7, July 2003.
[^14]: Wenger, S., "H.26L over IP: The IP-Network Adaptation Layer", Proceedings Packet Video Workshop, April 2002.
[^15]: Stockhammer, T., Hannuksela, M.M., and S. Wenger, "H.26L/JVT Coding Network Abstraction Layer and IP-Based Transport", IEEE International Conference on Image Processing (ICIP 2002), Rochester, NY, September 2002.
[^16]: Schulzrinne, H. and S. Casner, "RTP Profile for Audio and Video Conferences with Minimal Control", STD 65, [RFC 3551](https://tools.ietf.org/pdf/rfc3551), July 2003.
[^17]: ITU-T Recommendation H.223, "Multiplexing protocol for low bit rate multimedia communication", July 2001.
[^18]: Li, A., Ed., "RTP Payload Format for Generic Forward Error Correction", [RFC 5109](https://tools.ietf.org/pdf/rfc5109), December 2007.
[^19]: Stockhammer, T., Wiegand, T., Oelbaum, T., and F. Obermeier, "Video Coding and Transport Layer Techniques for H.264/AVC-Based Transmission over Packet-Lossy Networks", IEEE International Conference on Image Processing (ICIP 2003), Barcelona, Spain, September 2003.
[^20]: Varsa, V. and M. Karczewicz, "Slice interleaving in compressed video packetization", Packet Video Workshop 2000.
[^21]: Kang, S.H. and A. Zakhor, "Packet scheduling algorithm for wireless video streaming", Packet Video Workshop 2002.
[^22]: Hannuksela, M.M., "Enhanced Concept of GOP", JVT-B042, available <http://ftp3.itu.int/av-arch/video-site/0201_Gen/JVT-B042.doc>, January 2002.
[^23]: Wenger, S., "Video Redundancy Coding in H.263+", 1997 International Workshop on Audio-Visual Services over Packet Networks, September 1997.
[^24]: Wang, Y.-K., Hannuksela, M.M., and M. Gabbouj, "Error Resilient Video Coding Using Unequally Protected Key Pictures", in Proc. International Workshop VLBV03, September 2003.
[^25]: van der Meer, J., Mackie, D., Swaminathan, V., Singer, D., and P. Gentric, "RTP Payload Format for Transport of MPEG-4 Elementary Streams", [RFC 3640](https://tools.ietf.org/pdf/rfc3640), November 2003.
[^26]: Baugher, M., McGrew, D., Naslund, M., Carrara, E., and K. Norrman, "The Secure Real-time Transport Protocol (SRTP)", [RFC 3711](https://tools.ietf.org/pdf/rfc3711), March 2004.
[^27]: Schulzrinne, H., Rao, A., and R. Lanphier, "Real Time Streaming Protocol (RTSP)", [RFC 2326](https://tools.ietf.org/pdf/rfc2326), April 1998.
[^28]: Handley, M., Perkins, C., and E. Whelan, "Session Announcement Protocol", [RFC 2974](https://tools.ietf.org/pdf/rfc2974), October 2000.
[^29]: Westerlund, M. and S. Wenger, "RTP Topologies", [RFC 5117](https://tools.ietf.org/pdf/rfc5117), January 2008.
[^30]: Wenger, S., Chandra, U., Westerlund, M., and B. Burman, "Codec Control Messages in the RTP Audio-Visual Profile with Feedback (AVPF)", [RFC 5104](https://tools.ietf.org/pdf/rfc5104), February 2008.
