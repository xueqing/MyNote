# SRTP 学习

## 1 介绍

本文档描述了安全实时传输协议(SRTP)，实时传输协议(RTP)的配置文件，它可以为 RTP 流量和 RTP 流控([实时传输控制协议 RTCP](https://datatracker.ietf.org/doc/html/rfc3350))提供机密性、消息认证和重放保护。

SRTP 为 RTP 和 RTCP 流的加密和消息认证提供了一个框架。SRTP 定义了一组默认密码转化，它允许将来引入的新转换。使用适当的密钥管理，SRTP 对于单播和多播 RTP 应用程序是安全的。

SRTP 可以实现高吞吐量和低数据包扩展。SRTP 被证明是一种适用于异构环境(有线和无线网络混合)的保护。为了获得这些功能，描述了默认转换，基于用于加密的附加流密码、用于消息身份验证的基于密钥散列的函数，以及基于 SRTP 的 RTP 序列号排序/同步的“隐式”索引，以及用于安全 RTCP(SRTCP)的编号。

## 2 目标和功能

SRTP 的安全目标是确保：

- RTP 和 RTCP 载荷的机密性，以及
- 整个 RTP 和 RTCP 包的完整性，以及防止重放包。

这些安全服务是可选的且互相独立，除了 SRTCP 完整性保护是强制性的(RTCP 消息的恶意或错误更改可能会破坏 RTP 流的处理)。

此协议的其他功能性目标是：

- 允许使用新的加密转换进行升级的框架
- 低带宽成本，即保留 RTP 压缩效率的框架

以及，由预定义的转换确保：

- 低计算成本
- 占用空间小(即密钥信息和重放列表的代码和数据存储小)
- 有限的包扩展，以支持带宽经济目标
- 独立于 RTP 使用的底层传输、网络和物理层，尤其是对丢包和重排序的高容忍度

这些属性确保 SRTP 是一种适用于有线和无线场景中的 RTP/RTCP 的保护方案。

### 2.1 功能

除了上述直接的目标，SRTP 还提供了一些附加的功能。它们被引入以减轻密钥管理的负担以及进一步提高安全性。包括：

- 单个“主密钥(master key)”可以为用于 SRTP 流和对应的 SRTCP 流提供机密性和完整性保护的密钥材料。这是通过一个密钥派生函数实现的，为各自的安全原语提供从主密钥安全派生的“会话密钥(session key)”。
- 此外，密钥派生可配置为周期性地刷新会话密钥，这限制了由固定密钥生成的密文数量，可供攻击者进行密码分析。
- “盐密钥(salting key)”用于防止与计算和时间内存权衡攻击。

可以在第 7 节找到这些功能的详细原理。

## 3 SRTP 框架

RTP 是[实时传输协议](https://datatracker.ietf.org/doc/html/rfc3550)。我们将 SRTP 定义为 RTP 的配置文件。此配置文件是 [RTP 音/视频配置文件](https://datatracker.ietf.org/doc/html/rfc3551)的扩展。除非明确指出，该配置文件的所有方面都适用，并添加了 SRTP 安全功能。从概念上讲，我们将 SRTP 视为“堆栈中的凸点”实现，位于 RTP 应用程序和传输层之间。SRTP 拦截 RTP 包，然后在发送端转发等效的 SRTP 包，并在接收端拦截 SRTP 包，并向上传递等效的 RTP 包。

安全 RTCP(SRTCP) 为 RTCP 提供的作用等同于 SRTP 为 RTP 提供的作用。SRTCP 消息身份验证是**强制性的**，因此可以保护 RTCP 字段以跟踪成员关系，为 RTP 发送者提供反馈，或维护包序列计数器。SRTCP 在 3.4 节描述。

### 3.1 安全 RTP

SRTP 包的格式如图 1 所示：

图 1. SRTP 包格式。`Encrypted Portion` 和第 4 节预定义转换的文本大小相同

```txt
     0                   1                   2                   3
   0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<+
  |V=2|P|X|  CC   |M|     PT      |       sequence number         | |
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ |
  |                           timestamp                           | |
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ |
  |           synchronization source (SSRC) identifier            | |
  +=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+ |
  |            contributing source (CSRC) identifiers             | |
  |                               ....                            | |
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ |
  |                   RTP extension (OPTIONAL)                    | |
+>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ |
| |                          payload  ...                         | |
| |                               +-------------------------------+ |
| |                               | RTP padding   | RTP pad count | |
+>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<+
| ~                     SRTP MKI (OPTIONAL)                       ~ |
| +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ |
| :                 authentication tag (RECOMMENDED)              : |
| +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ |
|                                                                   |
+- Encrypted Portion*                      Authenticated Portion ---+
```

SRTP 包的“加密部分(Encrypted Portion)”包括对等效 RTP 包的 RTP 载荷的加密(包括 RTP 填充，如果存在)。加密部分可能是明文的确切大小或可能更大。图 1 显示了 RTP 载荷，包括 [RTP](https://datatracker.ietf.org/doc/html/rfc3550) 的任何可能填充。

预定义的加密转换都不使用任何填充；对于这些，RTP 和 SRTP 有效负载大小完全匹配。添加到 SRTP(在第 6 节之后)的新转换可能需要填充，因此可能会产生更大的有效载荷。 RTP 提供了自己的填充格式(如图 1 所示)，由于 RTP 标头中的填充指示符，相对于使用无前缀代码的填充，它在紧凑性方面具有优势。此 RTP 填充应是需要填充的转换的默认方法。转换可以指定其他填充方法，然后必须指定其填充的数量、格式和处理。需要注意的是，使用填充的加密转换容易受到微妙的攻击，尤其是在不使用消息身份验证时 [V02]。新加密转换的每个规范都需要仔细考虑和描述它使用的填充的安全含义。消息身份验证代码定义了自己的填充，因此此默认值不适用于身份验证转换。

## 参考

- [rfc 3711-The Secure Real-time Transport Protocol (SRTP)](chrome-extension://ikhdkkncnoglghljlkmcimlnlhkeamad/pdf-viewer/web/viewer.html?file=https%3A%2F%2Fwww.rfc-editor.org%2Frfc%2Fpdfrfc%2Frfc3711.txt.pdf#=&zoom=130)
