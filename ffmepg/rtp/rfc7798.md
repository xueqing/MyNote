# 高效视频编码(HEVC)的 RTP 载荷格式

- [高效视频编码(HEVC)的 RTP 载荷格式](#高效视频编码hevc的-rtp-载荷格式)
  - [摘要](#摘要)
  - [1 介绍](#1-介绍)
    - [1.1 HEVC 编解码器概述](#11-hevc-编解码器概述)
      - [1.1.1 编码工具功能](#111-编码工具功能)
        - [四叉树块与变换结构](#四叉树块与变换结构)
        - [熵编码](#熵编码)
        - [环路内滤波](#环路内滤波)
        - [运动预测与编码](#运动预测与编码)
        - [帧内预测和帧内编码](#帧内预测和帧内编码)
        - [其他编码工具功能](#其他编码工具功能)
      - [1.1.2 系统和传输接口](#112-系统和传输接口)
        - [视频参数集](#视频参数集)
        - [配置文件、层和级别](#配置文件层和级别)
        - [比特流和基本流](#比特流和基本流)
        - [随机访问支持](#随机访问支持)
        - [时间可伸缩性支持](#时间可伸缩性支持)
        - [时间子层交换支持](#时间子层交换支持)
        - [子层参考或非参考图像](#子层参考或非参考图像)
        - [扩展性](#扩展性)
        - [比特流提取](#比特流提取)
        - [参考图像管理](#参考图像管理)
        - [超低延迟支持](#超低延迟支持)
        - [新 SEI 消息](#新-sei-消息)
      - [1.1.3 并行处理支持](#113-并行处理支持)
      - [1.1.4 NAL 单元头](#114-nal-单元头)
    - [1.2 载荷格式概述](#12-载荷格式概述)
  - [2 惯例](#2-惯例)
  - [3 定义和缩写](#3-定义和缩写)
    - [3.1 定义](#31-定义)
      - [3.1.1 HEVC 规范中的定义](#311-hevc-规范中的定义)
        - [访问单元](#访问单元)
        - [BLA 访问单元](#bla-访问单元)
        - [BLA 图像](#bla-图像)
        - [编码视频序列(CVS)](#编码视频序列cvs)
        - [CRA 访问单元](#cra-访问单元)
        - [CRA 图像](#cra-图像)
        - [IDR 访问单元](#idr-访问单元)
        - [IDR 图像](#idr-图像)
        - [IRAP 访问单元](#irap-访问单元)
        - [IRAP 图像](#irap-图像)
        - [层](#层)
        - [操作点](#操作点)
        - [随机访问](#随机访问)
        - [子层](#子层)
        - [子层表示](#子层表示)
        - [平铺](#平铺)
        - [平铺列](#平铺列)
        - [平铺行](#平铺行)
      - [3.1.2 本文的特定定义](#312-本文的特定定义)
        - [被依赖 RTP 流](#被依赖-rtp-流)
        - [最高 RTP 流](#最高-rtp-流)
        - [媒体感知网络元素(MANE)](#媒体感知网络元素mane)
        - [媒体传输](#媒体传输)
        - [单媒体传输多 RTP 流(MRST)](#单媒体传输多-rtp-流mrst)
        - [多媒体传输多 RTP 流(MRMT)](#多媒体传输多-rtp-流mrmt)
        - [NAL 单元解码顺序](#nal-单元解码顺序)
        - [NAL 单元输出顺序](#nal-单元输出顺序)
        - [类 NAL 单元结构](#类-nal-单元结构)
        - [NALU 时间](#nalu-时间)
        - [RTP 流](#rtp-流)
        - [单媒体传输单 RTP 流(SRST)](#单媒体传输单-rtp-流srst)
        - [传输顺序](#传输顺序)
    - [3.2 缩写](#32-缩写)
  - [4 RTP 载荷格式](#4-rtp-载荷格式)
    - [4.1 RTP 头部用法](#41-rtp-头部用法)
    - [4.2 载荷头部用法](#42-载荷头部用法)
    - [4.3 传输模式](#43-传输模式)
    - [4.4 载荷结构](#44-载荷结构)
      - [4.4.1 单 NAL 单元数据包](#441-单-nal-单元数据包)
      - [4.4.2 聚合包(AP)](#442-聚合包ap)
      - [4.4.3 分片单元](#443-分片单元)
      - [4.4.4 PACI 包](#444-paci-包)
        - [4.4.4.1 PACI 规则的原因(资料性)](#4441-paci-规则的原因资料性)
        - [4.4.4.2 PACI 扩展(资料性)](#4442-paci-扩展资料性)
    - [4.5 时间可扩展性控制信息](#45-时间可扩展性控制信息)
    - [4.6 解码顺序号](#46-解码顺序号)
  - [5 打包规则](#5-打包规则)
  - [6 解包过程](#6-解包过程)
  - [7 载荷格式参数](#7-载荷格式参数)
    - [7.1 媒体类型注册](#71-媒体类型注册)
    - [7.2 SDP 参数](#72-sdp-参数)
      - [7.2.1 载荷类型参数到 SDP 的映射](#721-载荷类型参数到-sdp-的映射)
      - [7.2.2 与 SDP Offer/Answer 模型一起使用](#722-与-sdp-offeranswer-模型一起使用)
      - [7.2.3 声明性会话描述中使用](#723-声明性会话描述中使用)
      - [7.2.4 参数集考虑](#724-参数集考虑)
      - [7.2.5 多流模式下的依赖信令](#725-多流模式下的依赖信令)
  - [8 与反馈消息一起使用](#8-与反馈消息一起使用)
    - [8.1 图像丢失指示(PLI)](#81-图像丢失指示pli)
    - [8.2 切片丢失指示(SLI)](#82-切片丢失指示sli)
    - [8.3 参考图像选择指示(RPSI)](#83-参考图像选择指示rpsi)
    - [8.4 完整的内部请求(FIR)](#84-完整的内部请求fir)
  - [9 安全考虑](#9-安全考虑)
  - [10 拥塞控制](#10-拥塞控制)
  - [11 IANA 考虑](#11-iana-考虑)
  - [12 参考](#12-参考)
    - [12.1 规范性引用](#121-规范性引用)
    - [12.2 信息参考](#122-信息参考)
  - [致谢](#致谢)
  - [作者地址](#作者地址)

## 摘要

本文为视频编码标准 ITU-T H.265 建议和 ISO/IEC 23008-2 国际标准描述了 RTP 载荷格式，两者也称为高效视频编码(HEVC)，由视频编码联合协作小组开发(JCT-VC)。 RTP 载荷格式支持在每个 RTP 载荷中打包一个或多个网络抽象层(NAL)单元，以及将一个 NAL 单元分片为多个 RTP 数据包。此外，它支持通过单个流以及多个 RTP 流传输 HEVC 比特流。当使用多个 RTP 流时，可以使用单个传输或多个传输。载荷格式在视频会议、互联网视频流和高比特率娱乐质量视频等方面具有广泛的适用性。

## 1 介绍

2013 年 4 月，ITU-T 批准了作为 ITU-T H.265 建议[^HEVC]和 ISO/IEC 23008-2 国际标准 [^ISO23008-2] 正式发布的高效视频编码规范；据报道，它比 H.264 [^H.264] 提供了显著的编码效率增益。

本文描述了 HEVC 的 RTP 载荷格式。它与 [^RFC6184] 和 [^RFC6190] 的 RTP 载荷格式共享其基本设计。在设计理念、安全性、拥塞控制和总体实现复分片单元杂性方面，它与早期载荷格式规范具有类似的特性。这是一个有意的选择，因为至少 RFC6184 被广泛部署，并且在相关的实现者社区中广为人知。HEVC 版本 1 合并 RFC6190 中的机制，支持时间可伸缩性。

为了帮助重叠的实现者社区，通常本文的非规范性解释部分只会突出显示 RFC 6184 和 6190 与 HEVC 载荷格式之间的差异。假设这些部分基本熟悉两种规范。但是，本文的规范性部分不要求研究 RFC 6184 或 6190。

### 1.1 HEVC 编解码器概述

H.264 和 HEVC 共享类似的混合视频编解码器设计。在本文中，我们简要概述 HEVC 的这些功能，本文指定的载荷格式以某种形式对它们进行了说明。实现者必须阅读、理解并应用与 HEVC 相关的 ITU-T/ISO/IEC 规范，以达到可互操作、性能良好的实现。实现者应该考虑使用 ITU-T/ISO/IEC 提供的工具测试其设计(包括载荷格式实现和核心视频编解码器之间的互通)，例如，在 [^H.265.1] 中指定的一致性比特流。历史上，不这样做会导致系统性能差且不安全。

从概念上讲，H.264 和 HEVC 都包括视频编码层(VCL)和网络抽象层(NAL)，视频编码层(VCL)通常用于指代编码工具功能，网络抽象层(NAL)通常用于指代编解码器的系统和传输接口方面。

#### 1.1.1 编码工具功能

与早期基于混合视频编码的标准(包括 H.264)类似，HEVC 采用以下基本视频编码设计。首先通过帧内或运动补偿预测形成预测信号，然后对残差(原始和预测之间的差异)进行编码。与早期设计相比，通过重新设计和改进编解码器的几乎所有部分，以提高编码效率。此外，HEVC 还包括一些工具，使其在并行架构上的实现更容易。下面是 HEVC 编码工具功能的摘要。

##### 四叉树块与变换结构

对 HEVC 的编码效率做出重大贡献的主要工具之一是使用灵活的编码块和变换，它们以分层四叉树的方式定义。与 H.264 不同，H.264 的基本编码块是固定大小 16x16 的宏块，HEVC 定义了最大大小为 64x64 的编码树单元(Coding Tree Unit, CTU)。每个 CTU 可以以分层四叉树的方式划分为更小的单元，并且可以表示更小的大小为 4x4 的块。类似地，HEVC 中使用的变换可以有不同的大小，从 4x4 到 32x32。利用大的块和变换有助于 HEVC 的主要增益，特别是高分辨率。

##### 熵编码

HEVC 使用单个熵编码引擎，该引擎基于上下文自适应二进制算术编码(Context Adaptive Binary Arithmetic Coding, CABAC) [^CABAC]，而 H.264 使用两个不同的熵编码引擎。HEVC 中的 CABAC 与 H.264 中的 CABAC 有许多相似之处，但有一些改进。包括提高编码效率和降低实现复杂性，特别是并行架构。

##### 环路内滤波

H.264 包括一个环路内自适应去块滤波器，它平滑重建图像中变换边缘周围的块效应，以提高图像质量和压缩效率。在 HEVC 中，采用了类似的解块滤波器，但复杂度稍低。此外，图像还要经过一个称为采样自适应偏移(Sample Adaptive Offset, SAO)的后续滤波操作，这是 HEVC 中的一个新设计元素。SA- 基本上以自适应方式添加像素级偏移，通常用作去振铃滤波器。据观察，SA- 改善了尤其是锐利边缘周围的图像质量，大大改善了 HEVC 的视觉质量。

##### 运动预测与编码

这方面有许多改进，总结如下。第一类是运动合并和高级运动矢量预测(Advanced Motion Vector Prediction, AMVP)模式。可以从空间或时间上相邻的块推断预测块的运动信息。这类似于 H.264 中的 DIRECT 模式，但包含了新的方面与灵活的四叉树结构结合，以及改进并行实现的方法。此外，可以向运动矢量预测器发送信号以提高效率。第二类是高精度插值。插值滤波器长度从 6-tap 增加到 8-tap，这提高了编码效率，但也增加了复杂性。此外，插值滤波器的定义精度更高，无需任何中间舍入操作，以进一步提高编码效率。

##### 帧内预测和帧内编码

与 H.264 中的 8 帧内预测模式相比，HEVC 支持 33 个方向的角度帧内预测。这种增加的灵活性提高了目标编码效率和视觉质量，因为可以更好地预测边缘，并且可以减少边缘周围的振铃伪影。此外，根据预测方向自适应平滑参考样本。为了避免轮廓伪影。HEVC 包括一个新的插值预测生成，以提高视觉质量。此外，对于 4x4 帧内变换块，使用离散正弦变换(Discrete Sine Transform, DST)代替传统的离散余弦变换(Discrete Cosine Transform, DCT)。

##### 其他编码工具功能

HEVC 包括一些工具用于无损编码和高效屏幕内容编码，例如跳过某些块的转换。例如，当将移动设备的用户界面流式传输到大型显示器时，这些工具特别有用。

#### 1.1.2 系统和传输接口

HEVC 继承了 H.264 的基本系统和传输接口设计。其中包括基于 NAL 单元的语法结构、分层语法和数据单元结构、补充增强信息(SEI)消息机制以及基于假设参考解码器(Hypothetical Reference Decoder, HRD)的视频缓冲模型。分层语法和数据单元结构由序列级参数集、多图像级或图像级参数集、切片级头部参数和较低级别参数组成。下文列表总结了这些方面与 H.264 的差异。

##### 视频参数集

本文介绍了一种新的参数集，称为视频参数集(VPS)。对于[^HEVC]的第一个(2013)版本，VPS NAL 单元需要在激活之前可用，而解码过程的操作不需要 VPS 包含的信息。对于未来的 HEVC 扩展，例如 3D 或可伸缩扩展，VPS 预期包括解码过程的操作所必需的信息，例如解码依赖性或用于增强层的参考图像集构造的信息。VPS 提供了比特流的“大图”，包括提供了什么类型的操作点、操作点的配置文件、层和级别，以及可作为会话协商和内容选择基础的比特流的一些其他高级属性等(参见第 7.1 节)。

##### 配置文件、层和级别

配置文件、层和层语法结构可以包含在 VPS 和序列参数集(SPS)，包括 12 字节的数据来描述整个比特流(包括所有时间可伸缩层，在 HEVC 规范中称为子层)，并且可以可选地包括更多的配置文件、层以及与单个时间可伸缩层相关的级别信息。当比特流符合多个配置文件时，配置文件指示符显示“最佳查看方式”配置文件，类似于 IS- 基本媒体文件格式 (ISOBMFF) [^IS014496-12] [^IS015444-12] 中的 major brand 概念以及基于 ISOBMFF 派生的文件格式，例如 3GPP 文件格式 [^3GPPFF]。配置文件、层和层语法结构还包指示符，例如

1) 比特流是否没有帧压缩内容
2) 比特流是否没有隔行扫描的源内容
3) 比特流是否没有场图像

当 2) 和 3) 的答案均为是，比特流仅包含渐进源的帧图像。基于这些指示符，如果客户端/播放器不支持用于处理帧压缩、隔行扫描源内容或场图像的后期处理功能，可以拒绝包含这些图像的比特流。

##### 比特流和基本流

HEVC 定义了基本流，与 H.264 相比是新定义。基本流由一个或多个比特流的序列组成。由两个或多个比特流组成的基本流通常通过将两个或多个比特流(或其部分)拼接在一起形成。当基本流包含多个比特流时，比特流最后一个访问单元的最后一个 NAL 单元(基本流中的最后一个比特流除外)必须包含比特流结束 NAL 单元，并且后续比特流的第一个访问单元必须是帧内随机访问点(Intra-Random Access Point, IRAP)访问单元。该 IRAP 访问单元可以是干净随机访问(Clean Random Access, CRA)、断开链路访问(Broken Link Access, BLA)或瞬时解码刷新(Instantaneous Decoding Refresh, IDR)访问单元。

##### 随机访问支持

除了 IDR 图像，HEVC 的 IRAP 图像的 NAL 单元头部(通过 NAL 单元类型)中也包括标识。支持三种类型的 IRAP 图像，即 IDR、CRA 和 BLA 图像: IDR 图像通常称为封闭图像组(closed group-of-pictures, closed-GOP)随机访问点，而 CRA 和 BLA 图像通常称为开放图像组(open-GOP)随机访问点。BLA 图像通常源于 CRA 图像处两个比特流或其部分的拼接，例如在流切换期间。为了使系统更好地使用 IRAP 图像，总共定义六种不同的 NAL 单元来表示 IRAP 图像的属性，这些 NAL 单元可用于更好地匹配 ISOBMFF [^IS014496-12] [^IS015444-12] 中定义的流访问点类型，该类型用于 3GP-DASH [^3GPDASH] 和 MPEG-DASH [^MPEGDASH] 中的随机访问支持。以解码顺序在 IRAP 图像之后、以输出顺序在 IRAP 图像之前的图像可参考用作与 IRAP 图像关联的前导图像。有两种类型的前导图像: 随机访问可解码前导(Random Access Decodable Leading, RADL)图像和随机访问跳过前导(Random Access Skipped Leading, RASL)图像。当在相关 IRAP 图像处开始解码时，RADL 图像是可解码的；当从相关的 IRAP 图像开始解码时，RASL 图像不可解码，通常会被丢弃。对于原始呈现的 RASL 图像已被丢弃的比特流，HEVC 提供了一些机制用来指定比特流的一致性。因此，系统组件可以在需要时丢弃 RASL 图像，而无需担心导致比特流不兼容。

##### 时间可伸缩性支持

HEVC 改进对时间可伸缩性的支持，通过在 NAL 单元头部包含 TemporalId 指示、限制特定时间子层的图像不能被较低时间子层的图像用于帧间预测参考、子比特流提取过程，以及要求每个子比特流提取输出是一致的比特流。媒体感知网络元素(Media-Aware Network Elements, MANE)可以基于时间可伸缩性，利用 NAL 单元头部的 TemporalId 进行流适配。

##### 时间子层交换支持

HEVC 通过 NAL 单元头部中的 NAL 单元类型指定时间子层访问(Temporal Sub-layer Access, TSA)和逐级时间子层访问(Step-wise Temporal Sub-layer Access, STSA)的标识。按照解码顺序，TSA 图像及其后的图像实现帧间预测参考，不使用该 TSA 图像之前，且 TemporalId 大于或等于该 TSA 图像的图像。TSA 图像使能在 TSA 图像处从直接较低的子层，向上切换到包含 TSA 图像的子层或任何较高的子层。STSA 图像不使用与其 TemporalId 相同的图像用作帧间预测参考。按照解码顺序，STSA 图像之后，且与其 TemporalId 相同的图像实现帧间预测参考，不使用该 STSA 图像之前，且与其 TemporalId 相同的图像。STSA 图像使能在 STSA 图像处从紧邻较低的子层向上切换到包含该 STSA 图像的子层。

##### 子层参考或非参考图像

HEVC 中参考/非参考图像的概念和指示不同于 H.264。在 H.264 中，如果图像可被任何其他图像用于帧间预测参考，则它是参考图画；否则，它是非参考图像，由 NAL 单元头部的两个比特标识。在 HEVC 中，只有当图像标记为“用于参考”时，才称为参考图像。此外，还引入了子层参考图像的概念。如果图像可被与其 TemporalId 相同的另一图像用于帧间预测参考，则该图像是子层参考图像；否则，它是一个子层非参考图像。图像是子层参考图像还是子层非参考图像都通过 NAL 单元类型值标识。

##### 扩展性

除了 NAL 单元头部中的 TemporalId，HEVC 还包括 NAL 单元头部六位层 ID 的标识，对于单层比特流，该 ID 必须等于 0。扩展机制包括在 VPS、SPS、图像参数集(PPS)、SEI NAL 单元、切片头部等。所有这些扩展机制以向后兼容的方式实现未来扩展，使得根据潜在的未来 HEVC 扩展编码的比特流可以馈送到随后的遗留解码器(例如，HEVC 版本 1 解码器)，并且随后的遗留解码器可以解码并输出基本层比特流。

##### 比特流提取

HEVC 包括比特流提取过程，作为整个解码过程的一个组成部分。比特流提取过程用于比特流一致性测试过程，这是 HRD 缓冲模型的一部分。

##### 参考图像管理

HEVC 的参考图像管理与 H.264 不同，包括参考图像标记和从解码图像缓冲区(Decoded Picture Buffer, DPB)移除以及参考图像列表构建(Reference Picture List Construction, RPLC)。H.264 中描述的基于滑动窗口加自适应内存管理控制操作(Memory Management Control Operation, MMCO)的参考图像标记机制不同，HEVC 指定了基于参考图像集(Reference Picture Set, RPS)的参考图像管理和标记机制，RPLC 由此基于 RPS 机制。RPS 由与图像相关的一组参考图像组成，由按照解码顺序在相关图像之前的所有参考图像组成，可用于相关图像或按照解码顺序在其之后的任何图像的帧间预测。参考图像集包括五个参考图像列表；RefPicSetStCurrBefore、RefPicSetStCurrAfter、RefPicSetStFoll、RefPicSetLtCurr 和 RefPicSetLtFoll。RefPicSetStCurrBefore、RefPicSetStCurrAfter 和 RefPicSetLtCurr 包含所有参考图像，可用于当前图像以及按解码顺序在其之后的一个或多个图像的帧间预测。RefPicSetStFoll 和 RefPicSetLtFoll 包含所有参考图像，不用于当前图像的帧间预测，但可用于按照解码顺序在其之后的一个或多个图像的帧间预测。RPS 提供 DPB 状态的“帧内编码”标识，而不是“帧间编码”标识，主要用于改进错误恢复能力。HEVC 中的 RPLC 过程基于 RPS，通过为每个参考索引标识 RPS 子集的索引；这个过程比 H.264 中的 RPLC 过程简单。

##### 超低延迟支持

HEVC 指定一个子图像级 HRD 操作，以支持所谓的超低延迟。该机制指定了一种标准兼容的方式，以使延迟减少到一个图像间隔以下。可以标识子图像级的编码图像缓冲区(Coded Picture Buffer, CPB)和 DPB 参数，并且指定将该信息用于 CPB 定时(其中 CPB 移除时间对应于解码时间)和 DPB 输出定时(显示时间)的推导。允许解码器在常规访问单元级操作 HRD，即使存在子画面级 HRD 参数。

##### 新 SEI 消息

HEVC 继承了许多 H.264 SEI 消息，并在语法和/或语义上进行了更改，使其适用于 HEVC。此外，以下段落简要回顾了一些新的 SEI 信息。

面向显示的 SEI 消息通知解码器建议在显示之前应用于裁剪的解码图像的变换，以便可以正确显示图像，例如以倒置的方式。

图像 SEI 消息的结构提供有关 NAL 单元类型、图像顺序计数值和图像序列的预测依赖性信息。例如，SEI 信息可用于总结一个丢失图像对其他图像的影响。

解码图像哈希 SEI 消息提供从解码图像的采样值导出的校验和。它可用于检测是否正确接收和解码图像。

活动参数集 SEI 消息包括活动视频参数集和活动序列参数集的 ID，可用于激活 VPS 和 SPSs。此外，SEI 消息包括以下指示: 

1) 指示是否支持“完全随机可访问性”(如果支持，当从当前 CVS 开始随机访问时，通过完全丢弃解码顺序中较早的所有访问单元，解码剩余比特流所需的所有参数集都存在于剩余比特流中，并且剩余比特流中的所有编码图像都可以正确解码)；
2) 指示当前 CVS 是否没有参数集，用于更新另一个按照解码顺序位于之前的相同类型的参数集。参数集的更新是指使用相同的参数集 ID，但更改了一些其他参数。如果此属性对于比特流中的所有 CVS 都为 true，则可以在会话开始之前将所有参数集带外发送。

解码单元信息 SEI 消息提供关于解码单元的编码图像缓冲区移除延迟的信息。该消息可用于极低延迟缓冲操作。

区域刷新信息 SEI 消息可以与恢复点 SEI 消息(在 H.264 和 HEVC 中都存在)一起使用，以改进对渐进解码刷新的支持。这支持从帧间编码图像的随机访问，其中可以在按输出/显示顺序指定数量的图像之后，正确解码或恢复完整图像。

#### 1.1.3 并行处理支持

据报道，HEVC 的编码计算需求明显高于 H.264，加上市场需要对视频分辨率(空间和时间)不断提高，导致采用了专门用于子图像级别并行化的 VCL 编码工具。也就是说，并行化至少以整数个 CTU 的粒度发生。这种高级并行化的目标是多核 CPU 和 DSP 以及多处理器系统。在系统设计中，为了便于使用，这些工具需要信号支持，这在本文第 7 节提供。本节简要概述了 [^HEVC] 中可用的工具。

HEVC 包含的许多工具的设计都考虑了多核/多处理器架构中潜在的并行实现。具体来说，对于并行化，可以使用如下所述的四种图像分区策略。

切片是比特流片段，可以独立于同一图像中的其他切片进行重建(尽管通过循环过滤操作可能仍然存在相互依赖性)。切片是唯一可以用于并行化的工具，它在 H.264 中以几乎相同的形式提供。基于切片的并行化不需要太多处理器间或核间通信(除了解码预测编码图像时用于运动补偿的处理器间或核间数据共享，这通常比图像内预测导致的处理器间或核间数据共享重得多)，因为切片设计为可独立解码。然而，出于同样的原因，切片可能需要一些编码开销。此外，片(与下面提到的一些其他工具相比)还作为比特流分区的关键机制，以匹配最大传输单元( Maximum Transfer Unit, MTU)大小要求，这是因为片的图像内独立性以及每个常规片封装在其自己的 NAL 单元中。在许多情况下，并行化的目标和 MTU 大小匹配的目标可能会对图像中的切片布局提出矛盾的要求。这种情况的实现导致了下面提到的更先进工具的开发。

依赖的切片分段允许在 CTU 边界处将编码切片分片，而不破坏任何图像内预测机制。它们是对本文描述的分片机制的补充，因为依赖的切片分段需要编码器的配合。由于依赖的切片分段必然包含整数个 CTU，因此使用多核操作 CTU 的解码器可以处理依赖的切片分段，而无需与其他核通信此切片分段比特流的一部分。相反，本文中规定的分片并不保证分片包含整数个 CTU。

在波前并行处理(Wavefront Parallel Processing, WPP)中，图像被分割成若干行 CTU。熵解码和预测允许使用来自其他分区 CTU 的数据。通过并行解码 CTU 行可以实现并行处理，其中一行解码的开始延迟两个 CTU，以确保在解码主体 CTU 之前，主体 CTU 上方和右侧的 CTU 相关的数据可用。使用这种交错启动(当以图形表示时，它看起来像一个波前)，可以最多使用与图像中包含的 CTU 行数相同的处理器/内核数进行并行化。

由于允许在图像内相邻 CTU 行之间进行图像内预测，因此实现图像内预测所需的处理器间/核间通信可能是大量的。与未应用时相比，WPP 分区不会导致创建更多 NAL 单位；因此，WPP 不能用于 MTU 大小匹配，尽管切片可以组合使用。

平铺(tile)定义将图像划分为平铺列和行的水平和垂直边界。在按照图像的平铺光栅扫描顺序解码下一个平铺的左上角 CTU 之前，CTU 的扫描顺序更改为平铺内局部的(按照平铺的 CTU 光栅扫描顺序)。与切片类似，平铺破坏了图像预测依赖性(包括熵解码依赖性)。但是，它们不需要包含在单独的 NAL 单元(这方面与 WPP 相同)；因此，平铺不能用于 MTU 大小匹配，尽管可以组合使用切片匹配 MTU 大小。每个平铺可由一个处理器/核处理，并且处理单元解码相邻平铺之间的图像内预测所需的处理器/核间通信限于传送共享的切片头部(在切片跨越多个平铺的情况下)，以及重构样本和元数据共享的循环过滤相关的。到目前为止，由于两个相邻分区之间的图像内独立性，与 WPP 相比，平铺对处理器间通信带宽的要求更低。

#### 1.1.4 NAL 单元头

HEVC 对 H.264 的 NAL 单元概念进行了修改。HEVC 使用两字节的 NAL 单元头，如图 1 所示。NAL 单元的载荷指除 NAL 单元头之外的 NAL 单元。

图 1: HEVC NAL 单元头部结构

```txt
+---------------+---------------+
|0|1|2|3|4|5|6|7|0|1|2|3|4|5|6|7|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|F|   Type    |  LayerId  | TID |
+-------------+-----------------+
```

NAL 单元头部字段的语义如 [^HEVC] 中所述，为方便起见，下文对其进行简要说明。除了每个字段的名称和大小外，[^HEVC] 还提供了相应的语法元素名称。

F(forbidden_zero_bit): 1 位。[^HEVC] 要求为零。请注意，在 NAL 单元头部包含该位是为了使能通过  MPEG-2 传输系统传输 HEVC 视频(避免模拟起始码) [^MPEG2S]。本文中，值 1 可用于表示语法冲突，例如第 4.4.3 节所述，对于因聚合 一个 NAL 单元的多个分片单元但缺少最后一个分片而生成的 NAL 单元。

Type(nal_unit_type): 6 位。该字段指定 [^HEVC] 表 7-1 中定义的 NAL 单元类型。如果 NAL 单元该字段的最高有效位等于 0(即该字段的值小于 32)，则此 NAL 单元是 VCL NAL 单元。否则，NAL 单元是非 VCL NAL 单元。有关所有当前定义的 NAL 单元类型及其语义的参考，请参考 [^HEVC] 的第 7.4.2 节。

LayerId(nuh_layer_id): 6 位。[^HEVC] 要求为零。预计在本规范的未来可伸缩或三维视频编码扩展中，该语法元素将用于识别 CVS 中可能存在的附加层，其中层可以是例如空间可伸缩层、质量可伸缩层、纹理视图或深度视图。

TID（nuh_temporal_id_plus1）: 3 位。此字段指定 NAL 单元的时间标识符加 1。TemporalId 的值等于 TID 减去 1。TID 值为 0 是非法的，以确保 NAL 单元头部至少有一位等于 1，从而使能独立考虑 NAL 单元头部和 NAL 单元载荷数据中的起始码模拟。

### 1.2 载荷格式概述

此载荷格式定义了以下过程，用于通过 RTP [^RFC3550] 传输 HEVC 编码数据: 

- 使用此载荷格式的 RTP 头部
- 使用三种载荷结构将 HEVC 编码的 NAL 单元打包成 RTP 数据包: 单 NAL 单元数据包、聚合数据包和分片单元
- 在单个 RTP 流或多个 RTP 流(在一个或多个RTP会话内)内传输同一比特流的 HEVC NAL 单元，其中在 RTP 流内，NAL 单元的传输可以是非交织(即，NAL 单元的传输顺序与其解码顺序相同)或交织(即，NAL 单元的传输顺序不同于解码顺序)
- 与会话描述协议(Session Description Protocol, SDP)一起使用的媒体类型参数 [^RFC4566]
- 一种载荷头部扩展机制和数据结构，用于基于该扩展机制增强对时间可伸缩性的支持

## 2 惯例

本文中的关键词“必须”、“不得”、“要求”、“应”、“不应”、“建议”、“可”和“可选”应按照 [^RFC2119] BCP 14 中所述进行解释。

当处理位字段时，此规范使用设置和清除位。设置位等于该位赋值为 1(On)。清除位等于该位赋值为 0(Off)。

## 3 定义和缩写

本文使用 [^HEVC] 的术语和定义。方便起见，第 3.1.1 节列出了 [^HEVC] 中的相关定义。第 3.1.2 节提供了本文的特定定义。

### 3.1 定义

#### 3.1.1 HEVC 规范中的定义

##### 访问单元

access unit: 根据指定的分类规则相互关联的一组 NAL 单元，它们在解码顺序上是连续的，并且只包含一个编码图像。

##### BLA 访问单元

BLA access unit: 其中编码图像为 BLA 图像的访问单元。

##### BLA 图像

BLA picture: 每个 VCL NAL 单元的 nal_unit_type 等于 BLA_W_LP、BLA_W_RADL 或 BLA_N_LP 的 IRAP 图像。

##### 编码视频序列(CVS)

Coded Video Sequence: 一个访问单元序列，按解码顺序，由一个 NoRaslOutputFlag 等于 1 的 IRAP 访问单元，及其后 NoRaslOutputFlag 等于 1 的非 IRAP 访问单元的零个或多个访问单元组成，包括所有后续访问单元，直到不包括 NoRaslOutputFlag 等于 1 的 IRAP 访问单元。

  信息说明: IRAP 访问单元可以是 IDR 访问单元、BLA 访问单元或 CRA 访问单元。对于每个 IDR 访问单元、每个 BLA 访问单元和每个 CRA 访问单元，NoRaslOutputFlag 值等于 1，它们是位流中以解码顺序排列的第一个访问单元，是以解码顺序排列在序列结束 NAL 单元之后的第一个访问单元，或者 HandleCraAsBlaFlag 等于 1。

##### CRA 访问单元

CRA access unit: 其中编码图像为 CRA 图像的访问单元。

##### CRA 图像

CRA picture: 每个 VCL NAL 单元的 nal_unit_type 等于 CRA_NUT 的 RAP 图像。

##### IDR 访问单元

IDR access unit: 其中编码图像为 IDR 图像的访问单元。

##### IDR 图像

IDR picture: 每个 VCL NAL 单元的 nal_unit_type 等于 IDR_W_RADL 或 IDR_N_LP 的 RAP 图像。

##### IRAP 访问单元

IRAP access unit: 其中编码图像为 IRAP 图像的访问单元。

##### IRAP 图像

IRAP picture: 每个 VCL NAL 单元的 nal_unit_type 在 BLA_W_LP(16) 到 RSV_IRAP_VCL23(23) 范围内的编码图像。

##### 层

layer: 一组 VCL NAL 单元，它们都具有特定的 nuh_layer_id 值和相关的非 VCL NAL 单元，或具有层次关系的一组语法结构之一。

##### 操作点

operation point: 通过操作子比特流提取过程从另一个比特流创建的比特流，使用另一个比特流、目标 TemporalId 和目标层标识符列表作为输入。

##### 随机访问

random access: 在比特流起始点以外的点开始比特流解码过程的行为。

##### 子层

sub-layer: 时间可伸缩比特流的时间可伸缩层，由具有特定 TemporalId 变量值的 VCL NAL 单元和相关的非 VCL NAL 单元组成。

##### 子层表示

sub-layer representation: 由特定子层和较低子层的 NAL 单元组成的比特流子集。

##### 平铺

tile: 图像中特定平铺列和特定平铺行内编码树块的矩形区域。

##### 平铺列

tile column: 编码树块的矩形区域，其高度等于图像的高度，宽度由图像参数集中的语法元素指定。

##### 平铺行

tile row: 编码树块的矩形区域，其高度由图像参数集中的语法元素指定，宽度等于图像的宽度。

#### 3.1.2 本文的特定定义

##### 被依赖 RTP 流

dependee RTP stream: 另一个 RTP 流所依赖的 RTP 流。单媒体传输多 RTP 流(Multiple RTP streams on a Single media Transport, MRST)或多媒体传输多 RTP 流(Multiple RTP streams on Multiple media Transports, MRMT)中的所有 RTP 流(最高 RTP 流除外)都是被依赖 RTP 流。

##### 最高 RTP 流

highest RTP stream: 没有其他 RTP 流依赖的 RTP 流。单媒体传输单 RTP 流(Single RTP stream on a Single media Transport, SRST)中的 RTP 流是最高 RTP 流。

##### 媒体感知网络元素(MANE)

Media-Aware Network Element: 一种网络元素，比如中间盒、选择性转发单元或应用层网关，能够解析 RTP 载荷头部或 RTP 载荷的某些方面，并对内容作出反应。

  信息说明: MANE 的概念超出了普通路由器或网关的范围，因为 MANE 必须了解信令(比如，了解媒体流的载荷类型映射)并在使用安全实时传输协议(Secure Real-time Transport Protocol, SRTP)时必须信任 MANE。使用 MANE 的优点是它们允许根据媒体编码的需要丢弃数据包。例如，如果某个 MANE 由于某条链路拥塞而不得不丢弃数据包，它可以识别并删除那些消除之后对用户体验产生最小不利影响的数据包。丢弃数据包后，MANE 必须重写 RTCP 数据包以匹配 RTP 流的更改，如 [^RFC3550] 第 7 节所述。

##### 媒体传输

Media Transport: 正如下面的 MRST、MRMT 和 SRST 定义中所使用的，媒体传输表示通过 5 元组(源地址、源端口、目标地址、目标端口、传输协议)标识的传输关系传输数据包。另见 [^RFC7656] 第 2.1.13 节。

  信息说明: 本文中的术语“比特流”等同于 [^RFC7656] 中的术语“编码流”。

##### 单媒体传输多 RTP 流(MRST)

Multiple RTP streams on a Single media Transport: 在单个传输上承载单个 HEVC 比特流的多个 RTP 流。另见 [^RFC7656] 第 3.5 节。

##### 多媒体传输多 RTP 流(MRMT)

Multiple RTP streams on Multiple media Transports, MRMT: 多个传输上承载单个 HEVC 比特流的多个 RTP 流。另见 [^RFC7656] 第 3.5 节。

##### NAL 单元解码顺序

NAL unit decoding order: NAL 单元顺序符合 [^HEVC] 第 7.4.2.4 节中给出的 NAL 单元顺序约束。

##### NAL 单元输出顺序

NAL unit output order: 一种 NAL 单元顺序，其中不同访问单元的 NAL 单元是访问单元对应的解码图像的输出顺序(正如 [^HEVC] 规定)，并且访问单元内的 NAL 单元按照其解码顺序。

##### 类 NAL 单元结构

NAL-unit-like structure: 一种与 NAL 单元相似的数据结构，即它也有一个 NAL 单元头和一个载荷，不同之处在于载荷不遵循起始码模拟预防机制，这是 [^HEVC] 第 7.3.1.1 节中规定的 NAL 单元语法所需的。本文定义的类 NAL 单元结构的示例为聚合数据包(Aggregation Packet, AP)、载荷内容信息(PAyload Content Information, PACI)和分片单元(Fragmentation Unit, FU)数据包的包载荷。

##### NALU 时间

NALU-time: 如果 NAL 单元将在其自己的 RTP 数据包中传输，则 RTP 时间戳将具有的值。

##### RTP 流

RTP stream: 请参阅 [^RFC7656] 。在本文的范围内，一个 RTP 流用于传输一个或多个时间子层。

##### 单媒体传输单 RTP 流(SRST)

Single RTP stream on a Single media Transport: 单个(媒体)传输上承载单个 HEVC 比特流的单个 RTP 流。另见 [^RFC7656] 第 3.5 节。

##### 传输顺序

transmission order: 以 RTP 序列号(模运算)升序排列的数据包顺序。在聚合数据包内，NAL 单元传输顺序与数据包中 NAL 单元的出现顺序相同。

### 3.2 缩写

AP Aggregation Packet 聚合包

BLA Broken Link Access 断开链接访问

CRA Clean Random Access 干净随机访问

CTB Coding Tree Block 编码树块

CTU Coding Tree Unit 编码树单元

CVS Coded Video Sequence 编码视频序列

DPH Decoded Picture Hash 解码图像哈希

FU Fragmentation Unit 分片单元

HRD Hypothetical Reference Decoder 假设参考解码器

IDR Instantaneous Decoding Refresh 瞬时解码刷新

IRAP Intra Random Access Point 帧内随机访问点

MANE Media-Aware Network Element 媒体感知网络元素

MRMT Multiple RTP streams on Multiple media Transports 多媒体传输多 RTP 流

MRST Multiple RTP streams on a Single media Transport 单媒体传输多 RTP 流

MTU Maximum Transfer Unit 最大传输单元

NAL Network Abstraction Layer 网络抽象层

NALU Network Abstraction Layer Unit 网络抽象层单元

PACI PAyload Content Information 载荷内容信息

PHES Payload Header Extension Structure 载荷头扩展结构

PPS Picture Parameter Set 图像参数集

RADL Random Access Decodable Leading (Picture) 随机访问可解码前导(图像)

RASL Random Access Skipped Leading (Picture) 随机访问跳过前导(图像)

RPS Reference Picture Set 参考图像集

SEI Supplemental Enhancement Information 补充增强信息

SPS Sequence Parameter Set 序列参数集

SRST Single RTP stream on a Single media Transport 单媒体传输单 RTP 流

STSA Step-wise Temporal Sub-layer Access 逐级时间子层访问

TSA Temporal Sub-layer Access 时间子层访问

TSCI Temporal Scalability Control Information 时间可伸缩性控制信息

VCL Video Coding Layer 视频编码层

VPS Video Parameter Set 视频参数集

## 4 RTP 载荷格式

### 4.1 RTP 头部用法

RTP 头部格式在 [^RFC3550] 中定义(方便起见在图 2 重新绘制)。此载荷格式使用头部字段的方式和该规范一致。

对于聚合包和分片单元的RTP 载荷(以及某些 RTP 头部位的设置)分别在 4.4.2 和 4.4.3 节中指定。

图 2: 根据 [^RFC3550] 的 RTP 头部

```txt
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|V=2|P|X|   CC  |M|     PT      |       sequence number         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                           timestamp                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           synchronization source (SSRC) identifier            |
+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+
|            contributing source (CSRC) identifiers             |
|                           ....                                |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

根据此 RTP 载荷格式设置 RTP 头信息如下:

- 标记位(Marker bit, M): 1 位。为当前 RTP 流携带的访问单元的最后一个数据包设置此位，符合视频格式中 M 位的正常使用，以允许有效的处理播放缓冲区。当使用 MRST 或 MRMT 时，如果一个访问单元出现在多个 RTP 流中，则访问单元每个 RTP 流的最后一个分组上设置标记位。

  信息说明: NAL 单元的内容不能说明 NAL 单元是否是访问单元的最后一个 NAL 单元(按解码顺序)。RTP发送者实现可从视频编码器获得该信息。然而，如果实现不能直接从编码器获得该信息，例如，当比特流被预编码，并且没有为每个 NAL 单元分配时间戳，那么，发送者实现可以检查后续(按解码顺序)的 NAL 单元，以便如下确定 NAL 单元是否是访问单元的最后一个 NAL 单元。如果 NAL 单元是比特流的最后一个 NAL 单元，则将其确定为访问单元的最后一个 NAL 单元。如果以下两个条件均为真，则 NAL 单元 naluX 也被确定为访问单元的最后一个 NAL 单元:
  
  1) 解码顺序中的下一个 VCL NAL 单元 naluY 在其 NAL 单元头之后的第一个字节的高阶位等于 1
  2) naluX 和 naluY 之间的所有 NAL 单元(当存在时)，nal_unit_type 在 32 到 35 之间(含 32 和 35)，等于 39，或在 41 到 44 之间(含 41 和 44)，或 48 到 55 之间(含 48 和 55)。

- 载荷类型(Payload type, PT): 7 位。为这种新的数据包格式分配 RTP 载荷类型超出本文档的范围，不在此处指定。载荷类型的分配必须通过使用的配置文件或以动态方式执行。
  
  信息说明: 对于 MRST 或 MRMT 中的不同 RTP 流，不需要使用不同的载荷类型值。

- 序列号(Sequence number, SN): 16 位。根据 [^RFC3550] 设置和使用。
- 时间戳(Timestamp): 32 位。RTP 时间戳设置为内容的采样时间戳。**必须**使用 90 kHz 的时钟频率。
  
  如果 NAL 单元没有自己的时间属性(比如参数集和 SEI NAL 单元)，则 RTP 时间戳设置为包含 NAL 单元的访问单元的基本编码图像的 RTP 时间戳(根据 [^HEVC] 的 7.4.2.4.4 章节)。

  接收者**必须**为显示过程使用 RTP 时间戳，即使比特流包含 [^HEVC] 中规定的图像时序 SEI 消息或解码单元信息 SEI 消息。然而，这并不意味着应当丢弃比特流中的图像时序 SEI 消息，因为图像时序 SEI 消息可能包含帧场信息，在适当渲染隔行视频中是重要的。

- 同步源(SSRC): 32 位。用于标识 RTP 数据包的源。使用 SRST 时，根据定义，单个 SSRC 用于单个比特流的所有部分。在 MRST 或 MRMT 中，不同的 ssrc 用于每个 RTP 流，包含单个(时间可伸缩)比特流的子层子集的。接收者需要正确关联包含在同一比特流部分中的 SSRC 集。

### 4.2 载荷头部用法

RTP 数据包载荷的前两个字节称为载荷头部。如第 1.1.4 节所示，无论载荷结构的类型如何，载荷头部包含与NAL 单元头部相同的字段(F、Type、LayerId 和 TID)。

TID 值指示(除其他外) RTP 包的相对重要性，例如，因为属于较高时间子层的 NAL 单元不用于较低时间子层的解码。TID 值越低表示重要性越高。与不太重要的 NAL 单元相比，更重要的 NAL 单元可以更好地防止传输损耗。

### 4.3 传输模式

本文允许通过以下方式传输 HEVC 比特流:

- 单媒体传输单 RTP 流(SRST)
- 单媒体传输多 RTP 流(MRST)
- 多媒体传输多 RTP 流(MRMT)

  信息说明: 虽然本规范允许在 H.265 RTP 载荷内使用 MRST，但在撰写本文时，SDP Offer/Answer 内的 MRST 信令并未完全规定。参见 [^RFC5576] 和 [^RFC5583] 了解当前支持的内容，参见 [^RTP-MULTI-STREAM] 和 [^SDP-NEG] 了解未来的方向。

在 MRMT 中，一个 RTP 流对另一个 RTP 流的依赖性通常如 [^RFC5583] 中所述。[^RFC5583] 也可用于指定 MRST 内的依赖关系，但仅当 RTP 流使用不同的载荷类型时。

SRST 或 MRST **应该**应用于点对点单播场景，而 MRMT **应该**应用于点对多点多播场景，其中不同的接收者需要相同 HEVC 比特流的不同操作点，以提高带宽利用效率。

  信息说明: 在除一个接收者外的所有接收者都离开后，多播可降级为单播(这是第一个“应该”而不是“必须”的理由)，并且可能存在需要 MRMT 但不可能的情况，例如，当 IP 多播未部署在特定网络中时(这是第二个“应该”而不是“必须”的理由)。

传输模式由 tx-mode 媒体参数指示(见第 7.1 节)。如果 tx-mode 等于 “SRST”，则**必须**使用 SRST。否则，如果 tx-mode 等于 “MRST”，则**必须**使用 MRST。否则(tx-mode 等于 “MRMT”)，**必须**使用 MRMT。

  信息说明: 当 RTP 流不依赖于其他 RTP 流时，RTP 流可以使用 SRST、MRST 或 MRMT 中的任何一个。

接收者**必须**支持所有 SRST、MRST 和 MRMT。

  信息说明: 接收者对 MRMT 的必要支持并不意味着接收者必须支持多播。

### 4.4 载荷结构

定义了四种不同类型的 RTP 数据包载荷结构。接收者可以通过载荷头部中的 Type 字段识别 RTP 包载荷的类型。

四种不同的载荷结构如下所示:

- 单 NAL 单元数据包(Single NAL Unit Packet)：载荷中包含单个 NAL 单元，并且 NAL 单元的 NAL 头部 也用作载荷头部。第 4.4.1 节规定了该载荷结构。
- 聚合数据包(AP)：在一个访问单元中包含多个 NAL 单元。第 4.4.2 节规定了该载荷结构。
- 分片单元(FU)：包含单个 NAL 单元的子集。第 4.4.3 节规定了该载荷结构。
- PACI 承载 RTP 包(PACI carrying RTP packet): 包含一个载荷头部(出于效率与其他载荷头部不同)、一个载荷头部扩展结构(Payload Header Extension Structure, PHES)和一个 PACI 载荷。第 4.4.4 节规定了该载荷结构。

#### 4.4.1 单 NAL 单元数据包

单 NAL 单元数据包只包含一个 NAL 单元，它由一个载荷头部(表示为 PayloadHdr)、一个有条件的 16 位 DONL 字段(以网络字节顺序)和所包含 NAL 单元的 NAL 单元载荷数据(包括其 NAL 单元头部)组成，如图 3 所示。

图 3: 单 NAL 单元数据包的结构

```txt
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           PayloadHdr          |      DONL (conditional)       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
|                  NAL unit payload data                        |
|                                                               |
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :...OPTIONAL RTP padding        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

载荷头部**应该**是所包含 NAL 单元的 NAL 单元头部的精确副本。然而，例如，当希望将 CRA 图像处理为 BLA 图像时，Type(即 nal_unit_type)字段**可以**改变 [^JCTVC-J0107]。

DONL 字段(当存在时)指定所包含 NAL 单元的解码顺序号的 16 个最低有效位的值。如果任何 RTP 流的 sprop-max-don-diff 大于 0，则**必须**存在 DONL 字段，并且所包含 NAL 单元的变量 DON 将被推导为等于 DONL 字段的值。否则(对于所有 RTP 流，sprop-max-don-diff 等于 0)，DONL 字段**不能**存在。

#### 4.4.2 聚合包(AP)

引入聚合包(AP)是为了减少小型 NAL 单元(如大多数非 VCL NAL 单元)的封包开销，这些 NAL 单元通常只有几个八位字节。

AP 在聚合一个访问单元内的 NAL 单元。AP 中要携带的每个 NAL 单元被封装在聚合单元中。在一个 AP 中聚合的 NAL 单元以 NAL 单元解码顺序。

AP 由一个负载头(表示为 PayloadHdr)和其后两个或多个聚合单元组成，如图 4 所示。

图4: 聚合包的结构

```txt
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    PayloadHdr (Type=48)       |                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |
|                                                               |
|             two or more aggregation units                     |
|                                                               |
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :...OPTIONAL RTP padding        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

负载头部的字段设置如下：如果每个聚合 NAL 单元的 F 位等于零，则 F 位**必须**等于 0；否则，它**必须**等于 1。Type 字段**必须**等于 48。LayerId 的值**必须**等于所有聚合 NAL 单元中 LayerId 的最低值。TID 值**必须**是所有聚合 NAL 单元中 TID 的最低值。

  信息说明: AP 中的所有 VCL NAL 单元都具有相同的 TID 值，因为它们属于相同的访问单元。然而，AP 可能包含非 VCL NAL 单元，其中 NAL 单元头中的 TID 值可能不同于同一 AP 中 VCL NAL 单元的 TID 值。

AP **必须**携带至少两个聚合单元，并且可以根据需要携带任意多个聚合单元；然而，AP 中的数据总量显然**必须**适合 IP 数据包，并且**应该**选择大小，以使生成的 IP 数据包小于 MTU 大小，从而避免 IP 层分片。AP **不能**包含第 4.4.3 节中规定的 FU。AP 不得嵌套；例如，一个 AP 不得包含另一个 AP。

AP 中的第一个聚合单元由一个有条件的 16 位 DONL 字段(按网络字节顺序)和一个 16 位无符号大小信息(按网络字节顺序)组成，该信息表示 NAL 单元的大小(单位字节，不包括这两个八位字节，但包括 NAL 单元头)，然后是 NAL 单元本身，包括其 NAL 单元头，如图 5 所示。

图 5: AP 中第一个聚合单元的结构

```txt
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                :       DONL (conditional)      |   NALU size   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   NALU size   |                                               |
+-+-+-+-+-+-+-+-+         NAL unit                              |
|                                                               |
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

DONL 字段(当存在时)指定聚合的 NAL 单元的解码顺序号的 16 个最低有效位的值。

如果任何 RTP 流的 sprop-max-don-diff 大于 0，则 AP 中的第一个聚合单元**必须**存在 DONL 字段，并且推导聚合 NAL 单元的变量 DON 等于 DONL 字段的值。否则(对于所有 RTP 流，sprop-max-don-diff 等于0)，AP 中的第一个聚合单元**不能**存在 DONL 字段。

不是 AP 中第一个聚合单元的聚合单元由有条件的 8 位 DOND 字段和其后 16 位无符号大小信息(按网络字节顺序)组成，该信息表示 NAL 单元的大小(单位字节，不包括这两个八位字节，但包括 NAL 单元头)，其后是 NAL 
单元本身，包括其 NAL 单元头，如图 6 所示。

图6: 不是 AP 中第一个聚合单元的聚合单元的结构

```txt
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                : DOND (cond)   |          NALU size            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
|                       NAL unit                                |
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

当存在时，DOND 字段加 1 指定同一 AP 中当前聚合 NAL 单元和前一聚合 NAL 单元的解码顺序号值之间的差值。

如果任何 RTP 流的 sprop-max-don-diff 大于0，则不是 AP 中第一个聚合单元的聚合单元中**必须**存在 DOND 字段，并且推导聚合 NAL 单元的变量 DON 等于`(同一 AP 中先前聚合 NAL 单元的 DON + DOND + 1) % 65536`。否则(所有 RTP 流 sprop-max-don-diff 等于 0)，不是 AP 中第一个聚合单元的聚合单元中**不能**出现DOND 字段，在这种情况下，AP 中携带的 NAL 单元的传输顺序和解码顺序与 NAL 单元在 AP 中出现的顺序相同。

图 7 显示了一个 AP 示例，该 AP 包含两个聚合单元，在图中标记为 1 和 2，不存在 DONL 和 DOND 字段。

图 7: 包含两个聚合单元的 AP 数据包示例，其中没有 DONL 和 DOND 字段

```txt
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          RTP Header                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   PayloadHdr (Type=48)        |         NALU 1 Size           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          NALU 1 HDR           |                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+         NALU 1 Data           |
|                   . . .                                       |
|                                                               |

+               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  . . .        | NALU 2 Size                   | NALU 2 HDR    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| NALU 2 HDR    |                                               |
+-+-+-+-+-+-+-+-+              NALU 2 Data                      |
|                   . . .                                       |
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :...OPTIONAL RTP padding        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

图 8 显示了一个 AP 示例，该 AP 包含两个聚合单元，在图中标记为 1 和 2，并且存在 DONL 和 DOND 字段。

图 8: 包含两个聚合单元的 AP 示例，其中包含 DONL 和 DOND 字段

```txt
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          RTP Header                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   PayloadHdr (Type=48)        |        NALU 1 DONL            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          NALU 1 Size          |            NALU 1 HDR         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
|                 NALU 1 Data   . . .                           |
|                                                               |
+     . . .     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|               |  NALU 2 DOND  |          NALU 2 Size          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          NALU 2 HDR           |                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+          NALU 2 Data          |
|                                                               |
|        . . .                  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :...OPTIONAL RTP padding        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

#### 4.4.3 分片单元

引入分片单元(FU)可将单个 NAL 单元分段为多个 RTP 数据包，可能无需配合或了解 HEVC 编码器。NAL 单元的分片由该 NAL 单元的整数个连续八位字节组成。同一 NAL 单元的分片**必须**以 RTP 序列号递增的连续顺序发送(在第一个分片和最后一个分片之间不能发送同一 RTP 流中的其他 RTP 数据包)。

当 NAL 单元被分片并在 FU 内传送时，它被称为分片 NAL 单元。AP **不能**被分片。FU **不能**嵌套；例如，一个 FU 不能包含另一个 FU 的子集。

携带 FU 的 RTP 包的 RTP 时间戳被设置为分片 NAL 单元的 NALU 时间。

FU 由载荷头(表示为 PayloadHdr)、一个八位字节的 FU 头、一个有条件 16 位 DONL 字段(以网络字节顺序)和一个 FU 载荷组成，如图 9 所示。

图 9: FU 的结构

```txt
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    PayloadHdr (Type=49)       |   FU header   | DONL (cond)   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-|
| DONL (cond)   |                                               |
|-+-+-+-+-+-+-+-+                                               |
|                         FU payload                            |
|                                                               |
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :...OPTIONAL RTP padding        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

载荷头部的字段设置如下。Type 字段**必须**等于 49。字段 F、LayerId 和 TID **必须**分别等于分片 NAL 单元的字段 F、LayerId 和 TID。

FU 头由一个 S 位、一个 E 位和一个 6 位 FuType 字段组成，如图 10 所示。

图 10: FU 头的结构

```txt
+---------------+
|0|1|2|3|4|5|6|7|
+-+-+-+-+-+-+-+-+
|S|E|  FuType   |
+---------------+
```

FU 头字段的语义如下所示:

- S: 1 位。当设置为 1 时，S 位表示分片 NAL 单元的开始，即 FU 载荷的第一个字节也是分片 NAL 单元载荷的第一个字节。当 FU 载荷不是分片 NAL 单元载荷的开始时，S 位**必须**设置为 0。
- E: 1 位。当设置为 1 时，E 位表示分片 NAL 单元的结束，即载荷的最后一个字节也是分片 NAL 单元的最后一个字节。当 FU 载荷不是分片 NAL 单元的最后一个分片时，E 位**必须**设置为 0。
- FuType: 6位。字段 FuType **必须**等于分片 NAL 单元的 Type 字段。

DONL 字段(当存在时)指定分片 NAL 单元的解码顺序号的 16 个最低有效位的值。

如果任何 RTP 流的 sprop-max-don-diff 大于 0，且 S 位等于 1，则 FU 中**必须**存在 DONL 字段，并且推导分片 NAL 单元的变量 DON 等于 DONL 字段的值。否则(对于所有 RTP 流，sprop-max-don-diff 等于 0，或者 S 位等于 0)，FU 中**不能**存在 DONL 字段。

非分片 NAL 单元**不能**在一个 FU 中传输；例如，同一 FU 头部，起始位和结束位不得同时设置为 1。

FU 载荷由分片 NAL 单元的载荷的分片组成，因此，如果顺序连接连续 FU 的 FU 载荷(从 S 位等于 1 的 FU 开始，到 E 位等于 1 的 FU 结束)，则可以重构分片 NAL 单元的载荷。FU 载荷中不包括分片 NAL 单元的 NAL 单元头部，但是分片 NAL 单元的 NAL 单元头部的信息在 FU 的 FU 载荷头部的 F、LayerId 和 TID 字段，以及 FU 的 FU 头部的 FuType 字段中传送。FU 载荷**不能**为空。

如果 FU 丢失，则接收者**应该**按照传输顺序丢弃所有后续对应同一分片 NAL 单元的分片单元，除非已知接收者中的解码器准备好优雅地处理不完整的 NAL 单元。

端点或 MANE 中的接收者可以将 NAL 单元的前 n-1 个分片聚合为(不完整的) NAL 单元，即使没有接收到该 NAL 单元的分片 n。在这种情况下，NAL 单元的 forbidden_zero_bit 必须设置为 1，以指示语法冲突。

#### 4.4.4 PACI 包

本节指定 PACI 数据包结构。本文指定的基本载荷头部有意限制为 NAL 单元头部的 16 位，以便将打包开销保持在最小。然而，已经确定了一些情况，其中建议在数据包头部中容易访问的位置包括控制信息，尽管存在额外的开销。第 4.5 节规定的 TSCI 就是此类控制信息之一。PACI 数据包携带这种和未来类似的结构。

PACI 数据包结构基于负载头部扩展机制，该机制是通用的，可扩展以携带负载头部扩展。在本节中，重点在于本规范中的使用。第 4.4.4.2 节为规范设计人员提供了如何在未来规范中使用扩展机制的指导。

PACI 数据包由载荷头部(表示为 PayloadHdr)组成，其结构如第 4.2 节所述。载荷头后面是字段 A、cType、PHSsize、F[0..2]和Y。

图 11 显示了符合本文的 PACI 数据包，即没有任何扩展。

图 11: PACI 的结构

```txt
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    PayloadHdr (Type=50)       |A|   cType   | PHSsize |F0..2|Y|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|        Payload Header Extension Structure (PHES)              |
|=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=|
|                                                               |
|                  PACI payload: NAL unit                       |
|                   . . .                                       |
|                                                               |
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :...OPTIONAL RTP padding        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

载荷头部的字段设置如下。F 位**必须**等于0。Type 字段**必须**等于 50。LayerId 值**必须**是 PACI 载荷 NAL 单元或类 NAL 单元的结构的 LayerId 字段的副本。TID 的值**必须**是 PACI 载荷 NAL 单元或类 NAL 单元结构的 TID 字段的副本。

其他字段的语义如下所示:

- A: 1 位。拷贝PACI 载荷 NAL 单元或类 NAL 单元的结构的 F 位。
- cType: 6 位。拷贝 PACI 载荷 NAL 单元或类 NAL 单元结构的 Type 字段。
- PHSsize: 5 位。表示 PHES 字段的长度。该值限制为小于或等于 32 个八位字节，以简化 MTU 大小匹配的编码器设计。
- F0: 该字段等于 1，指定 PHE 中存在时间可伸缩性支持扩展。
- F1、F2: **必须**为 0，可用于将来的扩展，请参见第 4.4.4.2 节。符合此版本 HEVC 载荷格式的接收者**必须**忽略 F1=1 和/或 F2=1，并且忽略由 F1=1 和/或 F2=1 指示的 PHE 中的任何信息。

  信息说明: 接收者可以通过首先解码与F0=1相关联的信息，然后基于PHSsize的值跳过PHE的任何剩余字节来实现。

- Y: 1 位。**必须**为 0，可用于将来的扩展，请参见第 4.4.4.2 节。符合此版本 HEVC 载荷格式的接收者**必须**忽略 Y=1，并且忽略 Y 指示的 PHES 中的任何信息。
- PHES: 可变八位字节数。PHSsize 值指示的可变八位字节数。
- PACI 载荷: 要携带的单个 NAL 单元数据包或 类 NAL 单元结构(例如: FU 或 AP)，不包括前两个八位字节。
  
  信息说明: PACI 载荷中携带的 NAL 单元或类 NAL 单元结构的前两个八位字节不包括在 PACI 载荷中。相反，在 RTP 包的 PayloadHdr 位置复制相应的值。这种设计提供了两个优点: 首先，保留了载荷头部的整体结构，即不需要为 PACI 载荷头部结构实现特殊情况。其次，不引入额外的开销。

PACI 载荷**可以**是单个 NAL 单元、FU 或 AP。PACI **不能**被分片或聚合。以下小节记录了这些设计选择的原因。

##### 4.4.4.1 PACI 规则的原因(资料性)

##### 4.4.4.2 PACI 扩展(资料性)

### 4.5 时间可扩展性控制信息

本节描述了本规范中定义的单一载荷头部扩展，称为 TSCI。如果将来需要额外的载荷头部扩展，可以在本文档更新版本的本节中或在其自己的文档中指定这些扩展。

当在 PACI 中将 F0 设置为 1 时，指定 PHES 字段包括 TSCI 字 段 TL0PICIDX、IrapPicID、S 和 E，如下所示:

图 12: 含 TSCI 的 PHES 的 PACI 结构

```txt
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    PayloadHdr (Type=50)       |A|   cType   | PHSsize |F0..2|Y|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   TL0PICIDX   |   IrapPicID   |S|E|    RES    |               |
|-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+               |
|                           ....                                |
|               PACI payload: NAL unit                          |
|                                                               |
|                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                               :...OPTIONAL RTP padding        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

- TL0PICIDX(8 位): 当存在时，TL0PICIDX 字段**必须**设置为等于 temporal_sub_layer_zero_idx，[^HEVC] 第 D.3.22 节中针对 PACI 中包含 NAL 单元的访问单元规定。
- IrapPicID(8 位): 当存在时，**必须**将 IrapPicID 字段设置为等于 irap_pic_id，[^HEVC] 第 D.3.22 节中针对 PACI 中包含 NAL 单元的访问单元规定。
- S(1 位): 如果以下任一条件为真，则 S 位**必须**设置为 1，否则**必须**设置为 0:
  - PACI 载荷中的 NAL 单元是图像的第一个 VCL NAL 单元(按解码顺序)。
  - PACI 载荷中的 NAL 单元是 AP，并且第一个包含的聚合单元中的 NAL 单元是图像的第一个 VCL NAL 单元(按解码顺序)。
  - PACI 载荷中的 NAL 单元是 FU，且其 S 位等于 1，并且 FU 载荷包含图像的第一个 VCL NAL 单元的片段(按解码顺序)。
- E(1 位): 如果以下任一条件为真，则 E 位**必须**设置为 1，否则**必须**设置为 0:
  - PACI 载荷中的 NAL 单元是图像的最后一个 VCL NAL 单元(按解码顺序)。
  - PACI 载荷中的 NAL 单元是 AP，最后一个包含的聚合单元中的 NAL 单元是图像的最后一个 VCL NAL 单元(按解码顺序)。
  - PACI 载荷中的 NAL 单元是 FU，且其 E 位等于 1，并且 FU 载荷包含图像的最后一个 VCL NAL 单元的片段(按解码顺序)。
- RES(6 位): **必须**等于 0。保留供将来扩展。

PHSsize 的值**必须**设置为 3。接收者**必须**允许字段 F0、F1、F2、Y 和 PHSsize 的其他值，并且**必须**忽略除上述 PHES 中规定之外的任何其他字段(如果存在)。

### 4.6 解码顺序号

对于每个 NAL 单元，导出变量 AbsDon 表示解码顺序号，指示 NAL 单元解码顺序。

假设 NAL 单元 n 是 RTP 流中传输顺序的第 n 个NAL 单元。

如果对于承载 HEVC 比特流的所有 RTP 流，sprop-max-don-diff 等于 0，则推导 NAL 单元 n 的 AbsDon 值 `AbsDon[n]` 等于 n。

否则(对于任何 RTP 流，sprop-max-don-diff大于0)，`AbsDon[n]` 的推导如下，其中 `DON[n]` 是 NAL 单元 n 的变量 DON 的值:

- 如果 n 等于 0(即 NAL 单元 n 是传输顺序的第一个 NAL 单元)，则设置 `AbsDon[0]` 等于 `DON[0]`。
- 否则(n 大于 0)，以下适用于 `AbsDon[n]`  的推导:

```txt
如果 DON[n] == DON[n-1], AbsDon[n] = AbsDon[n-1]

如果 (DON[n] > DON[n-1] 且 DON[n] - DON[n-1] < 32768), AbsDon[n] = AbsDon[n-1] + DON[n] - DON[n-1]

如果 (DON[n] < DON[n-1] 且 DON[n-1] - DON[n] >= 32768), AbsDon[n] = AbsDon[n-1] + 65536 - DON[n-1] + DON[n]
  
如果 (DON[n] > DON[n-1] 且 DON[n] - DON[n-1] >= 32768), AbsDon[n] = AbsDon[n-1] - (DON[n-1] + 65536 - DON[n])

如果 (DON[n] < DON[n-1] 且 DON[n-1] - DON[n] < 32768), AbsDon[n] = AbsDon[n-1] - (DON[n-1] - DON[n])
```

对于任意两个 NAL 单元 m 和 n，以下各项适用:

- `AbsDon[n] > AbsDon[m]` 表示按照 NAL 单元解码顺序，NAL 单元 n 在 NAL 单元 m 之后。
- `AbsDon[n] = AbsDon[m]` 表示两个 NAL 单元的 NAL 单元解码顺序可以是任意顺序。
- `AbsDon[n] < AbsDon[m]` 表示按照 NAL 单元解码顺序，NAL 单元 n 在 NAL 单元 m 之前。

  信息说明: 当 NAL 单元解码顺序中的两个连续 NAL 单元具有不同的 AbsDon 值时，两个 AbsDon 值之间的绝对差值可能大于或等于 1。

  信息说明: 有多种原因允许 NAL 单元解码顺序中两个连续 NAL 单元的 AbsDon 值的绝对差值大于 1。不要求增加 1，因为在将 AbsDon 值与 NAL 单元相关联时，可能不知道是否所有 NAL 单元都要分发给接收者。例如，当网络中存在拥塞时，网关可能不转发更高子层的 VCL NAL 单元或某些 SEI NAL 单元。在另一示例中，预先发送预编码片段的第一个帧内编码图像以确保其在接收者中随时可用，并且在发送第一个帧内编码图像时，发起者不能确切知道在预编码片段的第一个帧内编码图像按照解码顺序跟随之前将编码多少 NAL 单元。因此，当传输预编码片段的第一个帧内编码图像的 NAL 单元时，必须估计其 AbsDon 值，并且 AbsDon 值可能出现间隔。另一个示例是 sprop-max-don-diff 大于 0 的 MRST 或 MRMT，其中 AbsDon 值必须指示所有 RTP 流中传输的 NAL 单元的跨层解码顺序。

## 5 打包规则

以下打包规则适用:

- 如果任何 RTP 流的 sprop-max-don-diff 大于 0，则 RTP 流中携带的 NAL 单元的传输顺序**可能**不同于 NAL 单元解码顺序和 NAL 单元输出顺序。否则(对于所有 RTP 流，sprop-max-don-diff 等于 0)，RTP 流中携带的 NAL 单元的传输顺序**必须**与 NAL 单元解码顺序相同，并且当 tx-mode 等于“MRST”或“MRMT”时，也**必须**与 NAL 单元输出顺序相同。
- 小尺寸的 NAL 单元**应该**与一个或多个其他 NAL 单元一起封装在聚合包中，以避免小 NAL 单元不必要的打包开销。例如，非 VCL NAL 单元(如访问单元定界符、参数集或 SEI NAL 单元)通常很小，并且通常可以与 VCL NAL 单元聚合而不违反 MTU 大小约束。
- 在可能的情况下，从 MTU 大小匹配的角度来看，每个非 VCL NAL 单元**应该**与其关联的 VCL NAL 单元一起封装在聚包中，因为如果关联的 VCL NAL 单元不可用，通常非 VCL NAL 单元将毫无意义。
- 为了在 RTP 数据包中只携带一个 NAL 单元，**必须**使用单 NAL 单元数据包。

## 6 解包过程

解包背后的一般概念是从 RTP 流的 RTP 包和 RTP 流所依赖的所有 RTP 流(如果有)中获取 NAL 单元，并按照 NAL 单元解码顺序将它们传递给解码器。

解包过程取决于实现。因此，以下描述应视为合适实现的示例。对于相同输入，只要输出与下面描述的过程相同，也可以使用其他方案。当输出 NAL 单元集及其顺序都相同时，输出是相同的。相对于所描述算法的优化是可能的。

所有与缓冲区管理相关的正常 RTP 机制都适用。特别是，重复或过期的 RTP 包(通过 RTP 序列号和 RTP 时间戳指示)被删除。为了确定解码的确切时间，必须考虑诸如可能的故意延迟之类的因素以允许正确的流间同步。

NAL 单元类型值在 0 到 47(包括 0 和 47)范围内的 NAL 单元可以传递给解码器。NAL 单元类型值在 48 到 63(包括 48 和 63)范围内的类 NAL 单元结构**不能**传递给解码器。

接收者包含接收者缓冲区以补偿单个 RTP 流内和跨 RTP 流的传输延迟抖动，将 NAL 单元从传输顺序重新排序为 NAL 单元解码顺序，并在适用时恢复 MRST 或 MRMT 中的 NAL 单元解码顺序。在本节中，接收者操作是在没有 RTP 流内和跨 RTP 流传输延迟抖动的假设下描述的。为了将此接收者缓冲区与也用来补偿传输延迟抖动的实际接收者缓冲区区分开来，本节中接收者缓冲区在下文被称为解交织缓冲区。接收者还应为传输延迟抖动做准备；也就是说，或者为传输延迟抖动缓冲和解交织缓冲保留单独的缓冲区，或者将接收者缓冲区同时用于传输延迟抖动和解交织。此外，接收者应该在缓冲操作中考虑传输延迟抖动，例如，在开始解码和点播之前通过额外的初始缓冲。

当所有接收到的 RTP 流的 sprop-max-don-diff 等于 0 时，解交织缓冲区大小为零字节，并且本段剩余部分描述的过程适用。当仅接收到一个 RTP 流时，单个 RTP 流中携带的 NAL 单元以其传输顺序直接传递给解码器，这与它们的解码顺序相同。当接收到多个 RTP 流时，多个 RTP 流中携带的 NAL 单元以其 NTP 时间戳顺序传递给解码器。当不同 RTP 流存在具有相同 NTP 时间戳的的多个 NAL 单元时，将它们传递给解码器的顺序是它们的依赖顺序，其中被依赖 RTP 流的 NAL 单元在依赖 RTP 流的 NAL 单元之前传递给解码器。当相同 RTP 流具有相同 NTP 时间戳的的多个 NAL 单元时，将它们传递给解码器的顺序是它们的传输顺序。

  信息说明: RTP 和 NTP 时间戳之间的映射在 RTCP SR 数据包中传输。此外，[^RFC6051]中讨论的更快的媒体时间戳同步机制可用于加快获取 RTP 到墙壁时钟的映射。

对于任何接收到的 RTP 流，当 sprop-max-don-diff 大于 0 时，本节剩余部分描述的过程适用。

接收者有两个缓冲状态：初始缓冲和播放时缓冲。初始缓冲发生接收初始化时。在初始缓冲之后，开始解码和点播，然后使用播放时缓冲模式。

无论何种缓冲状态，接收者按照接收顺序将传入的 NAL 单元存储在解交织缓冲区中。RTP 数据包中携带的 NAL 单元分别存储在解交织缓冲区中。为每个 NAL 单元计算 AbsDon 值并保存该值。当使用 MRST 或 MRMT 时，一个比特流的所有 RTP 流的 NAL 单元存储在同一解交织缓冲区中。当任意两个 RTP 流中携带的 NAL 单元可放入解交织缓冲区时，首先将依赖关系树中较低的 RTP 流中携带的 NAL 单元放入缓冲区。例如，如果 RTP 流 A 依赖 RTP 流 B，则 RTP 流 B 携带的 NAL 单元首先被放入缓冲区。

初始缓冲持续到条件 A(解交织缓冲区中 NAL 单元的最大和最小 AbsDon 值之间的差值大于或等于最高 RTP 流的 sprop-max-don-diff 值)或条件 B(解交织缓冲区中的 NAL 单元数大于 sprop-depack-buf-nalus 值)为真。

初始缓冲后，每当条件 A 或条件 B 为真时，重复执行以下操作，直到条件 A 和条件 B 都变为假

- 从解交织缓冲区中将具有最小值 AbsDon 的 NAL 单元移除并传递给解码器。

当没有更多的 NAL 单元流入解交织缓冲区时，从解交织缓冲区中将剩余的所有 NAL 单元移除，并按照 AbsDon 值增加的顺序传递给解码器。

## 7 载荷格式参数

本节规定了**可能**使用的参数，用于选择载荷格式的可选特性以及比特流或 RTP 流的某些特性或属性。此处指定的参数是 HEVC 编解码器的媒体类型注册的一部分。也为使用 SDP 的应用提供了参数到会话描述协议(SDP) [^RFC4566] 的映射。对于不使用 SDP 的控制协议，也可在别处定义等效参数。

### 7.1 媒体类型注册

### 7.2 SDP 参数

#### 7.2.1 载荷类型参数到 SDP 的映射

#### 7.2.2 与 SDP Offer/Answer 模型一起使用

#### 7.2.3 声明性会话描述中使用

#### 7.2.4 参数集考虑

#### 7.2.5 多流模式下的依赖信令

## 8 与反馈消息一起使用

### 8.1 图像丢失指示(PLI)

### 8.2 切片丢失指示(SLI)

### 8.3 参考图像选择指示(RPSI)

### 8.4 完整的内部请求(FIR)

## 9 安全考虑

## 10 拥塞控制

## 11 IANA 考虑

## 12 参考

### 12.1 规范性引用

### 12.2 信息参考

## 致谢

## 作者地址

