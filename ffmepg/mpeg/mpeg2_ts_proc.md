# MPEG2-TS 处理流程

- [MPEG2-TS 处理流程](#mpeg2-ts-处理流程)
  - [TS 介绍](#ts-介绍)
  - [TS 封装与解封装](#ts-封装与解封装)
  - [TS 包解析流程](#ts-包解析流程)
  - [参考](#参考)

## TS 介绍

一路 TS 比特流通常由连续的固定字节的 TS 包组成，所包含的内容有：

- 一路或多路视频流(多个 PES 包组成，每个 PES 包的 PID 是一致的，一个 PES 包可能由若干个 TS 包组成)
- 一路或多路音频流(通常为杜比的音频格式)
- 一路或多路字幕
- PSI 表格信息(包括 PAT 与 PMT 表)
- PES，一路基本码流(如 MEPG2 视频流)会在编码器端被打包成 PES 流，由多个 PES 包组成，打包的过程中主要加入了 PTS/DTS 信息

TS 包的载荷可以包含 PAT 包、PMT 包、多个音频包、多个视频包、多个 PCR 包、以及其他信息包。其中音视频的 ES 需要被打包成为 PES，而辅助数据不需要被打包成 PES。

PAT 描述有多少路节目，每路节目的 PMT 表的 PID；PMT 则描述了本节目有多少流，每一路流的类型与 PID。比如找到一个 PID 是 0 的 TS 包，说明载荷是 PAT 信息。解析 PAT ，发现节目 1 的 PMT 的 PID 是 0x10，接着，在比特流中寻找 PID 为 0x10 的 TS 包，载荷是节目 1 的 PMT 信息。解析该 PMT，可以发现第一路流是 MPEG2 音频流，PID 是 0x21，第二路流是 MPEG2 视频流，PID 是 0x22，第三路流是 DVB 字幕流，PID 是 0x23，解析完毕。所有比特流中 PID 为 0x22 的 TS 包载荷为 MPEG2 视频流，把这些包找出来，把其中的有效码流拼接起来，然后送给解码器解码。

注意，就一般视频流而言，只要拼接成一个完整的 PES 包，就可以送出去给解码器，再继续拼接下一个 PES 包。

- ES 流：有三种，图像数据流，音频数据流，以及其他编码数据流。
- PES 流：PES 流是 ES 流经过 PES 打包器处理后形成的数据流，在这个过程中完成了将 ES 流分组、打包、加入包头信息等操作(对 ES 流的第一次打包)。PES 流的基本单位是 PES 包。
- TS 流：由定长的 TS 包组成( 188 字节)，而 TS 包是对 PES 包的一个重新封装(到这里，ES 经过了两层的封装)。其基本单位是 TS 包，长度固定 188 字节。日本的 DVB-S 广播系统采用 192 个字节的 TS 包，美国采用 204 个字节的 TS 包，多加了 16 个字节的前向纠错校验码(FEC)。

## TS 封装与解封装

TS 封装：

1. 将原始音视频数据压缩之后，组成一个基本码流(ES);
2. 对 ES 打包形成 PES;
3. 在 PES 包中加入时间戳信息(PTS/DTS);
4. 将 PES 包内容分配到一系列固定长度的传输包(TS 包)中;
5. 在传输包中加入定时信息(PCR);
6. 在传输包中加入节目专用信息(PSI);
7. 连续输出传输包形成具有固定码率的 MPEG-TS 流。

TS 解封装：

1. 从复用的 MPEG-TS 流中解析出 TS 包；
2. 从 TS 包中获取 PAT 及对应的 PMT；
3. 从而获取特定节目的音视频 PID；
4. 通过 PID 筛选出特定音视频相关的 TS 包，并解析出 PES；
5. 从 PES 中读取到 PTS/DTS，并从 PES 中解析出 ES；
6. 将 ES 交给解码器，获得压缩前的原始音视频数据。

每个 TS 包前 4 个字节的包头里都有一个 PID

1. 遍历 TS 包，找到 PID 为 0 的 TS 包，这个包叫 PAT，包含了 PMT 的 PID 号。
2. 遍历 TS 包找到 PMT 包，其中包含了视频 TS 包的 PID 及其 codec、音频 TS 包的 PID 及其 codec。
3. 视频和音频都是以 PES 的形式组织的。一帧视频就是一个 PES 包。一个 PES 包分配在连续的几个 TS 包中，如果要获得一帧数据，需要把连续几个 TS 包里的数据取出来组成一个 PES。
4. 遍历 TS 包，寻找包头里载荷单元开始指示位为 1 的包，代表着是一个 PES 的开始。从这开始，一直到下一个载荷单元开始指示位为 1，这中间的 TS 包组成起来就是一个 PES。

## TS 包解析流程

解析 TS 流数据的流程：

1. 查找 PID 为 0x0 的包，解析 PAT，PAT 包中的 program_map_PID 表示 PMT 的 PID。
2. 查找 PMT，PMT 包中的 elementary_PID 表示音视频包的 PID，PMT 包中的 PCR_PID 表示 PCR 的 PID。
3. 有时 PCR 的 PID 跟音频或视频的 PID 相同，说明 PCR 会融进音视频的包。有的时候 PCR 是单独的包。
4. CAT、NIT、SDT、EIT 的 PID 分别为: 0x01、0x10、0x11、0x12。

## 参考

- [MPEG-TS 格式解析](https://blog.csdn.net/Kayson12345/article/details/81266587)
