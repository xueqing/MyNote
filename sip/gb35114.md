# 研读 GB35114

- [研读 GB35114](#%E7%A0%94%E8%AF%BB-gb35114)
  - [前端设备分级](#%E5%89%8D%E7%AB%AF%E8%AE%BE%E5%A4%87%E5%88%86%E7%BA%A7)
  - [视频监控安全管理平台](#%E8%A7%86%E9%A2%91%E7%9B%91%E6%8E%A7%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0)
  - [设备接入认证](#%E8%AE%BE%E5%A4%87%E6%8E%A5%E5%85%A5%E8%AE%A4%E8%AF%81)
  - [信令](#%E4%BF%A1%E4%BB%A4)
  - [运算](#%E8%BF%90%E7%AE%97)
    - [密钥种类](#%E5%AF%86%E9%92%A5%E7%A7%8D%E7%B1%BB)
    - [数字证书类型](#%E6%95%B0%E5%AD%97%E8%AF%81%E4%B9%A6%E7%B1%BB%E5%9E%8B)
    - [SIP 服务器认证 FDWSF 的单向身份认证](#sip-%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AE%A4%E8%AF%81-fdwsf-%E7%9A%84%E5%8D%95%E5%90%91%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81)
    - [SIP 服务器与 FDWSF 的双向身份认证](#sip-%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E-fdwsf-%E7%9A%84%E5%8F%8C%E5%90%91%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81)
    - [管理平台间认证(网关 1 向网关 2 发起认证)](#%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0%E9%97%B4%E8%AE%A4%E8%AF%81%E7%BD%91%E5%85%B3-1-%E5%90%91%E7%BD%91%E5%85%B3-2-%E5%8F%91%E8%B5%B7%E8%AE%A4%E8%AF%81)
    - [控制信令认证](#%E6%8E%A7%E5%88%B6%E4%BF%A1%E4%BB%A4%E8%AE%A4%E8%AF%81)

## 前端设备分级

- FDWSF(具有安全功能的前端设备) 的安全能力分为三个等级

| 能力 | 目标 | 关联标准 | 加密算法 | A 级 | B 级 | C 级 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 基于数字证书与管理平台双向身份认证能力 | 身份真实 | GBT/28181 (SVAC) | SM2, SM3 | Y | Y | Y |
| 对视频数据签名的能力 | 视频真实(来源真实, 内容真实, 未被篡改) | GBT/25724 (SVAC) | SM2, SM3 | N | Y | Y |
| 视频内容加密 | 防止泄露 | GBT/25724 (SVAC) | SM1/SM4, SM3 | N | N | Y |

## 视频监控安全管理平台

- 对 FDWSF 的基本信息、属性信息以及 FDWSF 的 ID、其密码模块 ID 与设备证书的对应关系作管理
- 对所有接入的 FDWSF 进行单向或双向设备身份认证
- 平台互联互通时应进行管理平台间的双向身份认证

## 设备接入认证

- 平台需要:
  - 解析 FDWSF 支持的算法
  - 生成随机数的算法
  - 校验签名的时效性
  - 获取 FDWSF 的公钥
  - 获取管理平台的私钥
  - 可设置 Date 比对有效时间范围

## 信令

- 除注册信令, 其他信令作摘要
- 增加设备控制请求: 前端签名控制、前端加密控制, 都是有应答的请求
- 增加通知信令: FDWSF 的 VKEK 改变时, SIP 服务器通知媒体流接收者新的 VKEK 密文和版本号
- 第三方呼叫控制中, 媒体流接收者需要在 Invite 请求中添加 Monitor-User-Identity 表明用户身份
- 在 Invite 的回复中, SIP 服务器在 SDP 中添加媒体流发送者的的 VKEK 密文和版本号
- 导出加密视频: 解密视频数据, 生成新的 VEK 进行加密, 保存 VETK 和播放权限到安全芯片

## 运算

- 算法包括非对称算法、对称算法、杂凑算法和随机数生成算法
- 参考[算法在国标中的应用](./sip_algorithm.md)

| 分类 | 算法 | 国标应用 | 长度 |
| --- | --- | --- | --- |
| 非对称密码算法 | SM2 椭圆曲线密码算法 | 用于用户身份认证、数字签名、密钥协商 | 公钥至少 256 位 |
| 对称密码算法 | SM1、SM4 分组密码算法 OFB 模式 | 用于视频数据的加密保护 | |
| - | SM4 分组密码算法 ECB 模式 | 用于密钥协商数据的加密保护 | |
| 密码杂凑算法 | SM3 密码杂凑算法 | 用于完整性校验 | |
| 随机数生成算法 | | 生成随机数，**应能通过 GM/T 0005-2012 中规定的方法进行检测** | |

### 密钥种类

- 具有安全功能的前端设备、用户终端、中心信令控制服务器、路由网关、媒体服务器都持有各自的: 非对称密钥和对称密钥
  - 非对称密钥
    - 管理平台内功能实体的签名公私钥和加密公私钥
    - FDWSF 的签名公私钥
    - 具有安全功能的用户终端签名公私钥
  - 对称密钥：视频加密密钥、视频密钥加密密钥

### 数字证书类型

- 基于非对称密码算法
- 包括用户证书、前端设备证书、服务器设备证书和管理平台证书
- 支持 GM/T 0015-2012 基于 SM2 密码算法的数字证书格式规范

### SIP 服务器认证 FDWSF 的单向身份认证

- FDWSF 收到 401, 发送请求: 使用 FDWSF 的私钥对 (R2 + R1 + SIP_Server_ID) 做签名运算
  - R2: FDWSF 产生的随机数
  - R1: 第一次 register, SIP 服务器在 401 返回的随机数
  - SIP_Server_ID: SIP 服务器的设备 ID
  - 签名: SM2 椭圆曲线密码算法
- 管理平台回复:
  - 使用 FDWSF 证书校验签名, 使用 FDWSF 公钥解密, 验证各个参数
  - 使用 FDWSF 的公钥对 VKEK 加密经 Base64 编码后得到 crypt_key
    - 加密: SM4 分组密码算法 ECB 模式

### SIP 服务器与 FDWSF 的双向身份认证

- FDWSF 收到 401, 请求: 同上
- 管理平台回复:同上
  - 用管理平台私钥对 (R1 + R2 + device_id + crypt_key) 做签名运算
    - R1: 第一次 register, SIP 服务器在 401 返回的随机数
    - R2: FDWSF 产生的随机数
    - device_id: FDWSF 的 ID
    - 签名: SM2 椭圆曲线密码算法
- FDWSF 收到管理平台 200 回复
  - 用 SIP 服务器证书校验签名, 使用管理平台公钥解密, 验证各个参数
  - 用 FDWSF 私钥解密 crypt_key, 获得 VKEK 的值

### 管理平台间认证(网关 1 向网关 2 发起认证)

- 网关 1 收到 401, 发送请求: 使用网关 1 的私钥对 (R2 + R1 + 网关_2_ID) 做签名运算
  - R2: 网关 1 产生的随机数
  - R1: 第一次 register, 网关 2 在 401 返回的随机数
  - 网关_2_ID: 网关 2 的 ID
  - 签名: SM2 椭圆曲线密码算法
- 网关 2 回复:
  - 使用网关 1 的公钥对 VKEK 加密经 Base64 编码后得到 crypt_key_1
  - 使用网关 1 的公钥对 VEMK 和 VEMK 版本号加密经 Base64 编码后得到 crypt_key_2
    - 加密: SM4 分组密码算法 ECB 模式
  - 用网关 2 私钥对 (R1 + R2 + 网关_1_ID + crypt_key_1 + crypt_key_2) 做签名运算
    - R1: 第一次 register, 网关 2 在 401 返回的随机数
    - R2: 网关 1 产生的随机数
    - 网关_1_ID: 网关 1 的 ID
    - 签名: SM2 椭圆曲线密码算法
- 网关 1 收到 200 回复
  - 用网关 2 证书校验签名, 使用网关 2 公钥解密, 验证各个参数
  - 用网关 1 私钥解密 crypt_key_1, 获得 VKEK 的值
  - 用网关 1 私钥解密 crypt_key_2, 获得 VEMK 和 VEMK 版本号

### 控制信令认证

- 对注册信令以外的消息作带密钥的杂凑
- 发起消息之前计算 nonce
  - 对 (METHOD + From + To + CallID + Date + VKEK + 消息体) 做杂凑运算经 Base64 编码得到的值
- 收到消息之后计算并校验摘要
  - 对 (METHOD + From + To + CallID + Date + VKEK + 消息体) 做杂凑运算经 Base64 编码得到的值
  - 对比收到的 nonce 和计算的结果